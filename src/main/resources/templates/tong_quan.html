<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard Quản trị Hệ thống Toàn diện - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .stat-card {
            @apply bg-white dark:bg-white/5 p-6 rounded-2xl border border-[#f0f4f2] dark:border-white/10 shadow-sm hover:shadow-md transition-all;
        }
        .chart-container {
            @apply bg-white dark:bg-white/5 p-6 rounded-2xl border border-[#f0f4f2] dark:border-white/10;
        }
        .quick-list-card {
            @apply bg-white dark:bg-white/5 rounded-2xl border border-[#f0f4f2] dark:border-white/10 overflow-hidden flex flex-col;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#111813] dark:text-white antialiased">
    <div class="flex h-screen overflow-hidden">
        <div th:replace="~{fragments/admin-sidebar :: sidebar}"></div>
        <main class="flex-1 lg:ml-72 flex flex-col overflow-y-auto bg-background-light dark:bg-background-dark">
            <header
                class="sticky top-0 z-10 flex items-center justify-between bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-[#f0f4f2] dark:border-white/10 px-8 py-4">
                <div class="flex flex-1 items-center gap-4">
                    <h2 class="text-xl font-bold">Tổng quan Hệ thống</h2>
                </div>
            </header>
            <section class="px-8 pt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div class="stat-card border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600">
                            <span class="material-symbols-outlined">group</span>
                        </div>
                        <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded" id="userGrowthBadge">-</span>
                    </div>
                    <p class="text-[#61896f] text-xs font-bold uppercase tracking-wider mb-1">Tổng người dùng</p>
                    <h3 class="text-2xl font-black mb-2" id="totalUsers">0</h3>
                    <div class="flex flex-wrap gap-2" id="userBreakdown">
                        <span class="text-[10px] px-2 py-0.5 bg-gray-100 dark:bg-white/5 rounded-full">Khách: 0</span>
                        <span class="text-[10px] px-2 py-0.5 bg-gray-100 dark:bg-white/5 rounded-full">BS: 0</span>
                    </div>
                </div>
                <div class="stat-card border-l-4 border-purple-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-purple-600">
                            <span class="material-symbols-outlined">event_available</span>
                        </div>
                        <span class="text-[10px] font-bold text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded"
                            id="todayAppointmentsBadge">Hôm nay: 0</span>
                    </div>
                    <p class="text-[#61896f] text-xs font-bold uppercase tracking-wider mb-1">Tổng lịch hẹn</p>
                    <h3 class="text-2xl font-black mb-2" id="totalAppointments">0</h3>
                    <p class="text-[10px] text-[#61896f]" id="appointmentGrowthText">-</p>
                </div>
                <div class="stat-card border-l-4 border-primary">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-primary/10 rounded-lg text-primary">
                            <span class="material-symbols-outlined">vaccines</span>
                        </div>
                        <span class="text-[10px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded">Đã
                            tiêm</span>
                    </div>
                    <p class="text-[#61896f] text-xs font-bold uppercase tracking-wider mb-1">Vaccine đã tiêm</p>
                    <h3 class="text-2xl font-black mb-2" id="totalVaccinations">0</h3>
                    <p class="text-[10px] text-[#61896f]">Tổng số mũi tiêm</p>
                </div>
                <div class="stat-card border-l-4 border-amber-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-amber-50 dark:bg-amber-900/20 rounded-lg text-amber-600">
                            <span class="material-symbols-outlined">payments</span>
                        </div>
                        <span class="text-[10px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded">Tăng
                            trưởng</span>
                    </div>
                    <p class="text-[#61896f] text-xs font-bold uppercase tracking-wider mb-1">Doanh thu (VNĐ)</p>
                    <h3 class="text-2xl font-black mb-2" id="monthlyRevenue">0</h3>
                    <p class="text-[10px] text-[#61896f]">Tháng hiện tại</p>
                </div>
                <div class="stat-card border-l-4 border-rose-500">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2 bg-rose-50 dark:bg-rose-900/20 rounded-lg text-rose-600">
                            <span class="material-symbols-outlined">location_on</span>
                        </div>
                    </div>
                    <p class="text-[#61896f] text-xs font-bold uppercase tracking-wider mb-1">Trung tâm hoạt động</p>
                    <h3 class="text-2xl font-black mb-2" id="totalCenters">0</h3>
                    <p class="text-[10px] text-[#61896f]" id="activeCentersText">-</p>
                </div>
            </section>
            <section class="px-8 pt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="chart-container lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-sm font-bold uppercase tracking-wider text-[#61896f]">So sánh Lịch hẹn &amp;
                            Doanh thu (30 ngày)</h4>
                        <div class="flex gap-4">
                            <div class="flex items-center gap-1.5">
                                <span class="w-3 h-3 rounded-full bg-primary"></span>
                                <span class="text-[10px] font-bold">Lịch hẹn</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                                <span class="text-[10px] font-bold">Doanh thu</span>
                            </div>
                        </div>
                    </div>
                    <div class="h-[300px] w-full relative flex items-end justify-between px-2 pt-4"
                        id="trendChartContainer">
                        <div class="absolute inset-0 flex flex-col justify-between py-4 pointer-events-none opacity-10">
                            <div class="border-t border-black dark:border-white"></div>
                            <div class="border-t border-black dark:border-white"></div>
                            <div class="border-t border-black dark:border-white"></div>
                            <div class="border-t border-black dark:border-white"></div>
                        </div>
                        <div class="w-full flex items-end justify-around h-full gap-2 z-0" id="trendChartBars">
                            <!-- Chart bars will be rendered here -->
                        </div>
                    </div>
                    <div class="flex justify-between mt-4 text-[10px] text-[#61896f] font-bold px-2"
                        id="trendChartLabels">
                        <!-- Chart labels will be rendered here -->
                    </div>
                </div>
                <div class="chart-container">
                    <h4 class="text-sm font-bold uppercase tracking-wider text-[#61896f] mb-6">Vaccine Phổ biến Nhất
                    </h4>
                    <div class="relative w-48 h-48 mx-auto mb-8" id="popularVaccinesChart">
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-2xl font-black" id="popularVaccinesTotal">0</span>
                            <span class="text-[10px] text-[#61896f] font-bold">Dữ liệu thực</span>
                        </div>
                    </div>
                    <div class="space-y-3" id="popularVaccinesLegend">
                        <!-- Vaccine legend will be rendered here -->
                    </div>
                </div>
            </section>
            <section class="px-8 py-8">
                <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">analytics</span>
                    Thông báo &amp; Danh sách nhanh
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="quick-list-card">
                        <div
                            class="px-4 py-3 bg-gray-50 dark:bg-white/5 border-b border-[#f0f4f2] dark:border-white/10 flex justify-between items-center">
                            <h5 class="text-xs font-bold uppercase tracking-widest">Lịch hẹn gần đây</h5>
                            <button class="text-[10px] text-primary font-bold hover:underline">Xem tất cả</button>
                        </div>
                        <div class="p-0 divide-y divide-[#f0f4f2] dark:divide-white/10" id="recentAppointmentsList">
                            <!-- Recent appointments will be loaded here -->
                        </div>
                    </div>
                    <div class="quick-list-card">
                        <div
                            class="px-4 py-3 bg-gray-50 dark:bg-white/5 border-b border-[#f0f4f2] dark:border-white/10 flex justify-between items-center">
                            <h5 class="text-xs font-bold uppercase tracking-widest">Người dùng mới</h5>
                            <button class="text-[10px] text-primary font-bold hover:underline">Quản lý</button>
                        </div>
                        <div class="p-0 divide-y divide-[#f0f4f2] dark:divide-white/10" id="recentUsersList">
                            <!-- Recent users will be loaded here -->
                        </div>
                    </div>
                    <div class="quick-list-card">
                        <div
                            class="px-4 py-3 bg-red-50 dark:bg-red-900/10 border-b border-red-100 dark:border-white/10 flex justify-between items-center">
                            <h5 class="text-xs font-bold uppercase tracking-widest text-red-600">Cảnh báo tồn kho</h5>
                            <span class="material-symbols-outlined text-red-600 text-sm">warning</span>
                        </div>
                        <div class="p-0 divide-y divide-[#f0f4f2] dark:divide-white/10" id="inventoryAlertsList">
                            <!-- Inventory alerts will be loaded here -->
                        </div>
                        <div
                            class="mt-auto p-3 bg-gray-50 dark:bg-white/5 border-t border-[#f0f4f2] dark:border-white/10">
                            <button
                                class="w-full py-2 bg-red-500 hover:bg-red-600 text-white text-[10px] font-black rounded uppercase transition-colors">Đặt
                                hàng ngay</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script th:inline="javascript">
            /*<![CDATA[*/
            (function () {
                // Set current date
                const today = new Date();
                const dateStr = today.toLocaleDateString('vi-VN');

                // Load dashboard stats
                async function loadDashboardStats() {
                    try {
                        const response = await fetch('/api/admin/dashboard/stats', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load stats');
                        const stats = await response.json();

                        // Update total users
                        if (stats.totalUsers !== undefined) {
                            const totalUsersEl = document.getElementById('totalUsers');
                            if (totalUsersEl) {
                                totalUsersEl.textContent = stats.totalUsers.toLocaleString('vi-VN');
                            }
                            // Update breakdown
                            const breakdownEl = document.getElementById('userBreakdown');
                            if (breakdownEl && stats.totalCustomers !== undefined && stats.totalDoctors !== undefined) {
                                breakdownEl.innerHTML = `
                                <span class="text-[10px] px-2 py-0.5 bg-gray-100 dark:bg-white/5 rounded-full">Khách: ${stats.totalCustomers}</span>
                                <span class="text-[10px] px-2 py-0.5 bg-gray-100 dark:bg-white/5 rounded-full">BS: ${stats.totalDoctors}</span>
                            `;
                            }
                        }

                        // Update total appointments
                        if (stats.totalAppointments !== undefined) {
                            const totalAppointmentsEl = document.getElementById('totalAppointments');
                            if (totalAppointmentsEl) {
                                totalAppointmentsEl.textContent = stats.totalAppointments.toLocaleString('vi-VN');
                            }
                        }

                        // Update today appointments
                        if (stats.todayAppointments !== undefined) {
                            const todayBadge = document.getElementById('todayAppointmentsBadge');
                            if (todayBadge) {
                                todayBadge.textContent = `Hôm nay: ${stats.todayAppointments}`;
                            }
                        }

                        // Update total centers
                        if (stats.totalCenters !== undefined) {
                            const totalCentersEl = document.getElementById('totalCenters');
                            if (totalCentersEl) {
                                totalCentersEl.textContent = stats.totalCenters;
                            }
                        }
                        
                        // Update user growth badge
                        if (stats.userGrowthPercent !== undefined) {
                            const userGrowthBadge = document.getElementById('userGrowthBadge');
                            if (userGrowthBadge) {
                                const growth = stats.userGrowthPercent;
                                if (growth > 0) {
                                    userGrowthBadge.textContent = `+${growth.toFixed(1)}%`;
                                    userGrowthBadge.className = 'text-[10px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded';
                                } else if (growth < 0) {
                                    userGrowthBadge.textContent = `${growth.toFixed(1)}%`;
                                    userGrowthBadge.className = 'text-[10px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded';
                                } else {
                                    userGrowthBadge.textContent = '0%';
                                    userGrowthBadge.className = 'text-[10px] font-bold text-gray-600 bg-gray-50 px-1.5 py-0.5 rounded';
                                }
                            }
                        }
                        
                        // Update appointment growth text
                        if (stats.appointmentGrowthPercent !== undefined) {
                            const appointmentGrowthText = document.getElementById('appointmentGrowthText');
                            if (appointmentGrowthText) {
                                const growth = stats.appointmentGrowthPercent;
                                if (growth > 0) {
                                    appointmentGrowthText.textContent = `Tăng ${growth.toFixed(1)}% so với tháng trước`;
                                    appointmentGrowthText.className = 'text-[10px] text-green-600';
                                } else if (growth < 0) {
                                    appointmentGrowthText.textContent = `Giảm ${Math.abs(growth).toFixed(1)}% so với tháng trước`;
                                    appointmentGrowthText.className = 'text-[10px] text-red-600';
                                } else {
                                    appointmentGrowthText.textContent = 'Không thay đổi so với tháng trước';
                                    appointmentGrowthText.className = 'text-[10px] text-[#61896f]';
                                }
                            }
                        }
                        
                        // Update active centers text
                        if (stats.activeCenters !== undefined && stats.totalCenters !== undefined) {
                            const activeCentersText = document.getElementById('activeCentersText');
                            if (activeCentersText) {
                                activeCentersText.textContent = `${stats.activeCenters} trung tâm đang hoạt động`;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading dashboard stats:', error);
                    }
                }

                // Load detailed stats
                async function loadDetailedStats() {
                    try {
                        const response = await fetch('/api/dashboard/stats', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load detailed stats');
                        const stats = await response.json();

                        // Update vaccination records
                        if (stats.injections && stats.injections.totalCount !== undefined) {
                            const vaccinationEl = document.getElementById('totalVaccinations');
                            if (vaccinationEl) {
                                vaccinationEl.textContent = stats.injections.totalCount.toLocaleString('vi-VN');
                            }
                        }

                        // Update revenue
                        if (stats.revenue && stats.revenue.monthly !== undefined) {
                            const revenueEl = document.getElementById('monthlyRevenue');
                            if (revenueEl) {
                                const revenue = parseFloat(stats.revenue.monthly);
                                if (revenue >= 1000000000) {
                                    revenueEl.textContent = (revenue / 1000000000).toFixed(2) + 'B';
                                } else if (revenue >= 1000000) {
                                    revenueEl.textContent = (revenue / 1000000).toFixed(2) + 'M';
                                } else {
                                    revenueEl.textContent = revenue.toLocaleString('vi-VN');
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error loading detailed stats:', error);
                    }
                }

                // Load appointments & revenue trend
                async function loadTrend() {
                    try {
                        const response = await fetch('/api/admin/dashboard/appointments-revenue-trend?days=30', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load trend');
                        const trend = await response.json();

                        renderTrendChart(trend);
                    } catch (error) {
                        console.error('Error loading trend:', error);
                    }
                }

                // Render trend chart
                function renderTrendChart(trend) {
                    const barsContainer = document.getElementById('trendChartBars');
                    const labelsContainer = document.getElementById('trendChartLabels');

                    if (!trend || trend.length === 0 || !barsContainer || !labelsContainer) {
                        if (barsContainer) barsContainer.innerHTML = '<div class="flex items-center justify-center h-full text-[#61896f]">Không có dữ liệu</div>';
                        return;
                    }

                    // Tính max values để scale
                    const maxAppointments = Math.max(...trend.map(t => t.appointments || 0), 1);
                    const maxRevenue = trend.map(t => parseFloat(t.revenue || 0)).reduce((a, b) => Math.max(a, b), 0);

                    // Sample data points (mỗi 3 ngày một điểm)
                    const sampleSize = 10;
                    const step = Math.max(1, Math.floor(trend.length / sampleSize));
                    const sampledTrend = [];
                    for (let i = 0; i < trend.length; i += step) {
                        sampledTrend.push(trend[i]);
                    }
                    if (sampledTrend.length < trend.length) {
                        sampledTrend.push(trend[trend.length - 1]);
                    }

                    let barsHtml = '';
                    let labelsHtml = '';

                    sampledTrend.forEach((day, index) => {
                        const appointmentHeight = ((day.appointments || 0) / maxAppointments) * 100;
                        const revenueHeight = maxRevenue > 0 ? (parseFloat(day.revenue || 0) / maxRevenue) * 100 : 0;
                        const revenueOffset = Math.max(0, appointmentHeight - revenueHeight);

                        barsHtml += `
                        <div class="flex flex-col items-center gap-1" style="flex: 1;">
                            <div class="w-full flex flex-col items-center relative" style="height: 100%;">
                                <div class="w-1 bg-primary rounded-t-full relative" style="height: ${appointmentHeight}%;">
                                    <div class="absolute -top-1 left-0 w-1 h-1 bg-blue-500 rounded-full" style="transform: translateY(-${revenueOffset}px);"></div>
                                </div>
                            </div>
                        </div>
                    `;

                        if (index % Math.ceil(sampledTrend.length / 5) === 0 || index === sampledTrend.length - 1) {
                            const date = new Date(day.date);
                            const dayLabel = date.getDate();
                            const monthLabel = date.toLocaleDateString('vi-VN', { month: 'short' });
                            labelsHtml += `<span>${dayLabel} ${monthLabel}</span>`;
                        }
                    });

                    barsContainer.innerHTML = barsHtml;
                    labelsContainer.innerHTML = labelsHtml;
                }

                // Load popular vaccines
                async function loadPopularVaccines() {
                    try {
                        const response = await fetch('/api/admin/dashboard/popular-vaccines?limit=4', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load popular vaccines');
                        const data = await response.json();

                        const vaccines = data.vaccines || [];
                        const total = data.total || 0;

                        document.getElementById('popularVaccinesTotal').textContent = total > 0 ? total : '0';

                        // Render donut chart
                        const chartContainer = document.getElementById('popularVaccinesChart');
                        if (!chartContainer) return;
                        
                        // Lọc vaccine có dữ liệu
                        const vaccinesWithData = vaccines.filter(v => (v.percentage || 0) > 0);
                        
                        if (vaccinesWithData.length === 0) {
                            chartContainer.innerHTML = `
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-2xl font-black">0</span>
                                    <span class="text-[10px] text-[#61896f] font-bold">Chưa có dữ liệu</span>
                                </div>
                            `;
                            return;
                        }

                        // Tính tổng phần trăm và đảm bảo tổng = 100%
                        let totalPercentage = vaccinesWithData.reduce((sum, v) => sum + (v.percentage || 0), 0);
                        
                        // Điều chỉnh vaccine cuối cùng để tổng = 100%
                        if (Math.abs(totalPercentage - 100) > 0.01 && vaccinesWithData.length > 0) {
                            const lastVaccine = vaccinesWithData[vaccinesWithData.length - 1];
                            const otherPercentage = totalPercentage - (lastVaccine.percentage || 0);
                            lastVaccine.percentage = Math.max(0, 100 - otherPercentage);
                        }

                        const colors = ['#13ec5b', '#3b82f6', '#f59e0b', '#9ca3af'];
                        
                        // Tính circumference cho SVG circle
                        // Với r="44%" trong viewBox="0 0 200 200", radius = 88
                        // circumference = 2 * PI * 88 ≈ 553
                        const radius = 88; // 44% của 200
                        const circumference = 2 * Math.PI * radius;

                        // Render các segment
                        let svgCircles = '';
                        let currentOffset = 0;
                        
                        vaccinesWithData.forEach((vaccine, index) => {
                            const percentage = vaccine.percentage || 0;
                            const arcLength = (percentage / 100) * circumference;
                            const color = colors[index % colors.length];

                            // stroke-dasharray: arcLength là độ dài segment, circumference là tổng
                            // stroke-dashoffset: đặt segment ở vị trí đúng (bắt đầu từ currentOffset)
                            svgCircles += `
                            <circle cx="100" cy="100" fill="transparent" r="${radius}" 
                                stroke="${color}" 
                                stroke-dasharray="${arcLength} ${circumference}" 
                                stroke-dashoffset="${currentOffset}" 
                                stroke-linecap="round" 
                                stroke-width="16">
                            </circle>
                        `;
                            
                            // Cập nhật offset cho segment tiếp theo
                            currentOffset -= arcLength;
                        });

                        chartContainer.innerHTML = `
                        <svg class="absolute inset-0 size-full -rotate-90" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
                            ${svgCircles}
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-2xl font-black">${total > 0 ? total : '0'}</span>
                            <span class="text-[10px] text-[#61896f] font-bold">Dữ liệu thực</span>
                        </div>
                    `;

                        // Render legend
                        const legendContainer = document.getElementById('popularVaccinesLegend');
                        if (legendContainer) {
                            const colors = ['bg-primary', 'bg-blue-500', 'bg-amber-500', 'bg-gray-300'];
                            legendContainer.innerHTML = vaccines.map((vaccine, index) => {
                                const color = colors[index % colors.length];
                                return `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 rounded ${color}"></span>
                                        <span class="text-xs font-semibold">${vaccine.name || 'N/A'}</span>
                                    </div>
                                    <span class="text-xs font-bold">${vaccine.percentage || 0}%</span>
                                </div>
                            `;
                            }).join('');
                        }
                    } catch (error) {
                        console.error('Error loading popular vaccines:', error);
                    }
                }

                // Load recent appointments
                async function loadRecentAppointments() {
                    try {
                        const response = await fetch('/api/admin/dashboard/recent-appointments?limit=3', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load recent appointments');
                        const appointments = await response.json();

                        const container = document.getElementById('recentAppointmentsList');
                        if (!container) return;

                        if (appointments.length === 0) {
                            container.innerHTML = '<div class="p-3 text-center text-[#61896f] text-xs">Không có lịch hẹn</div>';
                            return;
                        }

                        const colorClasses = ['bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600',
                            'bg-teal-100 dark:bg-teal-900/30 text-teal-600',
                            'bg-orange-100 dark:bg-orange-900/30 text-orange-600',
                            'bg-purple-100 dark:bg-purple-900/30 text-purple-600',
                            'bg-pink-100 dark:bg-pink-900/30 text-pink-600'];

                        container.innerHTML = appointments.map((apt, index) => {
                            const patientName = apt.patientInfo?.fullName || 'N/A';
                            const initials = patientName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                            const colorClass = colorClasses[index % colorClasses.length];
                            const date = apt.appointmentDate ? new Date(apt.appointmentDate).toLocaleDateString('vi-VN') : 'N/A';
                            const time = apt.appointmentTime || '';
                            const centerName = apt.centerName || 'N/A';
                            const isToday = apt.appointmentDate === new Date().toISOString().split('T')[0];
                            const isTomorrow = apt.appointmentDate === new Date(Date.now() + 86400000).toISOString().split('T')[0];
                            const statusBadge = isToday ? 'Mới' : isTomorrow ? 'Sắp tới' : '';
                            const statusColor = isToday ? 'bg-blue-100 text-blue-700' : isTomorrow ? 'bg-amber-100 text-amber-700' : '';
                            const dateTimeText = isToday ? `Hôm nay, ${time} - ${centerName}` :
                                isTomorrow ? `Ngày mai, ${time} - ${centerName}` :
                                    `${date}, ${time} - ${centerName}`;

                            return `
                            <div class="p-3 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                                <div class="w-10 h-10 rounded-full ${colorClass} flex items-center justify-center font-bold text-xs shrink-0">
                                    ${initials}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold truncate">${patientName}</p>
                                    <p class="text-[10px] text-[#61896f]">${dateTimeText}</p>
                                </div>
                                ${statusBadge ? `<span class="px-2 py-0.5 rounded-full ${statusColor} text-[9px] font-bold">${statusBadge}</span>` : ''}
                            </div>
                        `;
                        }).join('');
                    } catch (error) {
                        console.error('Error loading recent appointments:', error);
                    }
                }

                // Load recent users
                async function loadRecentUsers() {
                    try {
                        const response = await fetch('/api/admin/dashboard/recent-users?limit=3', {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load recent users');
                        const users = await response.json();

                        const container = document.getElementById('recentUsersList');
                        if (!container) return;

                        if (users.length === 0) {
                            container.innerHTML = '<div class="p-3 text-center text-[#61896f] text-xs">Không có người dùng mới</div>';
                            return;
                        }

                        container.innerHTML = users.map(user => {
                            const fullName = user.fullName || 'N/A';
                            const address = user.address || 'N/A';
                            const createdAt = user.createAt ? formatTimeAgo(new Date(user.createAt)) : 'N/A';

                            return `
                            <div class="p-3 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-white/10 overflow-hidden shrink-0 flex items-center justify-center">
                                    <span class="text-xs font-bold text-gray-600 dark:text-gray-400">
                                        ${fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                                    </span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold truncate">${fullName}</p>
                                    <p class="text-[10px] text-[#61896f]">${address}</p>
                                </div>
                                <p class="text-[9px] text-[#61896f] font-medium italic">${createdAt}</p>
                            </div>
                        `;
                        }).join('');
                    } catch (error) {
                        console.error('Error loading recent users:', error);
                    }
                }

                // Load inventory alerts
                async function loadInventoryAlerts() {
                    try {
                        const response = await fetch('/api/admin/dashboard/inventory-alerts?limit=3', {
                            credentials: 'include'
                        });
                        if (!response.ok) {
                            console.error('Failed to load inventory alerts:', response.status, response.statusText);
                            const container = document.getElementById('inventoryAlertsList');
                            if (container) {
                                container.innerHTML = '<div class="p-3 text-center text-red-500 text-xs">Lỗi khi tải cảnh báo</div>';
                            }
                            return;
                        }
                        
                        const alerts = await response.json();
                        const container = document.getElementById('inventoryAlertsList');
                        if (!container) {
                            console.error('Container inventoryAlertsList not found');
                            return;
                        }

                        if (!alerts || alerts.length === 0) {
                            container.innerHTML = '<div class="p-3 text-center text-[#61896f] text-xs">Không có cảnh báo</div>';
                            return;
                        }

                        container.innerHTML = alerts.map(alert => {
                            const isOutOfStock = alert.status === 'OUT_OF_STOCK';
                            const bgColor = isOutOfStock ? 'bg-red-100 dark:bg-red-900/30' : 'bg-amber-100 dark:bg-amber-900/30';
                            const textColor = isOutOfStock ? 'text-red-600' : 'text-amber-600';
                            const statusText = isOutOfStock ? 'HẾT HÀNG' : 'Sắp hết hàng';
                            const statusTextColor = isOutOfStock ? 'text-red-500' : 'text-amber-600';
                            const stockQuantity = alert.stockQuantity || 0;
                            const hoverClass = isOutOfStock ? 'hover:bg-red-50/30' : 'hover:bg-amber-50/30';

                            return `
                            <div class="p-3 flex items-center gap-3 ${hoverClass} transition-colors">
                                <div class="${bgColor} p-1.5 rounded-lg ${textColor} shrink-0">
                                    <span class="material-symbols-outlined text-sm">inventory_2</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-xs font-bold truncate">${alert.vaccineName || 'N/A'}</p>
                                    <p class="text-[10px] ${statusTextColor} font-bold uppercase">${statusText}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-black ${textColor}">${stockQuantity}</p>
                                    <p class="text-[9px] text-[#61896f]">Liều</p>
                                </div>
                            </div>
                        `;
                        }).join('');
                    } catch (error) {
                        console.error('Error loading inventory alerts:', error);
                        const container = document.getElementById('inventoryAlertsList');
                        if (container) {
                            container.innerHTML = '<div class="p-3 text-center text-red-500 text-xs">Lỗi khi tải cảnh báo</div>';
                        }
                    }
                }

                function formatTimeAgo(date) {
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);

                    if (diffMins < 1) return 'Vừa xong';
                    if (diffMins < 60) return `${diffMins} phút trước`;
                    if (diffHours < 24) return `${diffHours} giờ trước`;
                    if (diffDays === 1) return 'Hôm qua';
                    if (diffDays < 7) return `${diffDays} ngày trước`;
                    return date.toLocaleDateString('vi-VN');
                }

                document.addEventListener('DOMContentLoaded', function () {
                    loadDashboardStats();
                    loadDetailedStats();
                    loadTrend();
                    loadPopularVaccines();
                    loadRecentAppointments();
                    loadRecentUsers();
                    loadInventoryAlerts();
                });
            })();
        /*]]>*/
    </script>
</body>

</html>