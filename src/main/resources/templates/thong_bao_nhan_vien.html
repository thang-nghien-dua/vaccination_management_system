<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Thông báo của tôi - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="/js/sidebar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .fill-icon {
            font-variation-settings: 'FILL' 1;
        }

        .tab-active {
            border-bottom: 3px solid #13ec5b;
            color: #111813;
        }

        .tab-inactive {
            border-bottom: 3px solid transparent;
            color: #61896f;
        }

        .tab-inactive:hover {
            color: #111813;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white">
    <div class="flex min-h-screen">
        <!-- Sidebar Overlay (mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>
        
        <!-- Sidebar Navigation - Load based on user role -->
        <th:block
            th:with="roleName=${forcedRole != null ? forcedRole : (currentUser != null and currentUser.role != null ? currentUser.role.name() : 'CUSTOMER')}">
            <div th:if="${roleName == 'ADMIN'}" th:replace="~{fragments/admin-sidebar :: sidebar}"></div>
            <div th:if="${roleName == 'DOCTOR'}" th:replace="~{fragments/doctor-sidebar :: sidebar}"></div>
            <div th:if="${roleName == 'NURSE'}" th:replace="~{fragments/nurse-sidebar :: sidebar}"></div>
            <div th:if="${roleName == 'RECEPTIONIST'}" th:replace="~{fragments/receptionist-sidebar :: sidebar}"></div>
            <div th:if="${roleName == 'CUSTOMER' or (roleName != 'ADMIN' and roleName != 'DOCTOR' and roleName != 'NURSE' and roleName != 'RECEPTIONIST')}"
                th:replace="~{fragments/customer-sidebar :: sidebar}"></div>
        </th:block>

        <!-- Main Content Area -->
        <main class="flex-1 lg:ml-72 flex flex-col overflow-hidden">
            <!-- Page Heading -->
            <header class="bg-white dark:bg-[#1a2e20] border-b border-[#dbe6df] dark:border-[#2a3f31] px-8 py-6">
                <div class="max-w-5xl mx-auto flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-[#111813] dark:text-white text-3xl font-extrabold tracking-tight">Thông báo của
                            tôi</h2>
                        <p id="unreadCountText" class="text-[#61896f] text-sm mt-1">Đang tải...</p>
                    </div>
                    <button id="markAllReadBtn" onclick="markAllAsRead()"
                        class="flex items-center gap-2 px-5 py-2.5 bg-background-light dark:bg-background-dark hover:bg-[#e2e8e4] dark:hover:bg-[#1a2e20] text-[#111813] dark:text-white text-sm font-bold rounded-xl transition-all border border-[#dbe6df] dark:border-[#2a3f31]">
                        <span class="material-symbols-outlined text-lg">done_all</span>
                        <span>Đánh dấu tất cả đã đọc</span>
                    </button>
                </div>
            </header>
            <!-- Filter Tabs -->
            <section class="bg-white dark:bg-[#1a2e20] px-8 border-b border-[#dbe6df] dark:border-[#2a3f31]">
                <div class="max-w-5xl mx-auto flex gap-8">
                    <button onclick="switchFilter('all')" id="filter-all"
                        class="tab-active flex flex-col items-center justify-center pb-4 pt-4 cursor-pointer">
                        <p class="text-sm font-bold tracking-wide">Tất cả</p>
                    </button>
                    <button onclick="switchFilter('unread')" id="filter-unread"
                        class="tab-inactive flex flex-col items-center justify-center pb-4 pt-4 cursor-pointer transition-colors">
                        <p class="text-sm font-bold tracking-wide">Chưa đọc</p>
                    </button>
                    <button onclick="switchFilter('appointment')" id="filter-appointment"
                        class="tab-inactive flex flex-col items-center justify-center pb-4 pt-4 cursor-pointer transition-colors">
                        <p class="text-sm font-bold tracking-wide">Nhắc lịch hẹn</p>
                    </button>
                    <button onclick="switchFilter('system')" id="filter-system"
                        class="tab-inactive flex flex-col items-center justify-center pb-4 pt-4 cursor-pointer transition-colors">
                        <p class="text-sm font-bold tracking-wide">Hệ thống</p>
                    </button>
                </div>
            </section>
            <!-- Notifications List -->
            <section class="flex-1 overflow-y-auto px-8 py-6">
                <div id="notificationsContainer" class="max-w-5xl mx-auto flex flex-col gap-3">
                    <div class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <span
                                class="material-symbols-outlined text-6xl text-[#61896f] mb-4 animate-spin">refresh</span>
                            <p class="text-[#61896f]">Đang tải thông báo...</p>
                        </div>
                    </div>
                </div>
                <!-- Footer Info -->
                <div id="loadMoreContainer" class="max-w-5xl mx-auto mt-8 pb-10 flex justify-center hidden">
                    <button onclick="loadMore()"
                        class="text-[#61896f] text-sm font-bold hover:text-primary transition-colors flex items-center gap-2">
                        <span>Xem thêm các thông báo cũ hơn</span>
                        <span class="material-symbols-outlined">expand_more</span>
                    </button>
                </div>
            </section>
        </main>
    </div>
    <script>
        let currentFilter = 'all';
        let allNotifications = [];
        let displayedNotifications = [];
        let isLoading = false;

        // Format thời gian
        function formatTime(dateString) {
            if (!dateString) return 'Không xác định';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays === 1) return 'Hôm qua';
            if (diffDays < 7) return `${diffDays} ngày trước`;
            return date.toLocaleDateString('vi-VN');
        }

        // Lấy icon theo type và appointment
        function getNotificationIcon(notification) {
            if (notification.appointment) {
                return 'event_upcoming';
            }
            if (notification.type === 'SYSTEM' || notification.title.toLowerCase().includes('hệ thống')) {
                return 'settings';
            }
            if (notification.title.toLowerCase().includes('vaccine') || notification.title.toLowerCase().includes('tiêm')) {
                return 'vaccines';
            }
            if (notification.title.toLowerCase().includes('cập nhật') || notification.title.toLowerCase().includes('hồ sơ')) {
                return 'info';
            }
            return 'notifications';
        }

        // Lấy màu icon
        function getNotificationIconColor(notification) {
            if (notification.appointment) {
                return 'text-primary';
            }
            if (notification.title.toLowerCase().includes('cập nhật') || notification.title.toLowerCase().includes('hồ sơ')) {
                return 'text-[#eab308]';
            }
            if (notification.title.toLowerCase().includes('vaccine') || notification.title.toLowerCase().includes('thông tin')) {
                return 'text-[#3b82f6]';
            }
            return 'text-[#61896f]';
        }

        // Lấy màu background icon
        function getNotificationIconBg(notification) {
            if (notification.appointment) {
                return 'bg-primary/10';
            }
            if (notification.title.toLowerCase().includes('cập nhật') || notification.title.toLowerCase().includes('hồ sơ')) {
                return 'bg-yellow-500/10';
            }
            if (notification.title.toLowerCase().includes('vaccine') || notification.title.toLowerCase().includes('thông tin')) {
                return 'bg-blue-500/10';
            }
            return 'bg-background-light dark:bg-background-dark';
        }

        // Render notification card
        function renderNotification(notification) {
            const isUnread = !notification.isRead;
            const icon = getNotificationIcon(notification);
            const iconColor = getNotificationIconColor(notification);
            const iconBg = getNotificationIconBg(notification);

            return `
        <div class="group flex gap-5 ${isUnread ? 'bg-white dark:bg-[#1a2e20]' : 'bg-white/60 dark:bg-[#1a2e20]/60'} p-5 rounded-2xl border border-[#dbe6df] dark:border-[#2a3f31] ${isUnread ? 'hover:border-primary/50 shadow-sm hover:shadow-md' : 'opacity-80 hover:opacity-100'} transition-all cursor-pointer" onclick="viewNotificationDetail(${notification.id})">
            <div class="${iconColor} flex items-center justify-center rounded-xl ${iconBg} shrink-0 size-14">
                <span class="material-symbols-outlined text-2xl">${icon}</span>
            </div>
            <div class="flex flex-1 flex-col">
                <div class="flex justify-between items-start mb-1">
                    <h3 class="text-[#111813] dark:text-white text-base font-bold leading-tight">${escapeHtml(notification.title)}</h3>
                    <div class="flex items-center gap-3">
                        <span class="text-[#61896f] text-xs font-medium">${formatTime(notification.createdAt || notification.sentAt)}</span>
                        ${isUnread ? '<div class="size-2.5 rounded-full bg-primary shadow-[0_0_8px_rgba(19,236,91,0.6)]"></div>' : ''}
                    </div>
                </div>
                <p class="text-[#61896f] text-sm leading-relaxed max-w-2xl">${escapeHtml(notification.content.length > 100 ? notification.content.substring(0, 100) + '...' : notification.content)}</p>
                ${notification.appointment ? `
                    <div class="mt-2 text-xs text-primary flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">event</span>
                        <span>Có lịch hẹn</span>
                    </div>
                ` : ''}
            </div>
            <button onclick="event.stopPropagation(); deleteNotification(${notification.id})" class="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 p-1.5 rounded-lg transition-all">
                <span class="material-symbols-outlined text-base">delete</span>
            </button>
        </div>
    `;
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load notifications
        async function loadNotifications(filter = 'all') {
            if (isLoading) return;
            isLoading = true;

            const container = document.getElementById('notificationsContainer');
            container.innerHTML = `
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <span class="material-symbols-outlined text-6xl text-[#61896f] mb-4 animate-spin">refresh</span>
                <p class="text-[#61896f]">Đang tải thông báo...</p>
            </div>
        </div>
    `;

            try {
                const response = await fetch(`/api/notifications?filter=${filter}`);
                const data = await response.json();

                if (response.ok && Array.isArray(data)) {
                    allNotifications = data;
                    displayedNotifications = data;
                    renderNotifications();
                } else {
                    container.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-6xl text-[#61896f] mb-4">error</span>
                        <p class="text-[#61896f]">${data.error || 'Không thể tải thông báo'}</p>
                    </div>
                </div>
            `;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                container.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="text-center">
                    <span class="material-symbols-outlined text-6xl text-[#61896f] mb-4">error</span>
                    <p class="text-[#61896f]">Lỗi khi tải thông báo</p>
                </div>
            </div>
        `;
            } finally {
                isLoading = false;
            }
        }

        // Render notifications
        function renderNotifications() {
            const container = document.getElementById('notificationsContainer');

            if (displayedNotifications.length === 0) {
                container.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="text-center">
                    <span class="material-symbols-outlined text-6xl text-[#61896f] mb-4">notifications_none</span>
                    <p class="text-[#61896f] text-lg font-semibold">Không có thông báo nào</p>
                    <p class="text-[#61896f] text-sm mt-2">Bạn sẽ nhận được thông báo khi có cập nhật mới</p>
                </div>
            </div>
        `;
                return;
            }

            container.innerHTML = displayedNotifications.map(notification => renderNotification(notification)).join('');
        }

        // Switch filter
        function switchFilter(filter) {
            currentFilter = filter;

            // Update tab styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`filter-${filter}`).classList.remove('tab-inactive');
            document.getElementById(`filter-${filter}`).classList.add('tab-active');

            loadNotifications(filter);
        }

        // View notification detail
        function viewNotificationDetail(id) {
            const urlParams = new URLSearchParams(window.location.search);
            const role = urlParams.get('role');
            let url = `/notifications/${id}`;
            if (role) {
                url += `?role=${role}`;
            }
            window.location.href = url;
        }

        // Delete notification
        async function deleteNotification(id) {
            if (!confirm('Bạn có chắc muốn xóa thông báo này?')) return;

            try {
                const response = await fetch(`/api/notifications/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    allNotifications = allNotifications.filter(n => n.id !== id);
                    displayedNotifications = displayedNotifications.filter(n => n.id !== id);
                    renderNotifications();
                    updateUnreadCount();
                } else {
                    const data = await response.json();
                    alert('Lỗi: ' + (data.error || 'Không thể xóa thông báo'));
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                alert('Lỗi khi xóa thông báo');
            }
        }

        // Mark all as read
        async function markAllAsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'PUT'
                });

                if (response.ok) {
                    // Reload notifications
                    loadNotifications(currentFilter);
                    updateUnreadCount();
                } else {
                    const data = await response.json();
                    alert('Lỗi: ' + (data.error || 'Không thể đánh dấu đã đọc'));
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
                alert('Lỗi khi đánh dấu đã đọc');
            }
        }

        // Update unread count
        async function updateUnreadCount() {
            try {
                const response = await fetch('/api/notifications/unread-count');
                const data = await response.json();

                if (response.ok && data.count !== undefined) {
                    const count = data.count;
                    const unreadText = document.getElementById('unreadCountText');
                    if (count === 0) {
                        unreadText.textContent = 'Bạn không có thông báo mới';
                    } else {
                        unreadText.textContent = `Bạn có ${count} thông báo mới chưa đọc`;
                    }
                }
            } catch (error) {
                console.error('Error updating unread count:', error);
            }
        }

        // Load more (placeholder for pagination)
        function loadMore() {
            // TODO: Implement pagination if needed
            alert('Chức năng phân trang đang được phát triển');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadNotifications('all');
            updateUnreadCount();
        });
    </script>
</body>

</html>