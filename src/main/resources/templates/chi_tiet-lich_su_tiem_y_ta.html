<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chi tiết Hồ sơ Tiêm chủng Tổng hợp</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#0f766e", // Teal to match nurse theme
                        "primary-light": "#14b8a6",
                        "primary-dark": "#134e4a",
                        "background-light": "#F8FAFC",
                        "background-dark": "#0F172A",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Nurse theme active nav styles */
        .active-nav {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
            border-left: 4px solid #0f766e;
            color: #0f766e;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200">
    <div class="flex min-h-screen">
        <!-- Sidebar Fragment -->
        <div th:replace="~{fragments/nurse-sidebar :: sidebar}"></div>
        <!-- Main Content Area -->
        <main class="flex-1 lg:ml-72">
            <header
                class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-30 px-6 lg:px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-extrabold">Chi tiết Hồ sơ Tiêm chủng</h2>
                        <p id="recordIdDisplay" class="text-slate-500 dark:text-slate-400 mt-1">Mã hồ sơ: Đang tải...
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button
                            class="flex items-center gap-2 px-4 py-2 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                            <span class="material-icons-round text-sm">print</span>
                            <span>In hồ sơ</span>
                        </button>
                        <button
                            class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:opacity-90 transition-opacity">
                            <span class="material-icons-round text-sm">edit</span>
                            <span>Chỉnh sửa</span>
                        </button>
                    </div>
                </div>
            </header>
            <div class="p-6 lg:px-8 py-8">
                <nav aria-label="Breadcrumb" class="flex text-sm text-slate-500 dark:text-slate-400 mb-4">
                    <ol class="flex items-center space-x-2">
                        <li><a class="hover:text-primary transition-colors" th:href="@{/nurse/dashboard}">Trang chủ</a>
                        </li>
                        <li><span class="material-icons-round text-xs">chevron_right</span></li>
                        <li><a class="hover:text-primary transition-colors" th:href="@{/nurse/lich-su-tiem-y-ta}">Lịch
                                sử tiêm chủng</a></li>
                        <li><span class="material-icons-round text-xs">chevron_right</span></li>
                        <li class="text-primary font-medium">Chi tiết hồ sơ</li>
                    </ol>
                </nav>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <section class="lg:col-span-1 space-y-6">
                        <div
                            class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="bg-primary/10 p-2 rounded-lg">
                                    <span class="material-icons-round text-primary">person</span>
                                </div>
                                <h3 class="text-lg font-semibold">Thông tin bệnh nhân</h3>
                            </div>
                            <div class="flex flex-col items-center mb-6">
                                <div
                                    class="w-24 h-24 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-3">
                                    <span class="material-icons-round text-slate-400 text-5xl">account_circle</span>
                                </div>
                                <h4 class="text-xl font-bold text-slate-900 dark:text-white">NGUYỄN VĂN A</h4>
                                <span
                                    class="text-sm text-slate-500 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full mt-2">BN-908234</span>
                            </div>
                            <div class="space-y-4">
                                <div
                                    class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-800">
                                    <span class="text-slate-500 dark:text-slate-400">Ngày sinh</span>
                                    <span class="font-medium">12/05/1990</span>
                                </div>
                                <div
                                    class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-800">
                                    <span class="text-slate-500 dark:text-slate-400">Giới tính</span>
                                    <span class="font-medium">Nam</span>
                                </div>
                                <div
                                    class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-800">
                                    <span class="text-slate-500 dark:text-slate-400">Số điện thoại</span>
                                    <span class="font-medium">090 123 4567</span>
                                </div>
                                <div class="flex justify-between items-center py-2">
                                    <span class="text-slate-500 dark:text-slate-400">Địa chỉ</span>
                                    <span class="font-medium text-right max-w-[150px]">Quận 1, TP. Hồ Chí Minh</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-emerald-50 dark:bg-emerald-950/20 border border-emerald-100 dark:border-emerald-900/50 p-6 rounded-2xl">
                            <div class="flex items-center gap-2 text-emerald-700 dark:text-emerald-400 font-bold mb-2">
                                <span class="material-icons-round">verified</span>
                                <span>Trạng thái hồ sơ</span>
                            </div>
                            <p class="text-sm text-emerald-600 dark:text-emerald-500">Đã hoàn thành tiêm chủng và theo
                                dõi 30 phút. Bệnh nhân sức khỏe ổn định.</p>
                        </div>
                    </section>
                    <div class="lg:col-span-2 space-y-6">
                        <section
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                                <div class="flex items-center gap-3">
                                    <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                        <span class="material-icons-round">medical_services</span>
                                    </div>
                                    <h3 class="text-lg font-semibold">Kết quả khám sàng lọc</h3>
                                </div>
                                <div
                                    class="flex items-center gap-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider">
                                    <span class="material-icons-round text-base">check_circle</span>
                                    <span>Đủ điều kiện</span>
                                </div>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-400 uppercase">Nhiệt độ</label>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-2xl font-bold">36.5</span>
                                        <span class="text-slate-500">°C</span>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-400 uppercase">Huyết áp</label>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-2xl font-bold">120/80</span>
                                        <span class="text-slate-500">mmHg</span>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-xs font-bold text-slate-400 uppercase">Nhịp tim</label>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-2xl font-bold">75</span>
                                        <span class="text-slate-500">lần/phút</span>
                                    </div>
                                </div>
                                <div class="md:col-span-3 space-y-2 mt-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase">Ghi chú khám</label>
                                    <div
                                        class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl text-slate-700 dark:text-slate-300 italic">
                                        "Bệnh nhân không có tiền sử dị ứng với các thành phần của vaccine. Sức khỏe hiện
                                        tại tốt, không sốt, không có triệu chứng viêm đường hô hấp."
                                    </div>
                                </div>
                                <div
                                    class="md:col-span-3 flex items-center justify-between pt-4 border-t border-slate-100 dark:border-slate-800">
                                    <div class="flex items-center gap-3">
                                        <img alt="Bác sĩ" class="w-10 h-10 rounded-full object-cover grayscale"
                                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDa8UvmlCPAogx1xk4WKnsrS3acOVlRtGypIk5uuF2W2vp6SvvIHBiXWAz3Ja5WQNtZL5_8WIS2vR_GLehsL5Ptd3wrhV5Fc2okPfyLzJP180OIqjte4flghvXaWQ4VClN30_raAaM-aVpRIThga0xOFdlNmGEd7vXXy4qpjK4SRfc9yyg8Ocjll9IUX5wOjDWgc8L4pJQH_0Bsn8DBrszlRnU3NUJCOuBDubGTk1AMqDYhSr8U5T7KLzJn7zu6eNisHEbuljRsRZEl" />
                                        <div>
                                            <p class="text-sm font-bold">BS. Lê Minh Quang</p>
                                            <p class="text-xs text-slate-500">Khoa Khám bệnh</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-slate-400">Ngày khám</p>
                                        <p class="text-sm font-medium">15/10/2023 - 08:30</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                            <div
                                class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                                <div class="flex items-center gap-3">
                                    <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                        <span class="material-icons-round">science</span>
                                    </div>
                                    <h3 class="text-lg font-semibold">Thông tin thực hiện tiêm</h3>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Tên
                                                Vaccine</label>
                                            <div class="flex items-center gap-2 text-lg font-bold text-primary">
                                                <span class="material-icons-round text-xl">inventory_2</span>
                                                Vero Cell (Sinopharm)
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Số lô
                                                (Batch No.)</label>
                                            <p class="font-semibold text-slate-700 dark:text-slate-300">202108B1249</p>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Vị trí
                                                tiêm</label>
                                            <p class="font-semibold text-slate-700 dark:text-slate-300">Bắp tay trái</p>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Mũi
                                                tiêm thứ</label>
                                            <div
                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold">
                                                2
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Ghi chú
                                                phản ứng sau tiêm</label>
                                            <p class="text-slate-700 dark:text-slate-300">Không có phản ứng bất thường.
                                                Bệnh nhân được theo dõi 30p tại chỗ.</p>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="flex items-center justify-between pt-6 border-t border-slate-100 dark:border-slate-800">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                                            <span class="material-icons-round">person_outline</span>
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold">Điều dưỡng. Nguyễn Thu Hà</p>
                                            <p class="text-xs text-slate-500">Phòng tiêm số 04</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-slate-400">Thời gian tiêm</p>
                                        <p class="text-sm font-medium">15/10/2023 - 09:15</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section
                            class="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                            <h3 class="text-lg font-semibold mb-4">Lộ trình quy trình</h3>
                            <div class="flex items-center gap-2 overflow-x-auto pb-2">
                                <div class="flex items-center shrink-0">
                                    <div
                                        class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white">
                                        <span class="material-icons-round text-sm">check</span>
                                    </div>
                                    <div class="ml-2 mr-4">
                                        <p class="text-xs font-bold">Đăng ký</p>
                                        <p class="text-[10px] text-slate-500">08:05</p>
                                    </div>
                                </div>
                                <div class="h-px w-8 bg-emerald-500"></div>
                                <div class="flex items-center shrink-0">
                                    <div
                                        class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white">
                                        <span class="material-icons-round text-sm">check</span>
                                    </div>
                                    <div class="ml-2 mr-4">
                                        <p class="text-xs font-bold">Khám sàng lọc</p>
                                        <p class="text-[10px] text-slate-500">08:30</p>
                                    </div>
                                </div>
                                <div class="h-px w-8 bg-emerald-500"></div>
                                <div class="flex items-center shrink-0">
                                    <div
                                        class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white">
                                        <span class="material-icons-round text-sm">check</span>
                                    </div>
                                    <div class="ml-2 mr-4">
                                        <p class="text-xs font-bold">Thực hiện tiêm</p>
                                        <p class="text-[10px] text-slate-500">09:15</p>
                                    </div>
                                </div>
                                <div class="h-px w-8 bg-emerald-500"></div>
                                <div class="flex items-center shrink-0">
                                    <div
                                        class="flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500 text-white">
                                        <span class="material-icons-round text-sm">check</span>
                                    </div>
                                    <div class="ml-2">
                                        <p class="text-xs font-bold">Theo dõi &amp; Hoàn tất</p>
                                        <p class="text-[10px] text-slate-500">09:45</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button onclick="window.location.href='/nurse/lich-su-tiem-y-ta'"
                        class="px-6 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                        Quay lại danh sách
                    </button>
                    <button
                        class="px-8 py-2 rounded-lg bg-primary text-white font-semibold shadow-lg shadow-primary/20 hover:opacity-90 transition-opacity">
                        Xuất chứng nhận điện tử
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        (function () {
            const recordId = /*[[${recordId}]]*/ null;

            async function loadRecordDetail() {
                if (!recordId) {
                    alert('Không tìm thấy ID hồ sơ');
                    window.location.href = '/nurse/lich-su-tiem-y-ta';
                    return;
                }

                try {
                    const response = await fetch(`/api/vaccination-records/${recordId}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const record = await response.json();
                    console.log('Record data:', record);

                    // Update patient name from record
                    const patientNameEl = document.querySelector('h4.text-xl.font-bold');
                    if (patientNameEl && record.patientName) {
                        patientNameEl.textContent = record.patientName.toUpperCase();
                    }

                    // Load appointment detail for patient info
                    if (record.appointmentId) {
                        try {
                            const appointmentResponse = await fetch(`/api/appointments/${record.appointmentId}/detail`, {
                                credentials: 'include'
                            });

                            if (appointmentResponse.ok) {
                                const appointment = await appointmentResponse.json();
                                console.log('Appointment data:', appointment);
                                const patientInfo = appointment.patientInfo || {};

                                // Update patient info
                                if (patientInfo.fullName && patientNameEl) {
                                    patientNameEl.textContent = patientInfo.fullName.toUpperCase();
                                }

                                const patientInfoSpans = document.querySelectorAll('.space-y-4 .flex.justify-between span.font-medium');
                                if (patientInfoSpans.length >= 4) {
                                    if (patientInfo.dateOfBirth) patientInfoSpans[0].textContent = patientInfo.dateOfBirth;
                                    if (patientInfo.gender) {
                                        patientInfoSpans[1].textContent = patientInfo.gender === 'MALE' ? 'Nam' : patientInfo.gender === 'FEMALE' ? 'Nữ' : 'Khác';
                                    }
                                    if (patientInfo.phoneNumber) patientInfoSpans[2].textContent = patientInfo.phoneNumber;
                                    if (patientInfo.address) patientInfoSpans[3].textContent = patientInfo.address;
                                }
                            }
                        } catch (appointmentError) {
                            console.warn('Could not load appointment detail:', appointmentError);
                            // Continue with record data only
                        }
                    }

                    // Update vaccination info - vaccine name
                    const vaccineNameContainer = document.querySelector('.flex.items-center.gap-2.text-lg.font-bold.text-primary');
                    if (vaccineNameContainer && record.vaccineName) {
                        const icon = vaccineNameContainer.querySelector('.material-icons-round');
                        if (icon) {
                            // Keep icon, update text
                            const textNodes = Array.from(vaccineNameContainer.childNodes).filter(n => n.nodeType === 3);
                            textNodes.forEach(n => n.remove());
                            vaccineNameContainer.appendChild(document.createTextNode(' ' + record.vaccineName));
                        } else {
                            vaccineNameContainer.textContent = record.vaccineName;
                        }
                    }

                    // Update lot number - find the paragraph after "Số lô (Batch No.)" label
                    const lotLabel = Array.from(document.querySelectorAll('label')).find(el => el.textContent.includes('Số lô'));
                    if (lotLabel && record.lotNumber) {
                        const lotParagraph = lotLabel.nextElementSibling;
                        if (lotParagraph && lotParagraph.tagName === 'P') {
                            lotParagraph.textContent = record.lotNumber;
                        }
                    }

                    // Update injection site - find the paragraph after "Vị trí tiêm" label
                    const siteLabel = Array.from(document.querySelectorAll('label')).find(el => el.textContent.includes('Vị trí tiêm'));
                    if (siteLabel && record.injectionSite) {
                        const siteParagraph = siteLabel.nextElementSibling;
                        if (siteParagraph && siteParagraph.tagName === 'P') {
                            siteParagraph.textContent = getInjectionSiteName(record.injectionSite);
                        }
                    }

                    // Update dose number - find the div with class "w-8 h-8 rounded-full bg-slate-900"
                    const doseNumberEl = document.querySelector('.w-8.h-8.rounded-full.bg-slate-900');
                    if (doseNumberEl && record.doseNumber) {
                        doseNumberEl.textContent = record.doseNumber;
                    }

                    // Update dates
                    if (record.injectionDate) {
                        const date = new Date(record.injectionDate + 'T00:00:00');
                        const dateStr = date.toLocaleDateString('vi-VN');
                        const timeStr = record.injectionTime ? record.injectionTime.substring(0, 5) : '';
                        const timeEls = document.querySelectorAll('.text-right .text-sm.font-medium');
                        if (timeEls.length > 0) {
                            timeEls[timeEls.length - 1].textContent = `${dateStr} - ${timeStr}`;
                        }
                    }

                    // Update nurse name - find the paragraph with "Điều dưỡng" text
                    if (record.nurseName) {
                        const nurseSection = document.querySelector('.flex.items-center.justify-between.pt-6');
                        if (nurseSection) {
                            const nurseNameEl = nurseSection.querySelector('.text-sm.font-bold');
                            if (nurseNameEl) {
                                nurseNameEl.textContent = record.nurseName;
                            }
                        }
                    }

                    // Update record ID
                    const recordIdEl = document.getElementById('recordIdDisplay');
                    if (recordIdEl) {
                        if (record.certificateNumber) {
                            recordIdEl.textContent = `Mã hồ sơ: ${record.certificateNumber}`;
                        } else if (record.bookingCode) {
                            recordIdEl.textContent = `Mã hẹn: ${record.bookingCode}`;
                        } else {
                            recordIdEl.textContent = `Mã hồ sơ: #${record.id}`;
                        }
                    }

                    console.log('Record detail loaded successfully');

                } catch (error) {
                    console.error('Error loading record detail:', error);
                    const errorMessage = error.message || 'Có lỗi xảy ra khi tải chi tiết hồ sơ';
                    alert(errorMessage + '\n\nVui lòng kiểm tra console để xem chi tiết lỗi.');
                    // Don't redirect immediately, let user see the error
                }
            }

            function getInjectionSiteName(site) {
                if (!site) return 'N/A';
                const sites = {
                    'LEFT_ARM': 'Bắp tay trái',
                    'RIGHT_ARM': 'Bắp tay phải',
                    'LEFT_THIGH': 'Đùi trái',
                    'RIGHT_THIGH': 'Đùi phải'
                };
                return sites[site] || site;
            }

            document.addEventListener('DOMContentLoaded', function () {
                loadRecordDetail();
            });
        })();
        /*]]>*/
    </script>

</body>

</html>