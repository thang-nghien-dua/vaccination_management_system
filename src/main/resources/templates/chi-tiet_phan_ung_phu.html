<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chi tiết & Xử lý Phản ứng Phụ</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .filled-icon {
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div th:replace="~{fragments/admin-sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 flex flex-col overflow-y-auto bg-background-light dark:bg-background-dark">
            <div class="flex-1 p-8">
                <!-- Back Button -->
                <button onclick="window.location.href='/admin/adverse-reactions'"
                    class="mb-6 flex items-center gap-2 text-[#61896f] hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>
                    <span class="text-sm font-semibold">Quay lại danh sách</span>
                </button>

                <!-- Content Container -->
                <div class="bg-white dark:bg-zinc-900 rounded-xl shadow-xl overflow-hidden max-w-6xl">
                    <!-- Header -->
                    <div
                        class="border-b border-gray-100 dark:border-zinc-800 px-6 py-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-red-50 dark:bg-red-900/20 flex items-center justify-center">
                                <span class="material-icons text-red-500">report_problem</span>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 dark:text-white leading-tight">Chi tiết & Xử
                                    lý Phản ứng Phụ</h2>
                                <p class="text-xs text-gray-500 dark:text-zinc-400 font-medium uppercase tracking-wider"
                                    id="reactionCode">Mã ca: #RP-...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="p-6 space-y-8" id="contentArea">
                        <div class="text-center py-8">
                            <span class="material-symbols-outlined animate-spin text-primary text-4xl">refresh</span>
                            <p class="mt-4 text-gray-500">Đang tải dữ liệu...</p>
                        </div>
                    </div>

                    <!-- Footer Buttons -->
                    <div
                        class="bg-gray-50 dark:bg-zinc-800/80 px-6 py-4 flex items-center justify-between border-t border-gray-100 dark:border-zinc-800">
                        <div class="flex items-center text-sm text-gray-500 dark:text-zinc-400" id="lastUpdated">
                            <span class="material-icons text-sm mr-1">history</span>
                            Đang tải...
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="window.location.href='/admin/adverse-reactions'"
                                class="px-5 py-2.5 rounded-lg border border-gray-300 dark:border-zinc-600 text-gray-700 dark:text-zinc-200 text-sm font-bold hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                                Quay lại
                            </button>
                            <button id="resolveButton" onclick="resolveReaction()"
                                class="px-5 py-2.5 rounded-lg bg-primary text-black text-sm font-bold hover:bg-primary/90 transition-all flex items-center gap-2 shadow-sm shadow-primary/20">
                                <span class="material-icons text-sm">check_circle</span>
                                Xác nhận Đã xử lý
                            </button>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <script th:inline="javascript">
            /*<![CDATA[*/
            (function () {
                const reactionId = window.location.pathname.split('/').pop();
                let reactionData = null;

                // Load reaction detail
                async function loadReactionDetail() {
                    try {
                        const response = await fetch(`/api/adverse-reactions/${reactionId}`, {
                            credentials: 'include'
                        });
                        if (!response.ok) throw new Error('Failed to load reaction detail');
                        reactionData = await response.json();
                        renderReactionDetail();
                    } catch (error) {
                        console.error('Error loading reaction detail:', error);
                        document.getElementById('contentArea').innerHTML = `
                <div class="text-center py-8">
                    <span class="material-icons text-red-500 text-4xl">error</span>
                    <p class="mt-4 text-red-500">Lỗi khi tải dữ liệu</p>
                    <button onclick="window.location.href='/admin/adverse-reactions'" class="mt-4 px-4 py-2 bg-primary text-black rounded-lg font-bold">Quay lại</button>
                </div>
            `;
                    }
                }

                // Render reaction detail
                function renderReactionDetail() {
                    if (!reactionData) return;

                    const user = reactionData.user || {};
                    const vaccine = reactionData.vaccine || {};
                    const record = reactionData.vaccinationRecord || {};
                    const handler = reactionData.handledBy || {};

                    const reactionTypeColors = {
                        'MILD': { bg: 'bg-green-100 dark:bg-green-500/20', text: 'text-green-600 dark:text-green-400', label: 'Nhẹ' },
                        'MODERATE': { bg: 'bg-orange-100 dark:bg-orange-500/20', text: 'text-orange-600 dark:text-orange-400', label: 'Trung bình' },
                        'SEVERE': { bg: 'bg-red-100 dark:bg-red-500/20', text: 'text-red-600 dark:text-red-400', label: 'Nặng' }
                    };
                    const typeInfo = reactionTypeColors[reactionData.reactionType] || { bg: 'bg-gray-100', text: 'text-gray-600', label: reactionData.reactionType };

                    const occurredAt = reactionData.occurredAt ? new Date(reactionData.occurredAt) : null;
                    const occurredAtStr = occurredAt ? occurredAt.toLocaleString('vi-VN') : 'N/A';
                    const occurredDate = occurredAt ? occurredAt.toLocaleDateString('vi-VN') : 'N/A';
                    const occurredTime = occurredAt ? occurredAt.toLocaleTimeString('vi-VN') : 'N/A';

                    const vaccinationDate = record.vaccinationDate ? new Date(record.vaccinationDate).toLocaleString('vi-VN') : 'N/A';

                    const userDob = user.dateOfBirth ? new Date(user.dateOfBirth) : null;
                    const userAge = userDob ? Math.floor((new Date() - userDob) / (365.25 * 24 * 60 * 60 * 1000)) : null;
                    const userDobStr = userDob ? userDob.toLocaleDateString('vi-VN') + (userAge ? ` (${userAge} tuổi)` : '') : 'N/A';

                    const genderLabels = {
                        'MALE': 'Nam',
                        'FEMALE': 'Nữ',
                        'OTHER': 'Khác'
                    };
                    const genderLabel = genderLabels[user.gender] || user.gender || 'N/A';

                    const isResolved = reactionData.resolved;

                    document.getElementById('reactionCode').textContent = `Mã ca: #RP-${reactionId}`;

                    document.getElementById('contentArea').innerHTML = `
            <!-- Section 1: Information Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Patient Info -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-icons text-primary text-sm">person</span>
                        <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Thông tin bệnh nhân</h3>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-800/50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Họ và tên:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${user.fullName || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Ngày sinh:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${userDobStr}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Giới tính:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${genderLabel}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Số điện thoại:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${user.phoneNumber || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Vaccine Info -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="material-icons text-primary text-sm">vaccines</span>
                        <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Thông tin Vaccine</h3>
                    </div>
                    <div class="bg-gray-50 dark:bg-zinc-800/50 rounded-lg p-4 space-y-3">
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Loại vaccine:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${vaccine.name || 'N/A'} ${vaccine.code ? '(' + vaccine.code + ')' : ''}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Mũi tiêm số:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">Mũi ${record.doseNumber || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-100 dark:border-zinc-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Thời gian tiêm:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${vaccinationDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500 dark:text-zinc-400">Trung tâm:</span>
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">${record.centerName || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: Reaction Details -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="material-icons text-orange-500 text-sm">warning</span>
                        <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Chi tiết triệu chứng</h3>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeInfo.bg} ${typeInfo.text}">
                        ${typeInfo.label}
                    </span>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/10 border-l-4 border-orange-500 p-5 rounded-r-lg">
                    <p class="text-gray-800 dark:text-zinc-200 text-sm leading-relaxed">
                        ${reactionData.symptoms || 'N/A'}
                    </p>
                    <div class="mt-4 flex items-center gap-2 text-xs text-orange-700 dark:text-orange-400 font-medium">
                        <span class="material-icons text-xs">schedule</span>
                        Ghi nhận lúc: ${occurredAtStr}
                    </div>
                </div>
            </div>
            
            ${reactionData.notes ? `
            <!-- Notes Section -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-primary text-sm">note</span>
                    <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Ghi chú</h3>
                </div>
                <div class="bg-gray-50 dark:bg-zinc-800/50 rounded-lg p-4">
                    <p class="text-gray-800 dark:text-zinc-200 text-sm">${reactionData.notes}</p>
                </div>
            </div>
            ` : ''}
            
            ${isResolved && reactionData.treatment ? `
            <!-- Treatment Section -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="material-icons text-green-500 text-sm">medical_services</span>
                    <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Phương pháp điều trị</h3>
                </div>
                <div class="bg-green-50 dark:bg-green-900/10 border-l-4 border-green-500 p-5 rounded-r-lg">
                    <p class="text-gray-800 dark:text-zinc-200 text-sm">${reactionData.treatment}</p>
                    ${handler.fullName ? `
                    <div class="mt-4 flex items-center gap-2 text-xs text-green-700 dark:text-green-400 font-medium">
                        <span class="material-icons text-xs">person</span>
                        Xử lý bởi: ${handler.fullName}
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            ${!isResolved ? `
            <!-- Section 3: Action Form -->
            <div class="space-y-4 border-t border-gray-100 dark:border-zinc-800 pt-6">
                <div class="flex items-center gap-2 mb-2">
                    <span class="material-icons text-primary text-sm">medical_services</span>
                    <h3 class="font-bold text-sm text-gray-800 dark:text-zinc-200 uppercase tracking-wide">Xử lý phản ứng (Dành cho bác sĩ/Admin)</h3>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-300 mb-2" for="treatment">Phương pháp điều trị <span class="text-red-500">*</span></label>
                        <textarea class="w-full rounded-lg border-gray-300 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white focus:ring-primary focus:border-primary text-sm" id="treatment" placeholder="Mô tả các thuốc đã dùng, liều lượng và các bước can thiệp y tế..." rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-zinc-300 mb-2" for="notes">Ghi chú y tế & Theo dõi tiếp theo</label>
                        <textarea class="w-full rounded-lg border-gray-300 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white focus:ring-primary focus:border-primary text-sm" id="notes" placeholder="Các lưu ý đặc biệt cho bệnh nhân sau khi ra về..." rows="2">${reactionData.notes || ''}</textarea>
                    </div>
                </div>
            </div>
            ` : ''}
        `;

                    // Update resolve button visibility
                    const resolveButton = document.getElementById('resolveButton');
                    if (resolveButton) {
                        if (isResolved) {
                            resolveButton.style.display = 'none';
                        } else {
                            resolveButton.style.display = 'flex';
                        }
                    }

                    // Update last updated
                    const lastUpdated = document.getElementById('lastUpdated');
                    if (lastUpdated && occurredAt) {
                        const now = new Date();
                        const diffMs = now - occurredAt;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);

                        let timeStr = '';
                        if (diffDays > 0) {
                            timeStr = `${diffDays} ngày trước`;
                        } else if (diffHours > 0) {
                            timeStr = `${diffHours} giờ trước`;
                        } else if (diffMins > 0) {
                            timeStr = `${diffMins} phút trước`;
                        } else {
                            timeStr = 'Vừa xong';
                        }

                        lastUpdated.innerHTML = `<span class="material-icons text-sm mr-1">history</span>Cập nhật lần cuối: ${timeStr}`;
                    }
                }

                // Resolve reaction
                window.resolveReaction = async function () {
                    const treatment = document.getElementById('treatment')?.value.trim() || '';
                    const notes = document.getElementById('notes')?.value.trim() || '';

                    if (!treatment) {
                        alert('Vui lòng nhập phương pháp điều trị!');
                        return;
                    }

                    if (!confirm('Bạn có chắc chắn muốn đánh dấu phản ứng này đã được xử lý?')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/adverse-reactions/${reactionId}/resolve`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                treatment: treatment,
                                notes: notes
                            })
                        });

                        if (response.ok) {
                            alert('Đã đánh dấu phản ứng đã được xử lý!');
                            loadReactionDetail();
                        } else {
                            const error = await response.json();
                            alert('Lỗi: ' + (error.error || 'Không thể cập nhật trạng thái'));
                        }
                    } catch (error) {
                        console.error('Error resolving reaction:', error);
                        alert('Có lỗi xảy ra khi cập nhật trạng thái');
                    }
                };

                // Load on page load
                loadReactionDetail();
            })();
        /*]]>*/
    </script>
</body>

</html>