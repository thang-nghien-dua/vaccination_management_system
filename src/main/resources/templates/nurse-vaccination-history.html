<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Lịch sử Tiêm chủng - Y tá</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="/js/sidebar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f766e",
                        "primary-light": "#14b8a6",
                        "primary-dark": "#134e4a",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .active-nav {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
            border-left: 4px solid #0f766e;
            color: #0f766e;
        }
        .sidebar-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-nav-item:hover {
            transform: translateX(4px);
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-effect {
            background: rgba(26, 46, 33, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .info-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .info-card:hover::before {
            opacity: 0.3;
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        .info-item {
            transition: all 0.2s ease;
            padding: 0.5rem 0;
            border-bottom: 1px solid transparent;
        }
        .info-item:hover {
            padding-left: 0.5rem;
            border-bottom-color: rgba(15, 118, 110, 0.1);
        }
        .info-label {
            font-weight: 600;
            color: #61896f;
            transition: color 0.2s ease;
        }
        .info-value {
            font-weight: 700;
            color: #111813;
            transition: color 0.2s ease;
        }
        .dark .info-value {
            color: #ffffff;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(15, 118, 110, 0.1);
        }
        .section-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .record-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .record-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white font-display">
<div class="flex min-h-screen">
    <!-- Sidebar Overlay (mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-white dark:bg-[#1a2e21] border-r border-[#f0f4f2] dark:border-[#2d3f33] fixed h-screen z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col overflow-hidden">
        <div class="p-6 flex items-center gap-3 flex-shrink-0">
            <button id="sidebarToggleBtn" class="p-2 rounded-lg hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors flex-shrink-0" title="Menu">
                <span class="material-symbols-outlined text-xl">menu</span>
            </button>
            <h1 id="sidebarLogoText" class="text-xl font-bold tracking-tight flex-1 lg:block">VacciCare</h1>
            <button id="sidebarCloseBtn" class="lg:hidden p-2 rounded-lg hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors flex-shrink-0" title="Đóng sidebar">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="sidebarUserProfile" class="px-4 mb-6 flex-shrink-0" th:if="${isAuthenticated}">
            <div class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 bg-primary/20 flex items-center justify-center text-primary font-bold text-lg flex-shrink-0" th:if="${currentUser?.fullName != null}">
                    <span th:text="${#strings.substring(currentUser.fullName, 0, 1)}"></span>
                </div>
                <div class="flex flex-col overflow-hidden min-w-0 lg:block">
                    <p id="sidebarUserName" class="text-sm font-bold truncate" th:text="${currentUser?.fullName ?: currentUser?.email}">Tên người dùng</p>
                    <p id="sidebarUserRole" class="text-xs text-[#61896f] truncate">Y tá</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 px-3 py-3 space-y-2 overflow-y-auto min-h-0">
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/nurse/dashboard">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">dashboard</span>
                <span class="text-sm">Dashboard</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/nurse/appointments">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">vaccines</span>
                <span class="text-sm">Lịch hẹn</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/nurse/vaccines">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">inventory</span>
                <span class="text-sm">Quản lý vaccine</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/nurse/reactions">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">warning</span>
                <span class="text-sm">Phản ứng phụ</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl active-nav text-primary font-bold" href="/nurse/vaccination-history">
                <span class="material-symbols-outlined text-xl">history</span>
                <span class="text-sm font-semibold">Lịch sử tiêm</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/trace">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">search</span>
                <span class="text-sm">Truy vết</span>
            </a>
            <a class="sidebar-nav-item flex items-center gap-3 px-4 py-3.5 rounded-xl text-[#61896f] dark:text-gray-300 font-medium" href="/nurse/profile">
                <span class="material-symbols-outlined text-[#111813] dark:text-white text-xl">person</span>
                <span class="text-sm">Thông tin cá nhân</span>
            </a>
        </nav>
        <div class="mt-auto p-4 border-t border-[#f0f4f2] dark:border-[#2d3f33] flex-shrink-0">
            <form th:action="@{/api/auth/logout}" method="post" class="w-full">
                <button type="submit" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                    <span class="material-symbols-outlined">logout</span>
                    <span class="text-sm font-medium">Đăng xuất</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 lg:ml-72 p-6">
        <div class="max-w-7xl mx-auto space-y-6">
            <!-- Header -->
            <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h1 class="text-2xl font-bold flex items-center gap-3">
                            <span class="size-10 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-md">
                                <span class="material-symbols-outlined text-white">history</span>
                            </span>
                            Lịch sử Tiêm chủng
                        </h1>
                        <p class="text-sm text-[#61896f] mt-2">Xem danh sách tất cả bệnh nhân đã được tiêm vaccine</p>
                    </div>
                    <button id="refreshBtn" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold flex items-center gap-2 transition-all hover:scale-105">
                        <span class="material-symbols-outlined">refresh</span>
                        <span>Làm mới</span>
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">filter_list</span>
                    Bộ lọc
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Từ ngày</label>
                        <input type="date" id="startDateFilter" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Đến ngày</label>
                        <input type="date" id="endDateFilter" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-2">Vaccine</label>
                        <select id="vaccineFilter" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="applyFilterBtn" class="w-full px-4 py-3 bg-primary hover:bg-primary-dark text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all hover:scale-105">
                            <span class="material-symbols-outlined">search</span>
                            <span>Lọc</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6 hover:shadow-xl transition-all duration-300 hover:scale-105 group">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-[#61896f] mb-1">Tổng số mũi tiêm</p>
                            <p id="statTotalRecords" class="text-2xl font-bold group-hover:text-primary transition-colors">0</p>
                        </div>
                        <div class="size-12 bg-primary/10 rounded-xl flex items-center justify-center group-hover:bg-primary/20 transition-colors">
                            <span class="material-symbols-outlined text-primary text-2xl">vaccines</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-blue-500/20 dark:border-blue-500/30 p-6 hover:shadow-xl transition-all duration-300 hover:scale-105 group">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-[#61896f] mb-1">Đã tiêm hôm nay</p>
                            <p id="statTodayRecords" class="text-2xl font-bold group-hover:text-blue-500 transition-colors">0</p>
                        </div>
                        <div class="size-12 bg-blue-500/10 rounded-xl flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
                            <span class="material-symbols-outlined text-blue-500 text-2xl">today</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-green-500/20 dark:border-green-500/30 p-6 hover:shadow-xl transition-all duration-300 hover:scale-105 group">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-[#61896f] mb-1">Số bệnh nhân</p>
                            <p id="statUniquePatients" class="text-2xl font-bold group-hover:text-green-500 transition-colors">0</p>
                        </div>
                        <div class="size-12 bg-green-500/10 rounded-xl flex items-center justify-center group-hover:bg-green-500/20 transition-colors">
                            <span class="material-symbols-outlined text-green-500 text-2xl">people</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Records List -->
            <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <span class="size-8 bg-gradient-to-br from-primary to-primary-dark rounded-lg flex items-center justify-center shadow-md">
                            <span class="material-symbols-outlined text-white text-sm">list</span>
                        </span>
                        Danh sách Lịch sử Tiêm
                    </h3>
                </div>
                <div id="recordsList" class="space-y-4">
                    <div class="text-center py-8 text-[#61896f]">
                        <span class="material-symbols-outlined text-4xl mb-2 animate-pulse">hourglass_empty</span>
                        <p>Đang tải danh sách lịch sử tiêm...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Detail Modal -->
<div id="detailModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="glass-effect rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" id="detailModalContentWrapper">
        <div class="sticky top-0 glass-effect border-b border-white/20 dark:border-white/10 p-6 flex items-center justify-between z-10">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <span class="size-10 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg">
                    <span class="material-symbols-outlined text-white">vaccines</span>
                </span>
                Chi tiết Hồ sơ Tiêm chủng
            </h3>
            <button id="closeDetailModalBtn" class="p-2 rounded-lg hover:bg-white/20 dark:hover:bg-white/10 transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="detailModalContent" class="p-6">
            <div class="text-center py-8 text-[#61896f]">
                <span class="material-symbols-outlined text-4xl mb-2 animate-spin">hourglass_empty</span>
                <p>Đang tải chi tiết...</p>
            </div>
        </div>
    </div>
</div>

<script>
    let vaccinationRecords = [];
    let vaccines = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadVaccines();
        loadVaccinationRecords();
        
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadVaccinationRecords();
        });
        
        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            loadVaccinationRecords();
        });
    });

    async function loadVaccines() {
        try {
            const response = await fetch('/api/vaccines', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                vaccines = data.vaccines || data || [];
                
                const select = document.getElementById('vaccineFilter');
                select.innerHTML = '<option value="">Tất cả</option>';
                vaccines.forEach(vaccine => {
                    const option = document.createElement('option');
                    option.value = vaccine.id;
                    option.textContent = vaccine.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading vaccines:', error);
        }
    }

    async function loadVaccinationRecords() {
        try {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            const vaccineId = document.getElementById('vaccineFilter').value;
            
            let url = '/api/nurse/vaccination-records?';
            const params = [];
            if (startDate) params.push(`startDate=${startDate}`);
            if (endDate) params.push(`endDate=${endDate}`);
            if (vaccineId) params.push(`vaccineId=${vaccineId}`);
            
            url += params.join('&');
            
            const response = await fetch(url, { credentials: 'include' });
            if (!response.ok) {
                throw new Error('Failed to load vaccination records');
            }
            
            const data = await response.json();
            vaccinationRecords = data.records || [];
            
            updateStatistics();
            renderRecords();
        } catch (error) {
            console.error('Error loading vaccination records:', error);
            document.getElementById('recordsList').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <span class="material-symbols-outlined text-4xl mb-2">error</span>
                    <p>Có lỗi xảy ra khi tải danh sách lịch sử tiêm</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    }

    function updateStatistics() {
        const today = new Date().toISOString().split('T')[0];
        const todayRecords = vaccinationRecords.filter(r => r.injectionDate === today);
        const uniquePatients = new Set(vaccinationRecords.map(r => r.user?.id).filter(id => id));
        
        document.getElementById('statTotalRecords').textContent = vaccinationRecords.length;
        document.getElementById('statTodayRecords').textContent = todayRecords.length;
        document.getElementById('statUniquePatients').textContent = uniquePatients.size;
    }

    function renderRecords() {
        const container = document.getElementById('recordsList');
        
        if (vaccinationRecords.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-[#61896f]">
                    <span class="material-symbols-outlined text-4xl mb-2">inbox</span>
                    <p>Không có lịch sử tiêm nào</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = vaccinationRecords.map((record, index) => {
            const patient = record.user || {};
            const vaccine = record.vaccine || {};
            const nurse = record.nurse || {};
            const center = record.appointment?.center || {};
            
            return `
                <div class="record-card glass-effect rounded-2xl p-6 border-2 border-primary/10 dark:border-primary/20 hover:border-primary/30 hover:shadow-xl fade-in" style="animation-delay: ${index * 0.05}s">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="px-4 py-1.5 bg-gradient-to-r from-primary to-primary-dark text-white rounded-xl text-xs font-bold shadow-lg shadow-primary/30">Mũi ${record.doseNumber || 1}</span>
                                ${record.certificateNumber ? `<span class="px-4 py-1.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-500/30">${record.certificateNumber}</span>` : ''}
                            </div>
                            <h4 class="text-xl font-extrabold mb-4 bg-gradient-to-r from-primary to-primary-light bg-clip-text text-transparent">${patient.fullName || 'N/A'}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm mb-4">
                                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">vaccines</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Vaccine</div>
                                        <div class="font-bold">${vaccine.name || 'N/A'}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">calendar_today</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Ngày tiêm</div>
                                        <div class="font-bold">${formatDate(record.injectionDate)}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">schedule</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Giờ tiêm</div>
                                        <div class="font-bold">${formatTime(record.injectionTime)}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">location_on</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Trung tâm</div>
                                        <div class="font-bold">${center.name || 'N/A'}</div>
                                    </div>
                                </div>
                                ${record.injectionSite ? `<div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">pin_drop</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Vị trí tiêm</div>
                                        <div class="font-bold">${getInjectionSiteName(record.injectionSite)}</div>
                                    </div>
                                </div>` : ''}
                                ${record.vaccineLot?.lotNumber ? `<div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/50 dark:hover:bg-black/20 transition-colors">
                                    <span class="size-8 bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined text-base">inventory</span>
                                    </span>
                                    <div>
                                        <div class="text-xs text-[#61896f]">Lô vaccine</div>
                                        <div class="font-bold">${record.vaccineLot.lotNumber}</div>
                                    </div>
                                </div>` : ''}
                            </div>
                            <div class="flex flex-wrap gap-3 mt-4 pt-4 border-t border-[#e2e8f0] dark:border-[#2d3f33]">
                                ${nurse.fullName ? `<div class="flex items-center gap-2 text-sm">
                                    <span class="size-6 bg-purple-500/10 rounded-lg flex items-center justify-center">
                                        <span class="material-symbols-outlined text-purple-600 dark:text-purple-400 text-base">medical_services</span>
                                    </span>
                                    <span class="text-[#61896f]"><span class="font-semibold">Y tá:</span> <span class="font-bold">${nurse.fullName}</span></span>
                                </div>` : ''}
                                ${patient.phoneNumber ? `<div class="flex items-center gap-2 text-sm">
                                    <span class="size-6 bg-blue-500/10 rounded-lg flex items-center justify-center">
                                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-base">phone</span>
                                    </span>
                                    <span class="text-[#61896f]"><span class="font-semibold">SĐT:</span> <span class="font-bold">${patient.phoneNumber}</span></span>
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="viewRecordDetail(${record.id})" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30 hover:shadow-xl hover:shadow-blue-500/40 hover:scale-105 active:scale-95">
                                <span class="material-symbols-outlined text-base">visibility</span>
                                <span>Chi tiết</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('vi-VN');
    }

    function formatTime(timeString) {
        if (!timeString) return 'N/A';
        return timeString.substring(0, 5);
    }

    function getInjectionSiteName(site) {
        const sites = {
            'LEFT_ARM': 'Tay trái',
            'RIGHT_ARM': 'Tay phải',
            'LEFT_THIGH': 'Đùi trái',
            'RIGHT_THIGH': 'Đùi phải'
        };
        return sites[site] || site;
    }

    async function viewRecordDetail(recordId) {
        try {
            const modal = document.getElementById('detailModal');
            const wrapper = document.getElementById('detailModalContentWrapper');
            const content = document.getElementById('detailModalContent');
            
            modal.classList.remove('hidden');
            wrapper.classList.remove('scale-95', 'opacity-0');
            wrapper.classList.add('scale-100', 'opacity-100');
            
            content.innerHTML = `
                <div class="text-center py-8 text-[#61896f]">
                    <span class="material-symbols-outlined text-4xl mb-2 animate-spin">hourglass_empty</span>
                    <p>Đang tải chi tiết...</p>
                </div>
            `;
            
            const response = await fetch(`/api/vaccination-records/${recordId}`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Failed to load record detail');
            }
            
            const record = await response.json();
            renderRecordDetail(record);
        } catch (error) {
            console.error('Error loading record detail:', error);
            document.getElementById('detailModalContent').innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <span class="material-symbols-outlined text-4xl mb-2">error</span>
                    <p>Có lỗi xảy ra khi tải chi tiết hồ sơ</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    }
    
    function renderRecordDetail(record) {
        const patient = record.user || {};
        const vaccine = record.vaccine || {};
        const nurse = record.nurse || {};
        const lot = record.vaccineLot || {};
        const center = record.appointment?.center || {};
        const reactions = record.adverseReactions || [];
        
        const content = document.getElementById('detailModalContent');
        content.innerHTML = `
            <div class="space-y-6 fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Thông tin Bệnh nhân -->
                    <div class="info-card bg-gradient-to-br from-blue-50/50 to-indigo-50/50 dark:from-blue-950/20 dark:to-indigo-950/20 rounded-2xl p-6 border border-blue-200/50 dark:border-blue-800/30">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-500/30">
                                <span class="material-symbols-outlined">person</span>
                            </div>
                            <h4 class="font-bold text-lg text-blue-600 dark:text-blue-400">Thông tin Bệnh nhân</h4>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="info-item"><span class="info-label">Họ tên:</span> <span class="info-value ml-2">${patient.fullName || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">SĐT:</span> <span class="info-value ml-2">${patient.phoneNumber || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value ml-2">${patient.email || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Ngày sinh:</span> <span class="info-value ml-2">${formatDate(patient.dayOfBirth)}</span></div>
                            <div class="info-item"><span class="info-label">Giới tính:</span> <span class="info-value ml-2">${formatGender(patient.gender)}</span></div>
                            ${patient.address ? `<div class="info-item"><span class="info-label">Địa chỉ:</span> <span class="info-value ml-2">${patient.address}</span></div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Thông tin Y tá -->
                    <div class="info-card bg-gradient-to-br from-purple-50/50 to-pink-50/50 dark:from-purple-950/20 dark:to-pink-950/20 rounded-2xl p-6 border border-purple-200/50 dark:border-purple-800/30">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-purple-500 to-pink-600 text-white shadow-lg shadow-purple-500/30">
                                <span class="material-symbols-outlined">medical_services</span>
                            </div>
                            <h4 class="font-bold text-lg text-purple-600 dark:text-purple-400">Y tá Thực hiện</h4>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="info-item"><span class="info-label">Họ tên:</span> <span class="info-value ml-2">${nurse.fullName || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Email:</span> <span class="info-value ml-2">${nurse.email || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">SĐT:</span> <span class="info-value ml-2">${nurse.phoneNumber || 'N/A'}</span></div>
                        </div>
                    </div>
                    
                    <!-- Thông tin Vaccine -->
                    <div class="info-card bg-gradient-to-br from-green-50/50 to-emerald-50/50 dark:from-green-950/20 dark:to-emerald-950/20 rounded-2xl p-6 border border-green-200/50 dark:border-green-800/30">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-lg shadow-green-500/30">
                                <span class="material-symbols-outlined">vaccines</span>
                            </div>
                            <h4 class="font-bold text-lg text-green-600 dark:text-green-400">Thông tin Vaccine</h4>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="info-item"><span class="info-label">Tên vaccine:</span> <span class="info-value ml-2">${vaccine.name || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Nhà sản xuất:</span> <span class="info-value ml-2">${vaccine.manufacturer || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Mã vaccine:</span> <span class="info-value ml-2">${vaccine.code || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Mũi tiêm:</span> <span class="info-value ml-2 text-primary">Mũi ${record.doseNumber || 1}</span></div>
                            <div class="info-item"><span class="info-label">Liều lượng:</span> <span class="info-value ml-2">${record.doseAmount ? record.doseAmount + ' ml' : 'N/A'}</span></div>
                        </div>
                    </div>
                    
                    <!-- Thông tin Lô vaccine -->
                    <div class="info-card bg-gradient-to-br from-orange-50/50 to-amber-50/50 dark:from-orange-950/20 dark:to-amber-950/20 rounded-2xl p-6 border border-orange-200/50 dark:border-orange-800/30">
                        <div class="section-header">
                            <div class="section-icon bg-gradient-to-br from-orange-500 to-amber-600 text-white shadow-lg shadow-orange-500/30">
                                <span class="material-symbols-outlined">inventory</span>
                            </div>
                            <h4 class="font-bold text-lg text-orange-600 dark:text-orange-400">Thông tin Lô Vaccine</h4>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="info-item"><span class="info-label">Số lô:</span> <span class="info-value ml-2">${lot.lotNumber || 'N/A'}</span></div>
                            <div class="info-item"><span class="info-label">Ngày sản xuất:</span> <span class="info-value ml-2">${formatDate(lot.manufacturingDate)}</span></div>
                            <div class="info-item"><span class="info-label">Hạn sử dụng:</span> <span class="info-value ml-2">${formatDate(lot.expiryDate)}</span></div>
                            ${record.batchNumber ? `<div class="info-item"><span class="info-label">Số batch:</span> <span class="info-value ml-2">${record.batchNumber}</span></div>` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Thông tin Tiêm chủng -->
                <div class="info-card bg-gradient-to-br from-cyan-50/50 to-teal-50/50 dark:from-cyan-950/20 dark:to-teal-950/20 rounded-2xl p-6 border border-cyan-200/50 dark:border-cyan-800/30">
                    <div class="section-header">
                        <div class="section-icon bg-gradient-to-br from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30">
                            <span class="material-symbols-outlined">calendar_today</span>
                        </div>
                        <h4 class="font-bold text-lg text-cyan-600 dark:text-cyan-400">Thông tin Tiêm chủng</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="info-item"><span class="info-label">Ngày tiêm:</span> <span class="info-value ml-2">${formatDate(record.injectionDate)}</span></div>
                        <div class="info-item"><span class="info-label">Giờ tiêm:</span> <span class="info-value ml-2">${formatTime(record.injectionTime)}</span></div>
                        <div class="info-item"><span class="info-label">Vị trí tiêm:</span> <span class="info-value ml-2">${getInjectionSiteName(record.injectionSite)}</span></div>
                        <div class="info-item"><span class="info-label">Mã hẹn:</span> <span class="info-value ml-2">${record.appointment?.bookingCode || 'N/A'}</span></div>
                        <div class="info-item"><span class="info-label">Trung tâm:</span> <span class="info-value ml-2">${center.name || 'N/A'}</span></div>
                        <div class="info-item"><span class="info-label">Số chứng nhận:</span> <span class="info-value ml-2 font-bold text-primary">${record.certificateNumber || 'N/A'}</span></div>
                        ${record.nextDoseDate ? `<div class="info-item"><span class="info-label">Mũi tiếp theo:</span> <span class="info-value ml-2 text-primary font-bold">${formatDate(record.nextDoseDate)}</span></div>` : ''}
                    </div>
                </div>
                
                ${reactions && reactions.length > 0 ? `
                <!-- Phản ứng phụ -->
                <div class="info-card bg-gradient-to-br from-red-50/50 to-rose-50/50 dark:from-red-950/20 dark:to-rose-950/20 rounded-2xl p-6 border border-red-200/50 dark:border-red-800/30">
                    <div class="section-header">
                        <div class="section-icon bg-gradient-to-br from-red-500 to-rose-600 text-white shadow-lg shadow-red-500/30">
                            <span class="material-symbols-outlined">warning</span>
                        </div>
                        <h4 class="font-bold text-lg text-red-600 dark:text-red-400">Phản ứng phụ (${reactions.length})</h4>
                    </div>
                    <div class="space-y-4">
                        ${reactions.map(reaction => `
                            <div class="bg-white/60 dark:bg-black/30 rounded-xl p-5 border-2 border-red-200/40 dark:border-red-800/30 hover:border-red-300/60 dark:hover:border-red-700/50 transition-all duration-300 hover:shadow-lg">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-3 py-1.5 rounded-lg text-xs font-bold ${reaction.resolved ? 'bg-green-500/20 text-green-700 dark:text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-700 dark:text-red-400 border border-red-500/30'}">
                                            ${reaction.resolved ? '✓ Đã xử lý' : '⚠ Chưa xử lý'}
                                        </span>
                                        <span class="px-3 py-1.5 rounded-lg text-xs font-bold bg-blue-500/20 text-blue-700 dark:text-blue-400 border border-blue-500/30">
                                            ${getReactionTypeName(reaction.reactionType) || 'N/A'}
                                        </span>
                                    </div>
                                    <span class="text-xs text-[#61896f] dark:text-gray-400 font-medium">${formatDateTime(reaction.occurredAt)}</span>
                                </div>
                                <p class="text-sm font-semibold mb-2 text-[#111813] dark:text-white">${reaction.symptoms || 'Không có mô tả'}</p>
                                ${reaction.treatment ? `<p class="text-xs text-[#61896f] dark:text-gray-400 mb-1"><span class="font-semibold">Điều trị:</span> ${reaction.treatment}</p>` : ''}
                                ${reaction.handledBy ? `<p class="text-xs text-[#61896f] dark:text-gray-400 mt-2"><span class="font-semibold">Xử lý bởi:</span> <span class="font-bold">${reaction.handledBy.fullName}</span></p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function formatGender(gender) {
        if (!gender) return 'N/A';
        const genderMap = { 'MALE': 'Nam', 'FEMALE': 'Nữ', 'OTHER': 'Khác' };
        return genderMap[gender] || gender;
    }
    
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'N/A';
        const date = new Date(dateTimeString);
        return date.toLocaleString('vi-VN');
    }
    
    function getReactionTypeName(type) {
        if (!type) return 'N/A';
        const types = {
            'MILD': 'Nhẹ',
            'MODERATE': 'Trung bình',
            'SEVERE': 'Nặng'
        };
        return types[type] || type;
    }
    
    // Modal handlers
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('detailModal');
        const closeBtn = document.getElementById('closeDetailModalBtn');
        const wrapper = document.getElementById('detailModalContentWrapper');
        
        closeBtn.addEventListener('click', () => {
            wrapper.classList.remove('scale-100', 'opacity-100');
            wrapper.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                wrapper.classList.remove('scale-100', 'opacity-100');
                wrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        });
    });
</script>
</body>
</html>
