<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Đặt lịch - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="/css/ux-enhancements.css" rel="stylesheet"/>
    <script src="/js/sidebar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f766e",
                        "primary-light": "#14b8a6",
                        "primary-dark": "#134e4a",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .active-nav {
            background-color: #f0f4f2;
            border-left: 4px solid #0f766e;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white font-display">
<div class="flex min-h-screen">
    <!-- Sidebar Overlay (mobile) -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-white dark:bg-[#1a2e21] border-r border-[#f0f4f2] dark:border-[#2d3f33] fixed h-full z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-6 flex items-center gap-3">
            <button id="sidebarToggleBtn" class="p-2 rounded-lg hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors flex-shrink-0" title="Menu">
                <span class="material-symbols-outlined text-xl">menu</span>
            </button>
            <h1 id="sidebarLogoText" class="text-xl font-bold tracking-tight flex-1 lg:block">VacciCare</h1>
            <button id="sidebarCloseBtn" class="lg:hidden p-2 rounded-lg hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors flex-shrink-0" title="Đóng sidebar">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="sidebarUserProfile" class="px-4 mb-6" th:if="${isAuthenticated}">
            <div class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 bg-primary/20 flex items-center justify-center text-primary font-bold text-lg" th:if="${currentUser?.fullName != null}">
                    <span th:text="${#strings.substring(currentUser.fullName, 0, 1)}"></span>
                </div>
                <div class="flex flex-col overflow-hidden">
                    <p class="text-sm font-bold truncate" th:text="${currentUser?.fullName ?: currentUser?.email}">Tên người dùng</p>
                    <p class="text-xs text-[#61896f] truncate" th:text="${currentUser?.role?.name() == 'CUSTOMER' ? 'Người dùng cá nhân' : (currentUser?.role?.name() == 'ADMIN' ? 'Quản trị viên' : 'Nhân viên y tế')}">Người dùng cá nhân</p>
                </div>
            </div>
        </div>
        <nav class="flex-1 px-2 space-y-1">
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="/home">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">dashboard</span>
                <span id="navTextHome" class="text-sm font-medium">Tổng quan</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="/profile">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">person</span>
                <span id="navTextProfile" class="text-sm font-medium">Thông tin cá nhân</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg active-nav text-primary font-bold" href="/appointments">
                <span class="material-symbols-outlined">calendar_month</span>
                <span id="navTextAppointments" class="text-sm">Đặt lịch</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="/vaccination-history">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">history_edu</span>
                <span id="navTextHistory" class="text-sm font-medium">Hồ sơ tiêm chủng</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="/family-members">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">group</span>
                <span id="navTextFamily" class="text-sm font-medium">Người thân</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="/vaccines">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">vaccines</span>
                <span id="navTextVaccines" class="text-sm font-medium">Vaccine</span>
            </a>
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors relative" href="/notifications">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">notifications</span>
                <span id="navTextNotifications" class="text-sm font-medium">Thông báo</span>
                <span id="notificationBadge" class="hidden absolute top-2 right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
            </a>
        </nav>
        <div class="mt-auto p-4 border-t border-[#f0f4f2] dark:border-[#2d3f33] space-y-2">
            <a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#61896f] hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors" href="#">
                <span class="material-symbols-outlined text-[#111813] dark:text-white">settings</span>
                <span id="navTextSettings" class="text-sm font-medium">Cài đặt</span>
            </a>
            <form th:action="@{/api/auth/logout}" method="post" class="inline">
                <button type="submit" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-500 hover:bg-red-50 transition-colors">
                    <span class="material-symbols-outlined">logout</span>
                    <span id="navTextLogout" class="text-sm font-medium">Đăng xuất</span>
                </button>
            </form>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-h-screen">
        <!-- Top Navigation Bar -->
        <header class="sticky top-0 z-30 bg-gradient-to-r from-primary/10 via-primary/5 to-white/90 dark:from-primary/20 dark:via-primary/10 dark:to-[#102216]/90 backdrop-blur-xl border-b border-primary/20 dark:border-primary/30 px-4 lg:px-8 py-6 flex items-center justify-between transition-all">
            <div class="flex items-center gap-4">
                <div class="size-12 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/20 lg:hidden">
                    <span class="material-symbols-outlined text-white text-2xl">calendar_month</span>
                </div>
                <a href="/home" class="flex items-center gap-2 lg:hidden">
                    <div class="size-8 text-primary">
                        <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <h1 class="text-lg font-bold">VacciCare</h1>
                </a>
                <div class="hidden lg:flex items-center gap-4">
                    <div class="size-12 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-white text-2xl">calendar_month</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-[#111813] dark:text-white mb-1">Đặt lịch tiêm chủng</h2>
                        <p class="text-sm text-[#61896f]">Chọn vaccine, trung tâm và khung giờ phù hợp</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <a href="/notifications" class="p-2 rounded-lg bg-background-light dark:bg-[#1a2e21] hover:bg-[#e0e7e3] transition-colors relative">
                    <span class="material-symbols-outlined">notifications</span>
                    <span id="headerNotificationBadge" class="hidden absolute top-2.5 right-2.5 bg-red-500 text-white text-xs font-bold rounded-full min-w-[18px] h-[18px] flex items-center justify-center px-1 border-2 border-white dark:border-[#1a2e21]">0</span>
                </a>
            </div>
        </header>

        <div class="p-8 space-y-6 w-full">
            <!-- Filter Form -->
            <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-primary-light to-primary-dark"></div>
                <h3 class="text-lg font-bold mb-4 relative z-10 flex items-center gap-2">
                    <span class="size-8 bg-gradient-to-br from-primary to-primary-dark rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">event</span>
                    </span>
                    Thông tin đặt lịch
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold mb-2">Vaccine <span class="text-red-500">*</span></label>
                        <select id="vaccineSelect" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                            <option value="">Chọn vaccine</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold mb-2">Trung tâm <span class="text-red-500">*</span></label>
                        <select id="centerSelect" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                            <option value="">Chọn trung tâm</option>
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-semibold mb-2">Từ ngày <span class="text-red-500">*</span></label>
                        <input type="date" id="startDate" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-semibold mb-2">Đến ngày <span class="text-red-500">*</span></label>
                        <input type="date" id="endDate" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                    </div>
                </div>
                <div class="mt-4 flex gap-3 relative z-10">
                    <button id="loadSlotsBtn" class="bg-gradient-to-r from-primary to-primary-dark hover:from-primary-dark hover:to-primary text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 hover:scale-105 active:scale-95">
                        <span class="material-symbols-outlined">search</span>
                        <span>Tìm slot trống</span>
                    </button>
                    <button id="resetBtn" class="bg-white dark:bg-[#1a2e21] border-2 border-primary/30 dark:border-primary/30 text-[#111813] dark:text-white hover:bg-primary/5 dark:hover:bg-primary/10 hover:border-primary/50 px-6 py-3 rounded-xl font-bold transition-all">
                        <span>Đặt lại</span>
                    </button>
                </div>
            </div>

            <!-- Schedule Table -->
            <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 dark:border-primary/30 p-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-primary-light to-primary-dark"></div>
                <h3 class="text-lg font-bold mb-4 relative z-10 flex items-center gap-2">
                    <span class="size-8 bg-gradient-to-br from-primary to-primary-dark rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-sm">schedule</span>
                    </span>
                    Bảng thời khóa biểu
                </h3>
                <div id="scheduleTableContainer" class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-[#f0f4f2] dark:bg-[#2d3f33]">
                                <th class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3 text-left font-semibold">Ngày</th>
                                <th class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3 text-left font-semibold">Khung giờ</th>
                                <th class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3 text-left font-semibold">Trạng thái</th>
                                <th class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3 text-left font-semibold">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-8 text-[#61896f]">Vui lòng chọn vaccine, trung tâm và khoảng thời gian để xem các slot trống</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-xl max-w-md w-full my-8 flex flex-col max-h-[calc(100vh-4rem)] overflow-hidden">
        <div class="flex justify-between items-center p-6 pb-4 border-b border-[#e2e8f0] dark:border-[#2d3f33] flex-shrink-0">
            <h3 class="text-xl font-bold">Xác nhận đặt lịch</h3>
            <button id="closeModalBtn" class="text-[#61896f] hover:text-[#111813] dark:hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="bookingModalContent" class="flex-1 overflow-y-auto p-6 space-y-4 min-h-0">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="p-6 pt-4 border-t border-[#e2e8f0] dark:border-[#2d3f33] flex gap-3 bg-white dark:bg-[#1a2e21] flex-shrink-0 rounded-b-2xl">
            <button id="confirmBookingBtn" class="flex-1 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-xl font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                <span id="confirmBookingBtnText">Xác nhận đặt lịch</span>
                <span id="confirmBookingBtnSpinner" class="hidden">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
            <button id="cancelBookingBtn" class="flex-1 bg-white dark:bg-[#1a2e21] border-2 border-[#e2e8f0] dark:border-[#2d3f33] text-[#111813] dark:text-white hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] px-6 py-3 rounded-xl font-bold transition-all">
                Hủy
            </button>
        </div>
    </div>
</div>

<!-- Phone Verification Modal -->
<div id="phoneVerificationModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-xl max-w-md w-full my-8 flex flex-col max-h-[calc(100vh-4rem)] overflow-hidden">
        <div class="flex justify-between items-center p-6 pb-4 border-b border-[#e2e8f0] dark:border-[#2d3f33] flex-shrink-0">
            <h3 class="text-xl font-bold">Xác thực số điện thoại</h3>
            <button id="closePhoneModalBtn" class="text-[#61896f] hover:text-[#111813] dark:hover:text-white">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="phoneVerificationContent" class="flex-1 overflow-y-auto p-6 space-y-4 min-h-0">
            <!-- Step 1: Enter Phone Number -->
            <div id="phoneNumberStep">
                <p class="text-sm text-[#61896f] mb-4">Vui lòng nhập số điện thoại để nhận mã xác thực</p>
                <div>
                    <label class="block text-sm font-semibold mb-2">Số điện thoại <span class="text-red-500">*</span></label>
                    <input type="tel" id="phoneNumberInput" placeholder="0123456789" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                </div>
                <div id="phoneError" class="hidden mt-2 text-sm text-red-600"></div>
                <button id="sendCodeBtn" class="w-full mt-4 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-xl font-bold transition-all">
                    Gửi mã xác thực
                </button>
            </div>
            
            <!-- Step 2: Enter Verification Code -->
            <div id="verificationCodeStep" class="hidden">
                <p class="text-sm text-[#61896f] mb-4">Mã xác thực đã được gửi đến số điện thoại <span id="phoneNumberDisplay" class="font-semibold"></span></p>
                <div>
                    <label class="block text-sm font-semibold mb-2">Mã xác thực (6 số) <span class="text-red-500">*</span></label>
                    <input type="text" id="verificationCodeInput" maxlength="6" placeholder="000000" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white text-center text-2xl tracking-widest">
                </div>
                <div id="codeError" class="hidden mt-2 text-sm text-red-600"></div>
                <div class="mt-2 text-sm text-[#61896f]">
                    <span id="countdownTimer" class="font-semibold"></span>
                </div>
                <div class="mt-4 flex gap-3">
                    <button id="verifyCodeBtn" class="flex-1 bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-xl font-bold transition-all">
                        Xác thực
                    </button>
                    <button id="resendCodeBtn" class="px-4 py-3 bg-white dark:bg-[#1a2e21] border-2 border-[#e2e8f0] dark:border-[#2d3f33] text-[#111813] dark:text-white hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] rounded-xl font-bold transition-all">
                        Gửi lại
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message -->
<div id="messageDiv" class="hidden fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg max-w-md"></div>

<script>
    // Get selected vaccine ID and family member ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedVaccineId = /*[[${selectedVaccineId}]]*/ urlParams.get('vaccineId');
    const selectedFamilyMemberId = /*[[${selectedFamilyMemberId}]]*/ urlParams.get('familyMemberId');
    
    let vaccines = [];
    let centers = [];
    let availableSlots = [];
    let selectedSlotForBooking = null;
    let selectedBookingForUserId = null;

    // Set min date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').min = today;
    document.getElementById('endDate').min = today;

    // Load vaccines
    async function loadVaccines() {
        try {
            const response = await fetch('/api/vaccines', {
                credentials: 'include'
            });
            if (response.ok) {
                vaccines = await response.json();
                const select = document.getElementById('vaccineSelect');
                select.innerHTML = '<option value="">Chọn vaccine</option>';
                vaccines.forEach(vaccine => {
                    if (vaccine.status === 'AVAILABLE') {
                        const option = document.createElement('option');
                        option.value = vaccine.id;
                        option.textContent = vaccine.name;
                        if (selectedVaccineId && vaccine.id == selectedVaccineId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    }
                });
                
                // If vaccine is pre-selected, load centers for that vaccine
                if (selectedVaccineId) {
                    await loadCentersForVaccine(selectedVaccineId);
                }
            }
        } catch (error) {
            console.error('Error loading vaccines:', error);
        }
    }

    // Load centers
    async function loadCenters() {
        try {
            const response = await fetch('/api/centers', {
                credentials: 'include'
            });
            if (response.ok) {
                centers = await response.json();
                const select = document.getElementById('centerSelect');
                select.innerHTML = '<option value="">Chọn trung tâm</option>';
                centers.forEach(center => {
                    if (center.status === 'ACTIVE') {
                        const option = document.createElement('option');
                        option.value = center.id;
                        option.textContent = center.name;
                        select.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Error loading centers:', error);
        }
    }

    // Load centers for specific vaccine
    async function loadCentersForVaccine(vaccineId) {
        try {
            const response = await fetch(`/api/vaccines/${vaccineId}/centers`, {
                credentials: 'include'
            });
            if (response.ok) {
                const vaccineCenters = await response.json();
                // Cập nhật mảng centers để có thể tìm kiếm sau này
                centers = vaccineCenters;
                const select = document.getElementById('centerSelect');
                select.innerHTML = '<option value="">Chọn trung tâm</option>';
                vaccineCenters.forEach(center => {
                    const option = document.createElement('option');
                    option.value = center.id;
                    option.textContent = center.name + (center.stockQuantity ? ` (Còn ${center.stockQuantity} liều)` : '');
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading centers for vaccine:', error);
        }
    }

    // Load available slots
    async function loadAvailableSlots() {
        const vaccineId = document.getElementById('vaccineSelect').value;
        const centerId = document.getElementById('centerSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!vaccineId || !centerId || !startDate || !endDate) {
            showMessage('Vui lòng điền đầy đủ thông tin', 'error');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            showMessage('Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/appointment-slots/available/center/${centerId}/date-range?startDate=${startDate}&endDate=${endDate}`, {
                credentials: 'include'
            });

            if (response.ok) {
                availableSlots = await response.json();
                renderScheduleTable();
            } else {
                const error = await response.json();
                showMessage(error.error || 'Không thể tải danh sách slot', 'error');
            }
        } catch (error) {
            console.error('Error loading slots:', error);
            showMessage('Có lỗi xảy ra khi tải danh sách slot', 'error');
        }
    }

    // Render schedule table
    function renderScheduleTable() {
        const tbody = document.getElementById('scheduleTableBody');
        tbody.innerHTML = '';

        if (availableSlots.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-[#61896f]">Không có slot trống trong khoảng thời gian đã chọn</td></tr>';
            return;
        }

        // Group slots by date
        const slotsByDate = {};
        availableSlots.forEach(slot => {
            const date = slot.date;
            if (!slotsByDate[date]) {
                slotsByDate[date] = [];
            }
            slotsByDate[date].push(slot);
        });

        // Sort dates
        const sortedDates = Object.keys(slotsByDate).sort();

        sortedDates.forEach(date => {
            const slots = slotsByDate[date].sort((a, b) => a.startTime.localeCompare(b.startTime));
            slots.forEach((slot, index) => {
                const row = document.createElement('tr');
                const remaining = slot.maxCapacity - slot.currentBookings;
                const isAvailable = remaining > 0;
                
                row.className = isAvailable ? 'hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors' : 'opacity-50';
                
                const dateCell = index === 0 ? `<td class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3" rowspan="${slots.length}">${formatDate(date)}</td>` : '';
                const timeStr = `${slot.startTime.substring(0, 5)} - ${slot.endTime.substring(0, 5)}`;
                
                row.innerHTML = `
                    ${dateCell}
                    <td class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3">${timeStr}</td>
                    <td class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${isAvailable ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}">
                            ${isAvailable ? `Còn ${remaining}/${slot.maxCapacity} chỗ` : 'Đã hết chỗ'}
                        </span>
                    </td>
                    <td class="border border-[#e2e8f0] dark:border-[#2d3f33] px-4 py-3">
                        ${isAvailable ? `<button onclick="openBookingModal(${slot.id})" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all">Đặt lịch</button>` : '<span class="text-[#61896f] text-sm">Không thể đặt</span>'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        });
    }

    // Format date
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Open booking modal
    window.openBookingModal = async function(slotId) {
        const slot = availableSlots.find(s => s.id === slotId);
        if (!slot) return;

        // Reset phone verification state khi mở modal mới
        resetPhoneVerificationState();

        selectedSlotForBooking = slot;
        const vaccineId = document.getElementById('vaccineSelect').value;
        const vaccine = vaccines.find(v => v.id == vaccineId);
        const centerId = document.getElementById('centerSelect').value;
        // Convert centerId to number for comparison
        const center = centers.find(c => c.id == parseInt(centerId) || c.id == centerId);

        const modalContent = document.getElementById('bookingModalContent');
        modalContent.innerHTML = `
            <div class="space-y-2">
                <p><strong>Vaccine:</strong> ${vaccine ? vaccine.name : 'N/A'}</p>
                <p><strong>Trung tâm:</strong> ${center ? center.name : 'N/A'}</p>
                <p><strong>Ngày:</strong> ${formatDate(slot.date)}</p>
                <p><strong>Giờ:</strong> ${slot.startTime.substring(0, 5)} - ${slot.endTime.substring(0, 5)}</p>
                <p><strong>Còn lại:</strong> ${slot.maxCapacity - slot.currentBookings}/${slot.maxCapacity} chỗ</p>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold mb-2">Đặt cho</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="bookingFor" value="self" checked class="text-primary">
                        <span>Bản thân</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="bookingFor" value="family" class="text-primary">
                        <span>Người thân</span>
                    </label>
                </div>
            </div>
            <div id="familyMemberSelect" class="hidden mt-4">
                <label class="block text-sm font-semibold mb-2">Chọn người thân</label>
                <select id="bookedForUserId" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                    <option value="">Đang tải...</option>
                </select>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold mb-2">Số điện thoại <span class="text-red-500">*</span></label>
                <input type="tel" id="bookingPhoneNumber" placeholder="0123456789" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                <p class="mt-1 text-xs text-[#61896f]">Số điện thoại sẽ được sử dụng để liên hệ về lịch hẹn</p>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold mb-2">Phương thức thanh toán <span class="text-red-500">*</span></label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer p-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] hover:border-primary transition-all">
                        <input type="radio" name="paymentMethod" value="CASH" checked class="text-primary">
                        <span class="flex-1">
                            <span class="font-semibold">Tiền mặt</span>
                            <span class="text-xs text-[#61896f] block">Thanh toán tại trung tâm khi đến tiêm</span>
                        </span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer p-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] hover:border-primary transition-all">
                        <input type="radio" name="paymentMethod" value="VNPAY" class="text-primary">
                        <span class="flex-1">
                            <span class="font-semibold">VNPay</span>
                            <span class="text-xs text-[#61896f] block">Thanh toán online qua VNPay</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-semibold mb-2">Ghi chú (tùy chọn)</label>
                <textarea id="bookingNotes" rows="2" class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all resize-none bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white" placeholder="Thông tin bổ sung..."></textarea>
            </div>
        `;

        // Handle bookingFor radio change
        document.querySelectorAll('input[name="bookingFor"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'family') {
                    document.getElementById('familyMemberSelect').classList.remove('hidden');
                    loadFamilyMembers();
                } else {
                    document.getElementById('familyMemberSelect').classList.add('hidden');
                    selectedBookingForUserId = null;
                }
            });
        });

        // Load current user phone number if available - đợi hoàn thành trước khi hiển thị modal
        await loadCurrentUserPhone();

        // Reset nút về trạng thái ban đầu (quan trọng: nút nằm ngoài bookingModalContent nên không bị reset khi innerHTML)
        const confirmBtn = document.getElementById('confirmBookingBtn');
        const confirmBtnText = document.getElementById('confirmBookingBtnText');
        const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            if (confirmBtnText) {
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
            }
            if (confirmBtnSpinner) {
                confirmBtnSpinner.classList.add('hidden');
            }
            console.log('[DEBUG] openBookingModal: Đã reset trạng thái nút về enabled');
        }

        document.getElementById('bookingModal').classList.remove('hidden');
    };

    // Load current user phone number
    async function loadCurrentUserPhone() {
        try {
            console.log('[DEBUG] loadCurrentUserPhone: Bắt đầu load số điện thoại');
            const response = await fetch('/api/phone/verification-status', {
                credentials: 'include'
            });
            if (response.ok) {
                const status = await response.json();
                console.log('[DEBUG] loadCurrentUserPhone: API response:', status);
                // Chỉ pre-fill nếu số điện thoại đã được xác thực
                if (status.verified && status.phoneNumber) {
                    const phoneInput = document.getElementById('bookingPhoneNumber');
                    if (phoneInput) {
                        phoneInput.value = status.phoneNumber;
                        console.log('[DEBUG] loadCurrentUserPhone: Đã điền số điện thoại vào form:', status.phoneNumber);
                    } else {
                        console.warn('[DEBUG] loadCurrentUserPhone: Không tìm thấy element bookingPhoneNumber');
                    }
                } else {
                    console.log('[DEBUG] loadCurrentUserPhone: Số điện thoại chưa được xác thực hoặc không có số');
                }
            } else {
                console.error('[DEBUG] loadCurrentUserPhone: API response không OK:', response.status);
            }
        } catch (error) {
            console.error('[DEBUG] loadCurrentUserPhone: Error loading user phone:', error);
        }
    }

    // Load family members
    async function loadFamilyMembers() {
        try {
            const response = await fetch('/api/family-members', {
                credentials: 'include'
            });
            if (response.ok) {
                const members = await response.json();
                const select = document.getElementById('bookedForUserId');
                select.innerHTML = '<option value="">Chọn người thân</option>';
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.fullName;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading family members:', error);
        }
    }

    // Store booking data temporarily
    let pendingBookingData = null;
    let currentVerificationType = 'user'; // 'user' or 'family'
    let currentVerificationId = null; // user ID or family member ID
    let phoneJustVerified = false; // Flag để đánh dấu số điện thoại vừa được xác thực trong session này
    let verifiedPhoneNumber = null; // Số điện thoại đã được xác thực

    // Confirm booking
    document.getElementById('confirmBookingBtn').addEventListener('click', async () => {
        if (!selectedSlotForBooking) return;
        
        // Disable button và hiển thị loading
        const confirmBtn = document.getElementById('confirmBookingBtn');
        const confirmBtnText = document.getElementById('confirmBookingBtnText');
        const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
        
        // Kiểm tra nếu đang trong quá trình xử lý thì không cho phép click lại
        if (confirmBtn.disabled) return;
        
        confirmBtn.disabled = true;
        confirmBtnText.textContent = 'Đang kiểm tra...';
        confirmBtnSpinner.classList.remove('hidden');

        const vaccineId = document.getElementById('vaccineSelect').value;
        const centerId = document.getElementById('centerSelect').value;
        const bookingFor = document.querySelector('input[name="bookingFor"]:checked').value;
        const bookedForUserId = bookingFor === 'family' ? document.getElementById('bookedForUserId').value : null;
        let phoneNumber = document.getElementById('bookingPhoneNumber').value.trim();
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        const notes = document.getElementById('bookingNotes').value || null;

        if (bookingFor === 'family' && !bookedForUserId) {
            confirmBtn.disabled = false;
            confirmBtnText.textContent = 'Xác nhận đặt lịch';
            confirmBtnSpinner.classList.add('hidden');
            showMessage('Vui lòng chọn người thân', 'error');
            return;
        }

        // Chỉ pre-fill số điện thoại từ database nếu form trống, KHÔNG tự động submit
        // User vẫn cần xác thực số điện thoại mỗi lần đặt lịch
        if (!phoneNumber || phoneNumber.trim() === '') {
            try {
                const statusResponse = await fetch('/api/phone/verification-status', {
                    credentials: 'include'
                });
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    if (status.phoneNumber) {
                        // Chỉ pre-fill số, không tự động submit
                        document.getElementById('bookingPhoneNumber').value = status.phoneNumber;
                        phoneNumber = status.phoneNumber;
                    }
                }
            } catch (error) {
                console.error('[DEBUG] confirmBooking: Lỗi khi load số điện thoại:', error);
            }
        }

        // Chỉ yêu cầu nhập số nếu số trong database chưa verified
        if (!phoneNumber) {
            confirmBtn.disabled = false;
            confirmBtnText.textContent = 'Xác nhận đặt lịch';
            confirmBtnSpinner.classList.add('hidden');
            showMessage('Vui lòng nhập số điện thoại', 'error');
            return;
        }

        // Store booking data (doseNumber sẽ được tính tự động ở backend)
        pendingBookingData = {
            vaccineId: parseInt(vaccineId),
            centerId: parseInt(centerId),
            slotId: selectedSlotForBooking.id,
            bookedForUserId: bookedForUserId ? parseInt(bookedForUserId) : null,
            phoneNumber: phoneNumber,
            paymentMethod: paymentMethod,
            notes: notes
        };

        // Check phone verification before booking
        // Nếu số điện thoại vừa được xác thực trong session này và số điện thoại trong form khớp, bỏ qua check
        if (phoneJustVerified && verifiedPhoneNumber && 
            normalizePhoneNumber(phoneNumber) === normalizePhoneNumber(verifiedPhoneNumber)) {
            // Số điện thoại vừa được xác thực → submit luôn
            confirmBtnText.textContent = 'Đang đặt lịch...';
            await submitBooking();
            return;
        }
        
        try {
            if (bookingFor === 'family') {
                // Gọi song song cả 2 API để tối ưu thời gian
                const [userStatusResponse, familyStatusResponse] = await Promise.all([
                    fetch('/api/phone/verification-status', { credentials: 'include' }),
                    fetch(`/api/phone/verification-status/family-member/${bookedForUserId}`, { credentials: 'include' })
                ]);
                
                let userPhoneVerified = false;
                let userPhoneNumber = null;
                
                if (userStatusResponse.ok) {
                    const userStatus = await userStatusResponse.json();
                    userPhoneVerified = userStatus.verified;
                    userPhoneNumber = userStatus.phoneNumber;
                    
                    // Kiểm tra số điện thoại trong form có trùng với số của user đã xác thực không
                    if (userPhoneVerified && userPhoneNumber && 
                        normalizePhoneNumber(userPhoneNumber) === normalizePhoneNumber(phoneNumber)) {
                        // Số điện thoại trùng với số của user đã xác thực → không cần xác thực lại
                        confirmBtnText.textContent = 'Đang đặt lịch...';
                        await submitBooking();
                        return;
                    }
                }
                
                // Kiểm tra số điện thoại của family member
                if (familyStatusResponse.ok) {
                    const status = await familyStatusResponse.json();
                    // Kiểm tra số điện thoại trong form có khớp với số đã xác thực của family member không
                    if (status.verified && status.phoneNumber && 
                        normalizePhoneNumber(status.phoneNumber) === normalizePhoneNumber(phoneNumber)) {
                        // Số điện thoại đã được xác thực cho family member
                        confirmBtnText.textContent = 'Đang đặt lịch...';
                        await submitBooking();
                        return;
                    }
                }
                
                // Cần xác thực số điện thoại cho family member
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
                confirmBtnSpinner.classList.add('hidden');
                currentVerificationType = 'family';
                currentVerificationId = parseInt(bookedForUserId);
                // Set phone number in modal
                document.getElementById('phoneNumberInput').value = phoneNumber;
                openPhoneVerificationModal();
                return;
            } else {
                // Check user phone verification
                console.log('[DEBUG] confirmBooking: Kiểm tra xác thực số điện thoại cho user');
                console.log('[DEBUG] confirmBooking: Số điện thoại trong form:', phoneNumber);
                const statusResponse = await fetch('/api/phone/verification-status', {
                    credentials: 'include'
                });
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    console.log('[DEBUG] confirmBooking: API response:', status);
                    
                    // Kiểm tra số trong form có khớp với số đã xác thực trong database không
                    if (status.verified && status.phoneNumber) {
                        const normalizedStatusPhone = normalizePhoneNumber(status.phoneNumber);
                        const normalizedFormPhone = normalizePhoneNumber(phoneNumber);
                        
                        // Nếu số trong form khớp với số đã xác thực trong database → cho phép submit
                        if (normalizedStatusPhone === normalizedFormPhone) {
                            console.log('[DEBUG] confirmBooking: Số trong form khớp với số đã verified trong database, submit luôn');
                            confirmBtnText.textContent = 'Đang đặt lịch...';
                            await submitBooking();
                            return;
                        } else {
                            console.log('[DEBUG] confirmBooking: Số trong form khác với số đã verified trong database, cần xác thực');
                        }
                    } else {
                        console.log('[DEBUG] confirmBooking: Số điện thoại trong database chưa được xác thực hoặc không có số');
                    }
                } else {
                    console.error('[DEBUG] confirmBooking: API response không OK:', statusResponse.status);
                }
                
                // Need to verify user phone
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
                confirmBtnSpinner.classList.add('hidden');
                currentVerificationType = 'user';
                currentVerificationId = null; // Will get from API
                // Set phone number in modal
                document.getElementById('phoneNumberInput').value = phoneNumber;
                openPhoneVerificationModal();
                return;
            }
        } catch (error) {
            console.error('Error checking phone verification:', error);
            confirmBtn.disabled = false;
            confirmBtnText.textContent = 'Xác nhận đặt lịch';
            confirmBtnSpinner.classList.add('hidden');
            // Try to book anyway, let backend handle validation
            confirmBtnText.textContent = 'Đang đặt lịch...';
            await submitBooking();
        }
    });

    // Submit booking after phone verification
    async function submitBooking() {
        if (!pendingBookingData) {
            // Re-enable button nếu không có pendingBookingData
            const confirmBtn = document.getElementById('confirmBookingBtn');
            const confirmBtnText = document.getElementById('confirmBookingBtnText');
            const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
                confirmBtnSpinner.classList.add('hidden');
            }
            return;
        }

        try {
            const response = await fetch('/api/appointments/book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(pendingBookingData)
            });

            const result = await response.json();

            if (response.ok) {
                // Check payment method
                if (pendingBookingData.paymentMethod === 'VNPAY' && result.appointmentId) {
                    // Redirect to VNPay
                    try {
                        const paymentResponse = await fetch('/api/payment/create-vnpay-url', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({ appointmentId: result.appointmentId })
                        });
                        
                        const paymentResult = await paymentResponse.json();
                        
                        if (paymentResponse.ok && paymentResult.paymentUrl) {
                            // Reset phone verification state trước khi redirect
                            resetPhoneVerificationState();
                            // Redirect to VNPay
                            window.location.href = paymentResult.paymentUrl;
                            return;
                        } else {
                            showMessage('Không thể tạo link thanh toán VNPay. Vui lòng thử lại.', 'error');
                        }
                    } catch (error) {
                        console.error('Error creating VNPay URL:', error);
                        showMessage('Có lỗi xảy ra khi tạo link thanh toán. Vui lòng thử lại.', 'error');
                    }
                } else {
                    // Cash payment - show success message
                    let successMessage = `Đặt lịch thành công! Mã đặt lịch: ${result.bookingCode}`;
                    
                    // Hiển thị cảnh báo cùng ngày nếu có
                    if (result.warning) {
                        successMessage += `\n\n⚠️ ${result.warning}`;
                        // Hiển thị cảnh báo dạng alert để user chú ý
                        alert(result.warning);
                    }
                    
                    showMessage(successMessage, 'success');
                    document.getElementById('bookingModal').classList.add('hidden');
                    // Reset phone verification state
                    resetPhoneVerificationState();
                    // Reload slots
                    await loadAvailableSlots();
                    pendingBookingData = null;
                }
            } else {
                // Re-enable button khi có lỗi
                const confirmBtn = document.getElementById('confirmBookingBtn');
                const confirmBtnText = document.getElementById('confirmBookingBtnText');
                const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtnText.textContent = 'Xác nhận đặt lịch';
                    confirmBtnSpinner.classList.add('hidden');
                }
                
                // Hiển thị thông báo lỗi chi tiết
                const errorMessage = result.error || 'Có lỗi xảy ra khi đặt lịch';
                showMessage(errorMessage, 'error');
                
                // Nếu là lỗi phone verification, mở modal verification
                if (errorMessage.includes('xác thực số điện thoại') || errorMessage.includes('Số điện thoại')) {
                    if (pendingBookingData.bookedForUserId) {
                        currentVerificationType = 'family';
                        currentVerificationId = pendingBookingData.bookedForUserId;
                    } else {
                        currentVerificationType = 'user';
                        currentVerificationId = null;
                    }
                    openPhoneVerificationModal();
                }
                
                // Nếu là lỗi trùng lịch, có thể đóng modal và reload slots
                if (errorMessage.includes('đã có lịch hẹn')) {
                    setTimeout(() => {
                        document.getElementById('bookingModal').classList.add('hidden');
                        loadAvailableSlots(); // Reload để cập nhật trạng thái
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('Error booking appointment:', error);
            showMessage('Có lỗi xảy ra khi đặt lịch', 'error');
            
            // Re-enable button khi có lỗi
            const confirmBtn = document.getElementById('confirmBookingBtn');
            const confirmBtnText = document.getElementById('confirmBookingBtnText');
            const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
                confirmBtnSpinner.classList.add('hidden');
            }
        }
    }

    // Phone Verification Modal Functions
    function openPhoneVerificationModal() {
        // Reset state trước tiên
        resetPhoneVerificationState();
        
        document.getElementById('phoneVerificationModal').classList.remove('hidden');
        document.getElementById('phoneNumberStep').classList.remove('hidden');
        document.getElementById('verificationCodeStep').classList.add('hidden');
        
        // Giữ số điện thoại từ form đặt lịch (đã được set trước đó)
        if (!document.getElementById('phoneNumberInput').value) {
            document.getElementById('phoneNumberInput').value = document.getElementById('bookingPhoneNumber').value;
        }
        document.getElementById('verificationCodeInput').focus();
    }

    function closePhoneVerificationModal() {
        document.getElementById('phoneVerificationModal').classList.add('hidden');
        // Reset state khi đóng modal
        resetPhoneVerificationState();
    }

    // Send verification code
    document.getElementById('sendCodeBtn').addEventListener('click', async () => {
        // Lấy số điện thoại từ modal hoặc từ form đặt lịch
        let phoneNumber = document.getElementById('phoneNumberInput').value.trim();
        if (!phoneNumber) {
            // Nếu modal không có, lấy từ form đặt lịch
            phoneNumber = document.getElementById('bookingPhoneNumber').value.trim();
        }
        
        if (!phoneNumber) {
            document.getElementById('phoneError').textContent = 'Vui lòng nhập số điện thoại';
            document.getElementById('phoneError').classList.remove('hidden');
            return;
        }

        // Cập nhật số điện thoại vào form đặt lịch nếu chưa có
        if (!document.getElementById('bookingPhoneNumber').value) {
            document.getElementById('bookingPhoneNumber').value = phoneNumber;
        }

        try {
            const endpoint = currentVerificationType === 'family' 
                ? `/api/phone/request-verification/family-member/${currentVerificationId}`
                : '/api/phone/request-verification';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ phoneNumber: phoneNumber })
            });

            const result = await response.json();

            if (response.ok) {
                // Show verification code step
                document.getElementById('phoneNumberStep').classList.add('hidden');
                document.getElementById('verificationCodeStep').classList.remove('hidden');
                document.getElementById('phoneNumberDisplay').textContent = phoneNumber;
                document.getElementById('verificationCodeInput').focus();
                
                // Start countdown timer (5 minutes)
                startCountdown(300);
            } else {
                document.getElementById('phoneError').textContent = result.error || 'Không thể gửi mã xác thực';
                document.getElementById('phoneError').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error sending verification code:', error);
            document.getElementById('phoneError').textContent = 'Có lỗi xảy ra. Vui lòng thử lại.';
            document.getElementById('phoneError').classList.remove('hidden');
        }
    });

    // Verify code
    document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
        const code = document.getElementById('verificationCodeInput').value.trim();
        if (!code || code.length !== 6) {
            document.getElementById('codeError').textContent = 'Vui lòng nhập đầy đủ 6 số';
            document.getElementById('codeError').classList.remove('hidden');
            return;
        }

        try {
            const endpoint = currentVerificationType === 'family'
                ? `/api/phone/verify/family-member/${currentVerificationId}`
                : '/api/phone/verify';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ code: code })
            });

            const result = await response.json();

            if (response.ok && result.verified) {
                showMessage('Xác thực số điện thoại thành công!', 'success');
                closePhoneVerificationModal();
                
                // Hiển thị loading state trên nút "Xác nhận đặt lịch"
                const confirmBtn = document.getElementById('confirmBookingBtn');
                const confirmBtnText = document.getElementById('confirmBookingBtnText');
                const confirmBtnSpinner = document.getElementById('confirmBookingBtnSpinner');
                confirmBtn.disabled = true;
                confirmBtnText.textContent = 'Đang xử lý...';
                confirmBtnSpinner.classList.remove('hidden');
                
                // Cập nhật số điện thoại vào form đặt lịch từ số đã xác thực
                let verifiedPhone = document.getElementById('phoneNumberDisplay').textContent;
                
                // Nếu là xác thực cho user, reload user info để lấy số điện thoại đã được normalize
                if (currentVerificationType === 'user') {
                    // Giảm delay xuống 100ms vì backend đã lưu trong transaction
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    const userStatusResponse = await fetch('/api/phone/verification-status', {
                        credentials: 'include'
                    });
                    if (userStatusResponse.ok) {
                        const userStatus = await userStatusResponse.json();
                        if (userStatus.verified && userStatus.phoneNumber) {
                            verifiedPhone = userStatus.phoneNumber;
                        }
                    }
                } else if (currentVerificationType === 'family') {
                    // Giảm delay xuống 100ms vì backend đã lưu trong transaction
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // Refresh family member data (số điện thoại đã được lưu vào database)
                    const familyStatusResponse = await fetch(`/api/phone/verification-status/family-member/${currentVerificationId}`, {
                        credentials: 'include'
                    });
                    if (familyStatusResponse.ok) {
                        const familyStatus = await familyStatusResponse.json();
                        if (familyStatus.verified && familyStatus.phoneNumber) {
                            verifiedPhone = familyStatus.phoneNumber;
                        }
                    }
                }
                
                // Cập nhật số điện thoại vào form đặt lịch
                document.getElementById('bookingPhoneNumber').value = verifiedPhone;
                
                // Cập nhật số điện thoại trong pendingBookingData để đảm bảo số đã xác thực được gửi lên server
                if (pendingBookingData) {
                    pendingBookingData.phoneNumber = verifiedPhone;
                }
                
                // Đánh dấu số điện thoại vừa được xác thực và lưu số điện thoại đã xác thực
                phoneJustVerified = true;
                verifiedPhoneNumber = verifiedPhone;
                
                // Tắt loading state và enable nút lại
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Xác nhận đặt lịch';
                confirmBtnSpinner.classList.add('hidden');
                
                showMessage('Số điện thoại đã được xác thực. Vui lòng nhấn "Xác nhận đặt lịch" để hoàn tất.', 'success');
            } else {
                document.getElementById('codeError').textContent = result.error || 'Mã xác thực không đúng hoặc đã hết hạn';
                document.getElementById('codeError').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error verifying code:', error);
            document.getElementById('codeError').textContent = 'Có lỗi xảy ra. Vui lòng thử lại.';
            document.getElementById('codeError').classList.remove('hidden');
        }
    });

    // Resend code
    document.getElementById('resendCodeBtn').addEventListener('click', () => {
        document.getElementById('sendCodeBtn').click();
    });

    // Countdown timer
    let countdownInterval = null;
    function startCountdown(seconds) {
        let remaining = seconds;
        const timerElement = document.getElementById('countdownTimer');
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        countdownInterval = setInterval(() => {
            const minutes = Math.floor(remaining / 60);
            const secs = remaining % 60;
            timerElement.textContent = `Mã có hiệu lực trong ${minutes}:${String(secs).padStart(2, '0')}`;
            
            if (remaining <= 0) {
                clearInterval(countdownInterval);
                timerElement.textContent = 'Mã đã hết hạn. Vui lòng gửi lại mã.';
                timerElement.classList.add('text-red-600');
            }
            remaining--;
        }, 1000);
    }
    
    // Reset phone verification state - GIẢI PHÁP cho lỗi đặt lịch
    function resetPhoneVerificationState() {
        // Reset flags
        phoneJustVerified = false;
        verifiedPhoneNumber = null;
        
        // Clear countdown interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        
        // Reset modal UI
        const phoneInput = document.getElementById('phoneNumberInput');
        const codeInput = document.getElementById('verificationCodeInput');
        const phoneError = document.getElementById('phoneError');
        const codeError = document.getElementById('codeError');
        const timerElement = document.getElementById('countdownTimer');
        const phoneNumberStep = document.getElementById('phoneNumberStep');
        const verificationCodeStep = document.getElementById('verificationCodeStep');
        
        if (phoneInput) phoneInput.value = '';
        if (codeInput) codeInput.value = '';
        if (phoneError) {
            phoneError.textContent = '';
            phoneError.classList.add('hidden');
        }
        if (codeError) {
            codeError.textContent = '';
            codeError.classList.add('hidden');
        }
        if (timerElement) {
            timerElement.textContent = '';
            timerElement.classList.remove('text-red-600');
        }
        
        // Reset modal step
        if (phoneNumberStep) phoneNumberStep.classList.remove('hidden');
        if (verificationCodeStep) verificationCodeStep.classList.add('hidden');
    }

    // Close phone verification modal
    document.getElementById('closePhoneModalBtn').addEventListener('click', () => {
        closePhoneVerificationModal();
    });

    // Auto-focus and format verification code input
    document.getElementById('verificationCodeInput')?.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        if (e.target.value.length === 6) {
            // Auto submit when 6 digits entered
            document.getElementById('verifyCodeBtn').click();
        }
    });

    // Close modal
    document.getElementById('closeModalBtn').addEventListener('click', () => {
        document.getElementById('bookingModal').classList.add('hidden');
    });

    document.getElementById('cancelBookingBtn').addEventListener('click', () => {
        document.getElementById('bookingModal').classList.add('hidden');
    });

    // Show message
    function showMessage(message, type) {
        const messageDiv = document.getElementById('messageDiv');
        messageDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg max-w-md ${
            type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'
        }`;
        messageDiv.textContent = message;
        messageDiv.classList.remove('hidden');
        setTimeout(() => {
            messageDiv.classList.add('hidden');
        }, 5000);
    }

    // Event listeners
    document.getElementById('loadSlotsBtn').addEventListener('click', loadAvailableSlots);
    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('vaccineSelect').value = '';
        document.getElementById('centerSelect').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        document.getElementById('scheduleTableBody').innerHTML = '<tr><td colspan="4" class="text-center py-8 text-[#61896f]">Vui lòng chọn vaccine, trung tâm và khoảng thời gian để xem các slot trống</td></tr>';
    });

    // Load centers when vaccine changes
    document.getElementById('vaccineSelect').addEventListener('change', async (e) => {
        const vaccineId = e.target.value;
        if (vaccineId) {
            await loadCentersForVaccine(vaccineId);
        } else {
            await loadCenters();
        }
    });

    // Normalize phone number (loại bỏ khoảng trắng, dấu gạch ngang)
    function normalizePhoneNumber(phoneNumber) {
        if (!phoneNumber) return '';
        return phoneNumber.replace(/[\s\-\(\)]/g, '').trim();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([
            loadVaccines(),
            loadCenters(),
            loadFamilyMembers()
        ]);
        
        // Nếu có familyMemberId trong URL, tự động chọn "Người thân" và chọn family member
        if (selectedFamilyMemberId) {
            // Chọn radio button "Người thân"
            const familyRadio = document.querySelector('input[name="bookingFor"][value="family"]');
            if (familyRadio) {
                familyRadio.checked = true;
                document.getElementById('familyMemberSelect').classList.remove('hidden');
                
                // Đợi một chút để dropdown được populate
                setTimeout(() => {
                    const select = document.getElementById('bookedForUserId');
                    if (select) {
                        select.value = selectedFamilyMemberId;
                        selectedBookingForUserId = selectedFamilyMemberId;
                    }
                }, 500);
            }
        }
    });
    
    // Load số lượng thông báo chưa đọc
    async function loadUnreadNotificationCount() {
        try {
            const response = await fetch('/api/notifications/unread-count');
            if (response.ok) {
                const data = await response.json();
                
                // Update sidebar badge
                const sidebarBadge = document.getElementById('notificationBadge');
                if (sidebarBadge) {
                    if (data.count > 0) {
                        sidebarBadge.textContent = data.count > 99 ? '99+' : data.count;
                        sidebarBadge.classList.remove('hidden');
                    } else {
                        sidebarBadge.classList.add('hidden');
                    }
                }
                
                // Update header badge
                const headerBadge = document.getElementById('headerNotificationBadge');
                if (headerBadge) {
                    if (data.count > 0) {
                        headerBadge.textContent = data.count > 99 ? '99+' : data.count;
                        headerBadge.classList.remove('hidden');
                    } else {
                        headerBadge.classList.add('hidden');
                    }
                }
            }
        } catch (error) {
            console.error('Error loading unread count:', error);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadUnreadNotificationCount();
        setInterval(loadUnreadNotificationCount, 30000);
    });
</script>
</body>
</html>


