<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hồ sơ Y tá - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="/js/sidebar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f766e",
                        "primary-light": "#14b8a6",
                        "primary-dark": "#134e4a",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .active-nav {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
            border-left: 4px solid #0f766e;
            color: #0f766e;
        }

        .sidebar-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-nav-item:hover {
            transform: translateX(4px);
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white font-display">
    <div class="flex min-h-screen">
        <!-- Sidebar Overlay (mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>

        <!-- Sidebar -->
        <div th:replace="~{fragments/nurse-sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 flex flex-col min-h-screen">
            <header
                class="sticky top-0 z-50 bg-gradient-to-r from-primary/10 via-primary/5 to-white/90 dark:from-primary/20 dark:via-primary/10 dark:to-[#102216]/90 backdrop-blur-xl border-b border-primary/20 dark:border-primary/30 px-8 py-6 transition-all">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="size-12 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-white text-2xl">person</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-[#111813] dark:text-white">Hồ sơ cá nhân</h2>
                            <p class="text-sm text-[#61896f] mt-1">Quản lý thông tin tài khoản của bạn</p>
                        </div>
                    </div>
                    <div>
                        <a href="/nurse/dashboard"
                            class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-primary/20 hover:scale-105 active:scale-95">
                            <span class="material-symbols-outlined">arrow_back</span>
                            <span>Quay lại Dashboard</span>
                        </a>
                    </div>
                </div>
            </header>

            <div class="p-4 lg:p-8 space-y-6 w-full">
                <!-- Thông báo lỗi -->
                <div id="errorMessage"
                    class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-300 text-sm">
                    <span id="errorText"></span>
                </div>

                <!-- Thông báo thành công -->
                <div id="successMessage"
                    class="hidden p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl text-green-700 dark:text-green-300 text-sm">
                    <span id="successText"></span>
                </div>

                <!-- Profile Header Section -->
                <div
                    class="bg-gradient-to-r from-primary via-primary-light to-primary-dark rounded-2xl p-6 lg:p-8 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
                    <div class="relative z-10">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center gap-6">
                            <!-- Avatar -->
                            <div class="relative">
                                <div id="avatarContainer"
                                    class="size-24 lg:size-32 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-4xl lg:text-5xl font-bold border-4 border-white/30 shadow-lg">
                                    <span id="avatarInitial"
                                        th:text="${currentUser?.fullName != null ? #strings.substring(currentUser.fullName, 0, 1) : #strings.substring(currentUser?.email, 0, 1)}">H</span>
                                </div>
                            </div>

                            <!-- User Info -->
                            <div class="flex-1">
                                <div class="flex flex-col lg:flex-row lg:items-center gap-3 lg:gap-4 mb-2">
                                    <h1 id="profileUserName" class="text-2xl lg:text-3xl font-bold"
                                        th:text="${currentUser?.fullName ?: currentUser?.email}">Tên người dùng</h1>
                                    <div class="flex items-center gap-2">
                                        <span id="verifiedBadge"
                                            class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold flex items-center gap-1"
                                            th:if="${currentUser?.phoneVerified != null && currentUser.phoneVerified}">
                                            <span class="material-symbols-outlined text-sm">check_circle</span>
                                            ĐÃ XÁC MINH
                                        </span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-4 text-white/80 text-sm">
                                    <span>Y tá</span>
                                    <span th:if="${staffInfo?.employeeId != null}"
                                        th:text="'Mã NV: ' + ${staffInfo.employeeId}"></span>
                                    <span th:if="${staffInfo?.center != null}"
                                        th:text="'Trung tâm: ' + ${staffInfo.center.name}"></span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-3 w-full lg:w-auto">
                                <button id="editProfileBtn"
                                    class="flex-1 lg:flex-none bg-white hover:bg-white/90 text-primary px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <span class="material-symbols-outlined">edit</span>
                                    <span>Cập nhật hồ sơ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Sidebar: Staff Info -->
                    <div class="lg:col-span-1 space-y-6">
                        <div
                            class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border border-[#f0f4f2] dark:border-[#2d3f33] p-6">
                            <h3 class="text-lg font-bold text-[#111813] dark:text-white mb-4">Thông tin nhân viên</h3>

                            <!-- Stats Cards -->
                            <div class="space-y-3 mb-6">
                                <!-- Mã nhân viên -->
                                <div
                                    class="flex items-center justify-between p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">badge</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-blue-400 font-medium">MÃ NHÂN
                                                VIÊN</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white"
                                                th:text="${staffInfo?.employeeId ?: 'Chưa có'}">-</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trung tâm -->
                                <div
                                    class="flex items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-green-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">location_on</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-green-400 font-medium">TRUNG TÂM
                                            </p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white"
                                                th:text="${staffInfo?.center?.name ?: 'Chưa gán'}">-</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ngày vào làm -->
                                <div
                                    class="flex items-center justify-between p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl border border-orange-200 dark:border-orange-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-orange-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">calendar_today</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-orange-400 font-medium">NGÀY VÀO
                                                LÀM</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white"
                                                th:if="${staffInfo?.hireDate != null}"
                                                th:text="${#temporals.format(staffInfo.hireDate, 'dd/MM/yyyy')}">-</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white"
                                                th:if="${staffInfo?.hireDate == null}">Chưa có</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Profile Completion -->
                            <div class="pt-6 border-t border-[#f0f4f2] dark:border-[#2d3f33]">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-[#111813] dark:text-white">Độ hoàn thiện hồ
                                        sơ</span>
                                    <span id="completionPercentage" class="text-sm font-bold text-primary">0%</span>
                                </div>
                                <div class="w-full bg-[#f0f4f2] dark:bg-[#2d3f33] rounded-full h-3 mb-3">
                                    <div id="completionBar"
                                        class="bg-gradient-to-r from-primary to-primary-light h-3 rounded-full transition-all duration-500"
                                        style="width: 0%"></div>
                                </div>
                                <p id="completionHint" class="text-xs text-[#61896f]">Cập nhật thông tin để hoàn thiện
                                    hồ sơ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Content: Basic Information -->
                    <div class="lg:col-span-2">
                        <!-- View Mode -->
                        <div id="viewInfoSection"
                            class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border border-[#f0f4f2] dark:border-[#2d3f33] p-6 lg:p-8 h-full">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-[#111813] dark:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">info</span>
                                    Thông tin cơ bản
                                </h3>
                                <span class="text-xs text-[#61896f] hidden lg:inline uppercase">Chi tiết hồ sơ</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Họ và tên -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">badge</span>
                                        Họ và tên
                                    </label>
                                    <p id="viewFullName"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.fullName ?: 'Chưa cập nhật'}"></p>
                                </div>

                                <!-- Email -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">email</span>
                                        Email
                                    </label>
                                    <p id="viewEmail"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.email}"></p>
                                </div>

                                <!-- Số điện thoại -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">phone</span>
                                        Số điện thoại
                                    </label>
                                    <p id="viewPhoneNumber"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.phoneNumber ?: 'Chưa cập nhật'}"></p>
                                </div>

                                <!-- Ngày sinh -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">cake</span>
                                        Ngày sinh
                                    </label>
                                    <p id="viewDayOfBirth"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.dayOfBirth != null ? #temporals.format(currentUser.dayOfBirth, 'dd/MM/yyyy') : 'Chưa cập nhật'}">
                                    </p>
                                </div>

                                <!-- Giới tính -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">wc</span>
                                        Giới tính
                                    </label>
                                    <p id="viewGender"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.gender != null ? (currentUser.gender.name() == 'MALE' ? 'Nam' : (currentUser.gender.name() == 'FEMALE' ? 'Nữ' : 'Khác')) : 'Chưa cập nhật'}">
                                    </p>
                                </div>

                                <!-- Số CMND/CCCD -->
                                <div class="space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">badge</span>
                                        Số CMND/CCCD
                                    </label>
                                    <p id="viewCitizenId"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium"
                                        th:text="${currentUser?.citizenId ?: 'Chưa cập nhật'}"></p>
                                </div>

                                <!-- Địa chỉ -->
                                <div class="md:col-span-2 space-y-2">
                                    <label
                                        class="text-xs font-semibold text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">home</span>
                                        Địa chỉ
                                    </label>
                                    <p id="viewAddress"
                                        class="px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-50/50 dark:bg-[#1a2e21] text-[#111813] dark:text-white font-medium min-h-[80px]"
                                        th:text="${currentUser?.address ?: 'Chưa cập nhật'}"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Form Section (Ẩn mặc định) -->
                        <div id="editFormSection"
                            class="hidden bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border-2 border-primary/20 p-6 lg:p-8 relative overflow-hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-[#111813] dark:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">edit_square</span>
                                    Chỉnh sửa thông tin
                                </h3>
                            </div>

                            <form id="profileForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Họ và tên -->
                                    <div class="space-y-2">
                                        <label for="fullName"
                                            class="text-xs font-bold text-[#61896f] uppercase flex items-center gap-2">
                                            Họ và tên <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="fullName" name="fullName" required
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                            th:value="${currentUser?.fullName}">
                                    </div>

                                    <!-- Email (readonly) -->
                                    <div class="space-y-2">
                                        <label
                                            class="text-xs font-bold text-[#61896f] uppercase flex items-center gap-2">
                                            Email (Cố định)
                                        </label>
                                        <input type="email" id="email" readonly
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-gray-100 dark:bg-[#102216] text-[#61896f] cursor-not-allowed"
                                            th:value="${currentUser?.email}">
                                    </div>

                                    <!-- Số điện thoại -->
                                    <div class="space-y-2">
                                        <label for="phoneNumber" class="text-xs font-bold text-[#61896f] uppercase">Số
                                            điện thoại</label>
                                        <input type="tel" id="phoneNumber" name="phoneNumber"
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                            th:value="${currentUser?.phoneNumber}">
                                    </div>

                                    <!-- Ngày sinh -->
                                    <div class="space-y-2">
                                        <label for="dayOfBirth" class="text-xs font-bold text-[#61896f] uppercase">Ngày
                                            sinh</label>
                                        <input type="date" id="dayOfBirth" name="dayOfBirth"
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                            th:value="${currentUser?.dayOfBirth}">
                                    </div>

                                    <!-- Giới tính -->
                                    <div class="space-y-2">
                                        <label for="gender" class="text-xs font-bold text-[#61896f] uppercase">Giới
                                            tính</label>
                                        <select id="gender" name="gender"
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white">
                                            <option value="">Chọn</option>
                                            <option value="MALE" th:selected="${currentUser?.gender?.name() == 'MALE'}">
                                                Nam</option>
                                            <option value="FEMALE"
                                                th:selected="${currentUser?.gender?.name() == 'FEMALE'}">Nữ</option>
                                            <option value="OTHER"
                                                th:selected="${currentUser?.gender?.name() == 'OTHER'}">Khác</option>
                                        </select>
                                    </div>

                                    <!-- Số CMND/CCCD -->
                                    <div class="space-y-2">
                                        <label for="citizenId" class="text-xs font-bold text-[#61896f] uppercase">Số
                                            CMND/CCCD</label>
                                        <input type="text" id="citizenId" name="citizenId"
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                            th:value="${currentUser?.citizenId}">
                                    </div>

                                    <!-- Địa chỉ -->
                                    <div class="md:col-span-2 space-y-2">
                                        <label for="address" class="text-xs font-bold text-[#61896f] uppercase">Địa chỉ
                                            thường trú</label>
                                        <textarea id="address" name="address" rows="3"
                                            class="w-full px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white resize-none"
                                            th:text="${currentUser?.address}"></textarea>
                                    </div>
                                </div>

                                <!-- Buttons -->
                                <div class="flex gap-4 pt-6 border-t border-gray-100">
                                    <button type="submit" id="saveBtn"
                                        class="flex-1 bg-primary hover:bg-primary-dark text-white px-8 py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-95">
                                        <span class="material-symbols-outlined">save</span>
                                        <span id="saveBtnText">Lưu thay đổi</span>
                                        <span id="saveBtnSpinner" class="hidden animate-spin">
                                            <svg class="h-5 w-5" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                    stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                                </path>
                                            </svg>
                                        </span>
                                    </button>
                                    <button type="button" id="cancelBtn"
                                        class="px-8 py-4 rounded-xl font-bold border-2 border-gray-200 text-gray-500 hover:bg-gray-50 transition-all flex items-center gap-2">
                                        <span class="material-symbols-outlined">close</span>
                                        Hủy
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>


            </div>
        </main>
    </div>

    <script>
        // Calculate profile completion percentage
        function calculateProfileCompletion() {
            const fields = [
                document.getElementById('viewFullName')?.textContent || '',
                document.getElementById('viewEmail')?.textContent || '',
                document.getElementById('viewPhoneNumber')?.textContent || '',
                document.getElementById('viewDayOfBirth')?.textContent || '',
                document.getElementById('viewGender')?.textContent || '',
                document.getElementById('viewCitizenId')?.textContent || '',
                document.getElementById('viewAddress')?.textContent || ''
            ];

            const filledFields = fields.filter(f => f && f.trim() !== '' && f !== 'Chưa cập nhật').length;
            const totalFields = fields.length;
            const percentage = Math.round((filledFields / totalFields) * 100);

            const completionPercentageEl = document.getElementById('completionPercentage');
            const completionBarEl = document.getElementById('completionBar');
            if (completionPercentageEl) completionPercentageEl.textContent = percentage + '%';
            if (completionBarEl) completionBarEl.style.width = percentage + '%';

            // Update hint
            const hint = document.getElementById('completionHint');
            if (hint) {
                if (percentage < 50) {
                    hint.textContent = 'Cập nhật thông tin để hoàn thiện hồ sơ';
                } else if (percentage < 100) {
                    hint.textContent = 'Cập nhật thêm thông tin để nhận được dịch vụ tốt nhất';
                } else {
                    hint.textContent = 'Hồ sơ đã hoàn thiện!';
                }
            }
        }

        // Hàm format ngày tháng từ YYYY-MM-DD sang DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm cập nhật phần view với dữ liệu mới
        function updateViewSection(data) {
            // Cập nhật text content cho các trường
            const updateField = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || 'Chưa cập nhật';
            };

            updateField('viewFullName', data.fullName);
            updateField('viewEmail', data.email);
            updateField('viewPhoneNumber', data.phoneNumber);
            updateField('viewCitizenId', data.citizenId);
            updateField('viewAddress', data.address);

            // Cập nhật Ngày sinh (format)
            const viewDayOfBirth = document.getElementById('viewDayOfBirth');
            if (viewDayOfBirth) {
                viewDayOfBirth.textContent = data.dayOfBirth ? formatDate(data.dayOfBirth) : 'Chưa cập nhật';
            }

            // Cập nhật Giới tính
            const viewGender = document.getElementById('viewGender');
            if (viewGender) {
                let genderText = 'Chưa cập nhật';
                if (data.gender === 'MALE') genderText = 'Nam';
                else if (data.gender === 'FEMALE') genderText = 'Nữ';
                else if (data.gender === 'OTHER') genderText = 'Khác';
                viewGender.textContent = genderText;
            }

            // Cập nhật Header và Avatar
            const avatarInitial = document.getElementById('avatarInitial');
            const profileUserName = document.getElementById('profileUserName');
            if (data.fullName) {
                if (avatarInitial) avatarInitial.textContent = data.fullName.substring(0, 1).toUpperCase();
                if (profileUserName) profileUserName.textContent = data.fullName;
            }
        }

        // Calculate completion on page load
        document.addEventListener('DOMContentLoaded', function () {
            calculateProfileCompletion();
        });

        // Nút Chỉnh sửa - Chuyển từ chế độ xem sang chế độ chỉnh sửa
        document.getElementById('editProfileBtn').addEventListener('click', function () {
            // Ẩn phần xem thông tin
            document.getElementById('viewInfoSection').classList.add('hidden');
            // Hiển thị phần form chỉnh sửa
            document.getElementById('editFormSection').classList.remove('hidden');
        });

        // Nút Hủy - Quay về chế độ xem
        document.getElementById('cancelBtn').addEventListener('click', function () {
            // Ẩn phần form chỉnh sửa
            document.getElementById('editFormSection').classList.add('hidden');
            // Hiển thị phần xem thông tin
            document.getElementById('viewInfoSection').classList.remove('hidden');

            // Ẩn thông báo lỗi nếu có
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        });

        // Submit form
        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const saveBtn = document.getElementById('saveBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtnSpinner = document.getElementById('saveBtnSpinner');

            // Ẩn thông báo cũ
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Hiển thị loading
            saveBtn.disabled = true;
            saveBtnText.textContent = 'Đang lưu...';
            saveBtnSpinner.classList.remove('hidden');

            // Lấy dữ liệu form
            const formData = {
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumber').value || null,
                dayOfBirth: document.getElementById('dayOfBirth').value || null,
                gender: document.getElementById('gender').value || null,
                address: document.getElementById('address').value || null,
                citizenId: document.getElementById('citizenId').value || null
            };

            try {
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    // Thành công
                    successDiv.classList.remove('hidden');
                    document.getElementById('successText').textContent = data.message || 'Cập nhật hồ sơ thành công!';

                    // Cập nhật phần view với dữ liệu mới
                    updateViewSection(data);
                    calculateProfileCompletion();

                    // Chuyển từ form về view sau 1 giây
                    setTimeout(() => {
                        document.getElementById('editFormSection').classList.add('hidden');
                        document.getElementById('viewInfoSection').classList.remove('hidden');
                    }, 1000);
                } else {
                    // Hiển thị lỗi
                    errorDiv.classList.remove('hidden');
                    document.getElementById('errorText').textContent = data.error || 'Cập nhật hồ sơ thất bại. Vui lòng thử lại.';
                }
            } catch (error) {
                errorDiv.classList.remove('hidden');
                document.getElementById('errorText').textContent = 'Có lỗi xảy ra. Vui lòng thử lại sau.';
            } finally {
                // Ẩn loading và enable button
                saveBtn.disabled = false;
                saveBtnText.textContent = 'Lưu thay đổi';
                saveBtnSpinner.classList.add('hidden');
            }
        });
    </script>
</body>

</html>