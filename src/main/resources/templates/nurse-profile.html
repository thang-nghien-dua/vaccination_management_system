<!DOCTYPE html>
<html class="light" lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hồ sơ Y tá - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="/js/sidebar.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f766e",
                        "primary-light": "#14b8a6",
                        "primary-dark": "#134e4a",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .active-nav {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
            border-left: 4px solid #0f766e;
            color: #0f766e;
        }

        .sidebar-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-nav-item:hover {
            transform: translateX(4px);
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(15, 118, 110, 0.05) 100%);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white font-display">
    <div class="flex min-h-screen">
        <!-- Sidebar Overlay (mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>

        <!-- Sidebar -->
        <div th:replace="~{fragments/nurse-sidebar :: sidebar}"></div>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-72 flex flex-col min-h-screen">
            <header
                class="sticky top-0 z-50 bg-gradient-to-r from-primary/10 via-primary/5 to-white/90 dark:from-primary/20 dark:via-primary/10 dark:to-[#102216]/90 backdrop-blur-xl border-b border-primary/20 dark:border-primary/30 px-8 py-6 transition-all">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div
                            class="size-12 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined text-white text-2xl">person</span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-[#111813] dark:text-white">Hồ sơ cá nhân</h2>
                            <p class="text-sm text-[#61896f] mt-1">Quản lý thông tin tài khoản của bạn</p>
                        </div>
                    </div>
                    <div>
                        <a href="/nurse/dashboard"
                            class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-primary/20 hover:scale-105 active:scale-95">
                            <span class="material-symbols-outlined">arrow_back</span>
                            <span>Quay lại Dashboard</span>
                        </a>
                    </div>
                </div>
            </header>

            <div class="p-4 lg:p-8 space-y-6 w-full">
                <!-- Thông báo lỗi -->
                <div id="errorMessage"
                    class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl text-red-700 dark:text-red-300 text-sm">
                    <span id="errorText"></span>
                </div>

                <!-- Thông báo thành công -->
                <div id="successMessage"
                    class="hidden p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-xl text-green-700 dark:text-green-300 text-sm">
                    <span id="successText"></span>
                </div>

                <!-- Profile Header Section -->
                <div class="bg-gradient-to-r from-primary via-primary-light to-primary-dark rounded-2xl p-6 lg:p-8 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
                    <div class="relative z-10">
                        <div class="flex flex-col lg:flex-row items-start lg:items-center gap-6">
                            <!-- Avatar -->
                            <div class="relative">
                                <div id="avatarContainer" class="size-24 lg:size-32 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-4xl lg:text-5xl font-bold border-4 border-white/30 shadow-lg">
                                    <span id="avatarInitial" th:text="${currentUser?.fullName != null ? #strings.substring(currentUser.fullName, 0, 1) : #strings.substring(currentUser?.email, 0, 1)}">H</span>
                                </div>
                            </div>
                            
                            <!-- User Info -->
                            <div class="flex-1">
                                <div class="flex flex-col lg:flex-row lg:items-center gap-3 lg:gap-4 mb-2">
                                    <h1 id="profileUserName" class="text-2xl lg:text-3xl font-bold" th:text="${currentUser?.fullName ?: currentUser?.email}">Tên người dùng</h1>
                                    <div class="flex items-center gap-2">
                                        <span id="verifiedBadge" class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold flex items-center gap-1" th:if="${currentUser?.phoneVerified != null && currentUser.phoneVerified}">
                                            <span class="material-symbols-outlined text-sm">check_circle</span>
                                            ĐÃ XÁC MINH
                                        </span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-4 text-white/80 text-sm">
                                    <span>Y tá</span>
                                    <span th:if="${staffInfo?.employeeId != null}" th:text="'Mã NV: ' + ${staffInfo.employeeId}"></span>
                                    <span th:if="${staffInfo?.center != null}" th:text="'Trung tâm: ' + ${staffInfo.center.name}"></span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3 w-full lg:w-auto">
                                <button id="editProfileBtn" class="flex-1 lg:flex-none bg-white hover:bg-white/90 text-primary px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-xl">
                                    <span class="material-symbols-outlined">edit</span>
                                    <span>Cập nhật hồ sơ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Sidebar: Staff Info -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border border-[#f0f4f2] dark:border-[#2d3f33] p-6">
                            <h3 class="text-lg font-bold text-[#111813] dark:text-white mb-4">Thông tin nhân viên</h3>
                            
                            <!-- Stats Cards -->
                            <div class="space-y-3 mb-6">
                                <!-- Mã nhân viên -->
                                <div class="flex items-center justify-between p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-blue-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">badge</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-blue-400 font-medium">MÃ NHÂN VIÊN</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white" th:text="${staffInfo?.employeeId ?: 'Chưa có'}">-</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Trung tâm -->
                                <div class="flex items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-200 dark:border-green-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-green-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">location_on</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-green-400 font-medium">TRUNG TÂM</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white" th:text="${staffInfo?.center?.name ?: 'Chưa gán'}">-</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Ngày vào làm -->
                                <div class="flex items-center justify-between p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl border border-orange-200 dark:border-orange-800">
                                    <div class="flex items-center gap-3">
                                        <div class="size-10 bg-orange-500 rounded-lg flex items-center justify-center">
                                            <span class="material-symbols-outlined text-white">calendar_today</span>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[#61896f] dark:text-orange-400 font-medium">NGÀY VÀO LÀM</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white" th:if="${staffInfo?.hireDate != null}" th:text="${#temporals.format(staffInfo.hireDate, 'dd/MM/yyyy')}">-</p>
                                            <p class="text-lg font-bold text-[#111813] dark:text-white" th:if="${staffInfo?.hireDate == null}">Chưa có</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Completion -->
                            <div class="pt-6 border-t border-[#f0f4f2] dark:border-[#2d3f33]">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-[#111813] dark:text-white">Độ hoàn thiện hồ sơ</span>
                                    <span id="completionPercentage" class="text-sm font-bold text-primary">0%</span>
                                </div>
                                <div class="w-full bg-[#f0f4f2] dark:bg-[#2d3f33] rounded-full h-3 mb-3">
                                    <div id="completionBar" class="bg-gradient-to-r from-primary to-primary-light h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <p id="completionHint" class="text-xs text-[#61896f]">Cập nhật thông tin để hoàn thiện hồ sơ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Content: Basic Information (same layout as user profile) -->
                    <div class="lg:col-span-2">
                        <!-- View Mode -->
                        <div id="viewInfoSection" class="bg-white dark:bg-[#1a2e21] rounded-2xl shadow-lg border border-[#f0f4f2] dark:border-[#2d3f33] p-6 lg:p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-bold text-[#111813] dark:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">info</span>
                                    Thông tin cơ bản
                                </h3>
                                <span class="text-xs text-[#61896f] hidden lg:inline">CHI TIẾT HỒ SƠ</span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Họ và tên -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">badge</span>
                                        Họ và tên
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="viewFullName" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default"
                                               th:value="${currentUser?.fullName ?: 'Chưa cập nhật'}">
                                        <span class="material-symbols-outlined text-[#61896f]">person</span>
                                    </div>
                                </div>

                                <!-- Email -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">email</span>
                                        Email (Cố định)
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="email" id="viewEmail" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-not-allowed"
                                               th:value="${currentUser?.email}">
                                        <span class="material-symbols-outlined text-blue-500" title="Email không thể thay đổi">lock</span>
                                    </div>
                                </div>

                                <!-- Số điện thoại -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">phone</span>
                                        Số điện thoại
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="tel" id="viewPhoneNumber" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default"
                                               th:value="${currentUser?.phoneNumber ?: ''}"
                                               placeholder="Chưa cập nhật">
                                        <span id="phoneVerifiedIcon" class="material-symbols-outlined text-green-500" th:if="${currentUser?.phoneVerified != null && currentUser.phoneVerified}" title="Đã xác thực">check_circle</span>
                                        <span id="phoneUnverifiedIcon" class="material-symbols-outlined text-gray-400" th:unless="${currentUser?.phoneVerified != null && currentUser.phoneVerified}" title="Chưa xác thực">cancel</span>
                                    </div>
                                </div>

                                <!-- Ngày sinh -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">cake</span>
                                        Ngày sinh
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="viewDayOfBirth" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default"
                                               th:value="${currentUser?.dayOfBirth != null ? #temporals.format(currentUser.dayOfBirth, 'dd/MM/yyyy') : 'Chưa cập nhật'}">
                                        <span class="material-symbols-outlined text-[#61896f]">calendar_today</span>
                                    </div>
                                </div>

                                <!-- Giới tính -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">wc</span>
                                        Giới tính
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="viewGender" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default"
                                               th:value="${currentUser?.gender != null ? (currentUser.gender.name() == 'MALE' ? 'Nam' : (currentUser.gender.name() == 'FEMALE' ? 'Nữ' : 'Khác')) : 'Chưa cập nhật'}">
                                        <span class="material-symbols-outlined text-[#61896f]">person</span>
                                    </div>
                                </div>

                                <!-- Số CMND/CCCD -->
                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">badge</span>
                                        Số CMND/CCCD
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="viewCitizenId" readonly
                                               class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default"
                                               th:value="${currentUser?.citizenId ?: 'Chưa cập nhật'}">
                                        <span class="material-symbols-outlined text-[#61896f]">credit_card</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Địa chỉ (Full width) -->
                            <div class="mt-6 space-y-2">
                                <label class="text-xs font-semibold text-[#61896f] dark:text-[#61896f] uppercase tracking-wide flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">home</span>
                                    Địa chỉ
                                </label>
                                <div class="flex items-start gap-2">
                                    <textarea id="viewAddress" readonly rows="2"
                                              class="flex-1 px-4 py-3 rounded-xl border-2 border-[#e2e8f0] dark:border-[#2d3f33] bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white cursor-default resize-none"
                                              th:text="${currentUser?.address ?: 'Chưa cập nhật'}"></textarea>
                                    <span class="material-symbols-outlined text-[#61896f] mt-3">location_on</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form Section (Ẩn mặc định) -->
                <div id="editFormSection"
                    class="hidden bg-gradient-to-br from-white via-primary/5 to-white dark:from-[#1a2e21] dark:via-primary/10 dark:to-[#1a2e21] rounded-2xl shadow-xl border-2 border-primary/20 dark:border-primary/30 p-8 relative overflow-hidden">
                    <!-- Decorative elements -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -mr-32 -mt-32">
                    </div>
                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-primary/5 rounded-full blur-3xl -ml-24 -mb-24">
                    </div>

                    <form id="profileForm" class="space-y-6 relative z-10">
                        <!-- Email (readonly) -->
                        <div
                            class="bg-gradient-to-r from-blue-50/50 to-indigo-50/50 dark:from-blue-950/20 dark:to-indigo-950/20 p-5 rounded-xl border border-blue-200/50 dark:border-blue-800/30">
                            <label
                                class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">email</span>
                                Email
                            </label>
                            <div class="relative">
                                <input type="email" id="email" readonly
                                    class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-blue-200 dark:border-blue-800 bg-white/80 dark:bg-[#102216]/80 text-[#111813] dark:text-white cursor-not-allowed"
                                    th:value="${currentUser?.email}">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-blue-500 dark:text-blue-400">lock</span>
                            </div>
                            <p class="mt-2 text-xs text-blue-600 dark:text-blue-400 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">info</span>
                                Email không thể thay đổi
                            </p>
                        </div>

                        <!-- Họ và tên -->
                        <div
                            class="bg-gradient-to-r from-purple-50/50 to-pink-50/50 dark:from-purple-950/20 dark:to-pink-950/20 p-5 rounded-xl border border-purple-200/50 dark:border-purple-800/30">
                            <label for="fullName"
                                class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                <span
                                    class="material-symbols-outlined text-purple-600 dark:text-purple-400">badge</span>
                                Họ và tên <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <input type="text" id="fullName" name="fullName" required
                                    class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-purple-200 dark:border-purple-800 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                    th:value="${currentUser?.fullName}">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-purple-500 dark:text-purple-400">person</span>
                            </div>
                        </div>

                        <!-- Số điện thoại -->
                        <div
                            class="bg-gradient-to-r from-green-50/50 to-emerald-50/50 dark:from-green-950/20 dark:to-emerald-950/20 p-5 rounded-xl border border-green-200/50 dark:border-green-800/30">
                            <label for="phoneNumber"
                                class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400">phone</span>
                                Số điện thoại
                            </label>
                            <div class="relative">
                                <input type="tel" id="phoneNumber" name="phoneNumber"
                                    class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-green-200 dark:border-green-800 focus:border-green-500 focus:ring-2 focus:ring-green-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                    th:value="${currentUser?.phoneNumber}">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-green-500 dark:text-green-400">call</span>
                            </div>
                        </div>

                        <!-- Ngày sinh và Giới tính -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div
                                class="bg-gradient-to-r from-orange-50/50 to-amber-50/50 dark:from-orange-950/20 dark:to-amber-950/20 p-5 rounded-xl border border-orange-200/50 dark:border-orange-800/30">
                                <label for="dayOfBirth"
                                    class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                    <span
                                        class="material-symbols-outlined text-orange-600 dark:text-orange-400">cake</span>
                                    Ngày sinh
                                </label>
                                <div class="relative">
                                    <input type="date" id="dayOfBirth" name="dayOfBirth"
                                        class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-orange-200 dark:border-orange-800 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                        th:value="${currentUser?.dayOfBirth}">
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-orange-500 dark:text-orange-400">calendar_today</span>
                                </div>
                            </div>
                            <div
                                class="bg-gradient-to-r from-cyan-50/50 to-teal-50/50 dark:from-cyan-950/20 dark:to-teal-950/20 p-5 rounded-xl border border-cyan-200/50 dark:border-cyan-800/30">
                                <label for="gender"
                                    class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                    <span class="material-symbols-outlined text-cyan-600 dark:text-cyan-400">wc</span>
                                    Giới tính
                                </label>
                                <div class="relative">
                                    <select id="gender" name="gender"
                                        class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-cyan-200 dark:border-cyan-800 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white appearance-none">
                                        <option value="">Chọn</option>
                                        <option value="MALE" th:selected="${currentUser?.gender?.name() == 'MALE'}">Nam
                                        </option>
                                        <option value="FEMALE" th:selected="${currentUser?.gender?.name() == 'FEMALE'}">
                                            Nữ</option>
                                        <option value="OTHER" th:selected="${currentUser?.gender?.name() == 'OTHER'}">
                                            Khác</option>
                                    </select>
                                    <span
                                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-cyan-500 dark:text-cyan-400 pointer-events-none">person</span>
                                </div>
                            </div>
                        </div>

                        <!-- Địa chỉ -->
                        <div
                            class="bg-gradient-to-r from-indigo-50/50 to-blue-50/50 dark:from-indigo-950/20 dark:to-blue-950/20 p-5 rounded-xl border border-indigo-200/50 dark:border-indigo-800/30">
                            <label for="address"
                                class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                <span class="material-symbols-outlined text-indigo-600 dark:text-indigo-400">home</span>
                                Địa chỉ
                            </label>
                            <div class="relative">
                                <textarea id="address" name="address" rows="3"
                                    class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-indigo-200 dark:border-indigo-800 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white resize-none"
                                    th:text="${currentUser?.address}"></textarea>
                                <span
                                    class="material-symbols-outlined absolute left-3 top-4 text-indigo-500 dark:text-indigo-400">location_on</span>
                            </div>
                        </div>

                        <!-- Số CMND/CCCD -->
                        <div
                            class="bg-gradient-to-r from-teal-50/50 to-cyan-50/50 dark:from-teal-950/20 dark:to-cyan-950/20 p-5 rounded-xl border border-teal-200/50 dark:border-teal-800/30">
                            <label for="citizenId"
                                class="flex items-center gap-2 text-sm font-bold text-[#111813] dark:text-white mb-2">
                                <span class="material-symbols-outlined text-teal-600 dark:text-teal-400">badge</span>
                                Số CMND/CCCD
                            </label>
                            <div class="relative">
                                <input type="text" id="citizenId" name="citizenId"
                                    class="w-full px-4 py-3 pl-10 rounded-xl border-2 border-teal-200 dark:border-teal-800 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 outline-none transition-all bg-white dark:bg-[#1a2e21] text-[#111813] dark:text-white"
                                    th:value="${currentUser?.citizenId}">
                                <span
                                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-teal-500 dark:text-teal-400">credit_card</span>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex gap-4 pt-6 border-t border-primary/20 dark:border-primary/30">
                            <button type="submit" id="saveBtn"
                                class="flex-1 bg-gradient-to-r from-primary to-primary-dark hover:from-primary-dark hover:to-primary text-white px-8 py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                <span class="material-symbols-outlined">save</span>
                                <span id="saveBtnText">Lưu thay đổi</span>
                                <span id="saveBtnSpinner" class="hidden">
                                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none"
                                        viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                </span>
                            </button>
                            <button type="button" id="cancelBtn"
                                class="px-8 py-4 rounded-xl font-bold border-2 border-primary/30 text-primary hover:bg-primary/10 dark:hover:bg-primary/20 transition-all text-center shadow-sm hover:shadow-md">
                                <span class="material-symbols-outlined align-middle mr-2">close</span>
                                Hủy
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Calculate profile completion percentage
        function calculateProfileCompletion() {
            const fields = [
                document.getElementById('viewFullName')?.value || '',
                document.getElementById('viewEmail')?.value || '',
                document.getElementById('viewPhoneNumber')?.value || '',
                document.getElementById('viewDayOfBirth')?.value || '',
                document.getElementById('viewGender')?.value || '',
                document.getElementById('viewCitizenId')?.value || '',
                document.getElementById('viewAddress')?.value || ''
            ];
            
            const filledFields = fields.filter(f => f && f.trim() !== '' && f !== 'Chưa cập nhật').length;
            const totalFields = fields.length;
            const percentage = Math.round((filledFields / totalFields) * 100);
            
            const completionPercentageEl = document.getElementById('completionPercentage');
            const completionBarEl = document.getElementById('completionBar');
            if (completionPercentageEl) completionPercentageEl.textContent = percentage + '%';
            if (completionBarEl) completionBarEl.style.width = percentage + '%';
            
            // Update hint
            const hint = document.getElementById('completionHint');
            if (hint) {
                if (percentage < 50) {
                    hint.textContent = 'Cập nhật thông tin để hoàn thiện hồ sơ';
                } else if (percentage < 100) {
                    hint.textContent = 'Cập nhật thêm thông tin để nhận được dịch vụ tốt nhất';
                } else {
                    hint.textContent = 'Hồ sơ đã hoàn thiện!';
                }
            }
        }
        
        // Hàm format ngày tháng từ YYYY-MM-DD sang DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Hàm cập nhật phần view với dữ liệu mới
        function updateViewSection(data) {
            // Cập nhật Họ và tên
            const viewFullName = document.getElementById('viewFullName');
            if (viewFullName) {
                viewFullName.value = data.fullName || 'Chưa cập nhật';
            }
            
            // Cập nhật Email (nếu backend trả về)
            const viewEmail = document.getElementById('viewEmail');
            if (viewEmail && data.email) {
                viewEmail.value = data.email;
            }
            
            // Cập nhật Số điện thoại
            const viewPhoneNumber = document.getElementById('viewPhoneNumber');
            if (viewPhoneNumber) {
                viewPhoneNumber.value = data.phoneNumber || '';
            }
            
            // Cập nhật Ngày sinh
            const viewDayOfBirth = document.getElementById('viewDayOfBirth');
            if (viewDayOfBirth) {
                if (data.dayOfBirth) {
                    const formattedDate = formatDate(data.dayOfBirth);
                    viewDayOfBirth.value = formattedDate;
                } else {
                    viewDayOfBirth.value = 'Chưa cập nhật';
                }
            }
            
            // Cập nhật Giới tính
            const viewGender = document.getElementById('viewGender');
            if (viewGender) {
                if (data.gender) {
                    if (data.gender === 'MALE') viewGender.value = 'Nam';
                    else if (data.gender === 'FEMALE') viewGender.value = 'Nữ';
                    else if (data.gender === 'OTHER') viewGender.value = 'Khác';
                } else {
                    viewGender.value = 'Chưa cập nhật';
                }
            }
            
            // Cập nhật Địa chỉ
            const viewAddress = document.getElementById('viewAddress');
            if (viewAddress) {
                viewAddress.value = data.address || '';
            }
            
            // Cập nhật Số CMND/CCCD
            const viewCitizenId = document.getElementById('viewCitizenId');
            if (viewCitizenId) {
                viewCitizenId.value = data.citizenId || '';
            }
            
            // Cập nhật avatar và tên hiển thị
            const avatarInitial = document.getElementById('avatarInitial');
            const profileUserName = document.getElementById('profileUserName');
            if (data.fullName && avatarInitial) {
                avatarInitial.textContent = data.fullName.substring(0, 1).toUpperCase();
            }
            if (profileUserName) {
                profileUserName.textContent = data.fullName || data.email || profileUserName.textContent;
            }
        }
        
        // Calculate completion on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculateProfileCompletion();
        });

        // Nút Chỉnh sửa - Chuyển từ chế độ xem sang chế độ chỉnh sửa
        document.getElementById('editProfileBtn').addEventListener('click', function () {
            // Ẩn phần xem thông tin
            document.getElementById('viewInfoSection').classList.add('hidden');
            // Hiển thị phần form chỉnh sửa
            document.getElementById('editFormSection').classList.remove('hidden');
        });

        // Nút Hủy - Quay về chế độ xem
        document.getElementById('cancelBtn').addEventListener('click', function () {
            // Ẩn phần form chỉnh sửa
            document.getElementById('editFormSection').classList.add('hidden');
            // Hiển thị phần xem thông tin
            document.getElementById('viewInfoSection').classList.remove('hidden');

            // Ẩn thông báo lỗi nếu có
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        });

        // Submit form
        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const saveBtn = document.getElementById('saveBtn');
            const saveBtnText = document.getElementById('saveBtnText');
            const saveBtnSpinner = document.getElementById('saveBtnSpinner');

            // Ẩn thông báo cũ
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Hiển thị loading
            saveBtn.disabled = true;
            saveBtnText.textContent = 'Đang lưu...';
            saveBtnSpinner.classList.remove('hidden');

            // Lấy dữ liệu form
            const formData = {
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phoneNumber').value || null,
                dayOfBirth: document.getElementById('dayOfBirth').value || null,
                gender: document.getElementById('gender').value || null,
                address: document.getElementById('address').value || null,
                citizenId: document.getElementById('citizenId').value || null
            };

            try {
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    // Thành công: reload lại trang để đảm bảo định dạng hiển thị (ngày sinh, giới tính, v.v.) đúng theo Thymeleaf
                    successDiv.classList.remove('hidden');
                    document.getElementById('successText').textContent = data.message || 'Cập nhật hồ sơ thành công!';
                    
                    // Reload sau một khoảng ngắn để người dùng kịp thấy thông báo
                    setTimeout(() => {
                        window.location.reload();
                    }, 800);
                } else {
                    // Hiển thị lỗi
                    errorDiv.classList.remove('hidden');
                    document.getElementById('errorText').textContent = data.error || 'Cập nhật hồ sơ thất bại. Vui lòng thử lại.';
                }
            } catch (error) {
                errorDiv.classList.remove('hidden');
                document.getElementById('errorText').textContent = 'Có lỗi xảy ra. Vui lòng thử lại sau.';
            } finally {
                // Ẩn loading và enable button
                saveBtn.disabled = false;
                saveBtnText.textContent = 'Lưu thay đổi';
                saveBtnSpinner.classList.add('hidden');
            }
        });
    </script>
</body>

</html>