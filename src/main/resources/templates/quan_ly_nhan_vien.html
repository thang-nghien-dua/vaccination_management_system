<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Quản lý Nhân viên - VacciCare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec5b",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .tab-active {
            @apply text-primary border-b-2 border-primary;
        }
        .tab-inactive {
            @apply text-[#61896f] border-b-2 border-transparent hover:text-[#111813] dark:hover:text-white transition-all;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#111813] dark:text-white antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto flex flex-col">
            <!-- Breadcrumbs & Header -->
            <header class="bg-white dark:bg-zinc-900 border-b border-zinc-200 dark:border-zinc-800 px-8 py-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <button onclick="closeCenterDetail()"
                            class="p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg transition-colors text-[#61896f] dark:text-zinc-400"
                            title="Quay lại Quản lý Trung tâm">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                        <div class="flex items-center gap-2">
                            <a class="text-[#61896f] dark:text-zinc-400 text-sm font-medium hover:underline"
                                th:href="@{/admin/home}">Hệ thống</a>
                            <span class="text-[#61896f] dark:text-zinc-400 text-sm font-medium">/</span>
                            <a class="text-[#61896f] dark:text-zinc-400 text-sm font-medium hover:underline"
                                th:href="@{/admin/centers}">Trung tâm</a>
                            <span class="text-[#61896f] dark:text-zinc-400 text-sm font-medium">/</span>
                            <span class="text-[#111813] dark:text-white text-sm font-bold">Nhân viên</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="p-2 text-zinc-500 hover:bg-zinc-100 rounded-full">
                            <span class="material-symbols-outlined">notifications</span>
                        </button>
                        <div class="w-8 h-8 rounded-full bg-zinc-200" data-alt="User profile avatar"></div>
                    </div>
                </div>
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <h2 class="text-[#111813] dark:text-white text-3xl font-extrabold tracking-tight"
                            id="centerTitle">Danh sách Nhân viên</h2>
                        <p class="text-[#61896f] dark:text-zinc-400 text-sm mt-1" id="centerAddress">Đang tải...</p>
                    </div>
                </div>
            </header>
            <!-- Content Body -->
            <div class="p-8 flex-1 flex flex-col gap-6">
                <!-- Tabs -->
                <div class="flex gap-8 border-b border-zinc-200 dark:border-zinc-800">
                    <button onclick="switchTab('vaccines')"
                        class="tab-inactive py-4 text-sm font-semibold flex items-center gap-2" id="vaccinesTab">
                        <span class="material-symbols-outlined text-lg leading-none">vaccines</span>
                        Vaccine tại Trung tâm
                    </button>
                    <button onclick="switchTab('rooms')"
                        class="tab-inactive py-4 text-sm font-semibold flex items-center gap-2" id="roomsTab">
                        <span class="material-symbols-outlined text-lg leading-none">meeting_room</span>
                        Phòng khám
                    </button>
                    <button onclick="switchTab('working-hours')"
                        class="tab-inactive py-4 text-sm font-semibold flex items-center gap-2" id="workingHoursTab">
                        <span class="material-symbols-outlined text-lg leading-none">schedule</span>
                        Giờ làm việc
                    </button>
                    <button id="staffTab" class="tab-active py-4 text-sm font-bold flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg leading-none">badge</span>
                        Nhân viên
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <label
                            class="flex items-center w-full h-12 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 focus-within:ring-2 ring-primary/30 transition-all">
                            <span class="material-symbols-outlined text-[#61896f]">search</span>
                            <input
                                id="searchInput"
                                oninput="filterStaff()"
                                class="flex-1 border-none bg-transparent focus:ring-0 text-[#111813] dark:text-white placeholder:text-[#61896f] px-3 text-sm"
                                placeholder="Tìm kiếm theo tên hoặc mã nhân viên..." />
                        </label>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <select
                            id="roleFilter"
                            onchange="filterStaff()"
                            class="h-12 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 text-sm font-medium text-[#111813] dark:text-white focus:ring-primary/30 border-none outline-none">
                            <option value="">Tất cả vai trò</option>
                            <option value="DOCTOR">Bác sĩ</option>
                            <option value="NURSE">Y tá</option>
                            <option value="RECEPTIONIST">Lễ tân</option>
                        </select>
                        <button onclick="goToAddStaff()"
                            class="flex items-center gap-2 px-5 py-2.5 bg-primary text-[#111813] font-bold rounded-xl hover:shadow-lg hover:shadow-primary/20 transition-all">
                            <span class="material-symbols-outlined text-lg">person_add</span>
                            Thêm nhân viên
                        </button>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div
                            class="bg-white dark:bg-white/5 p-6 rounded-2xl border border-[#f0f4f2] dark:border-white/10 shadow-sm flex items-center gap-4">
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-blue-600">
                                <span class="material-symbols-outlined text-3xl">group</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-[#61896f] uppercase tracking-wider">Tổng số nhân viên
                                </p>
                                <h3 class="text-2xl font-black" id="totalStaffCount">0</h3>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-white/5 p-6 rounded-2xl border border-[#f0f4f2] dark:border-white/10 shadow-sm flex items-center gap-4">
                            <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-xl text-green-600">
                                <span class="material-symbols-outlined text-3xl">check_circle</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-[#61896f] uppercase tracking-wider">Đang làm việc</p>
                                <h3 class="text-2xl font-black" id="activeStaffCount">0</h3>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-white/5 p-6 rounded-2xl border border-[#f0f4f2] dark:border-white/10 shadow-sm flex items-center gap-4">
                            <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-xl text-amber-600">
                                <span class="material-symbols-outlined text-3xl">pause_circle</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-[#61896f] uppercase tracking-wider">Tạm nghỉ</p>
                                <h3 class="text-2xl font-black" id="onLeaveStaffCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-2xl overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="bg-zinc-50 dark:bg-zinc-800/50 border-b border-zinc-200 dark:border-zinc-800">
                                    <th class="px-6 py-4 text-xs font-bold text-zinc-500 uppercase tracking-wider">Nhân
                                        viên</th>
                                    <th class="px-6 py-4 text-xs font-bold text-zinc-500 uppercase tracking-wider">Vai
                                        trò</th>
                                    <th class="px-6 py-4 text-xs font-bold text-zinc-500 uppercase tracking-wider">Số
                                        điện thoại</th>
                                    <th class="px-6 py-4 text-xs font-bold text-zinc-500 uppercase tracking-wider">Trạng
                                        thái</th>
                                    <th
                                        class="px-6 py-4 text-xs font-bold text-zinc-500 uppercase tracking-wider text-right">
                                        Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody" class="divide-y divide-zinc-200 dark:divide-zinc-800">
                                <!-- Staff data will be loaded here -->
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-zinc-500">
                                        <div class="flex flex-col items-center gap-2">
                                            <span
                                                class="material-symbols-outlined animate-spin text-primary">progress_activity</span>
                                            <span>Đang tải danh sách nhân viên...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div
                            class="bg-zinc-50 dark:bg-zinc-800/30 px-6 py-4 flex items-center justify-between border-t border-zinc-200 dark:border-zinc-800">
                            <p class="text-sm text-zinc-500">Hiển thị <span
                                    class="font-bold text-zinc-700 dark:text-zinc-300" id="paginationRange">0-0</span> trên <span
                                    class="font-bold text-zinc-700 dark:text-zinc-300" id="paginationTotal">0</span> nhân viên</p>
                            <div class="flex gap-2" id="paginationControls">
                                <!-- Pagination sẽ được render bởi JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Lấy centerId từ URL - hỗ trợ cả /admin/centers/{id}/staff và /centers/{id}
        const centerIdFromPath = window.location.pathname.match(/\/(?:admin\/)?centers\/(\d+)/);
        const centerId = centerIdFromPath ? centerIdFromPath[1] : null;
        
        // Debug: log centerId để kiểm tra
        console.log('Center ID from URL:', centerId);
        console.log('Current pathname:', window.location.pathname);

        let centerData = null;
        let staffList = [];
        let filteredStaffList = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Load thông tin trung tâm
        async function loadCenterData() {
            if (!centerId) return;
            try {
                const response = await fetch(`/api/admin/centers/${centerId}`);
                if (response.ok) {
                    centerData = await response.json();
                    updateCenterHeader();
                    loadStaffStats(); // Load thống kê trước
                    loadStaffData(); // Tải danh sách nhân viên sau khi có data trung tâm
                }
            } catch (error) {
                console.error("Error loading center data:", error);
            }
        }

        // Load thống kê nhân viên
        async function loadStaffStats() {
            if (!centerId) return;
            try {
                const url = `/api/admin/centers/${centerId}/staff/stats`;
                console.log('Fetching staff stats from:', url);
                const response = await fetch(url);
                if (response.ok) {
                    const stats = await response.json();
                    console.log('Staff stats loaded:', stats);
                    updateStaffStats(stats);
                } else {
                    console.error('Error loading stats:', response.status);
                }
            } catch (error) {
                console.error("Error loading staff stats:", error);
            }
        }

        // Cập nhật thống kê nhân viên
        function updateStaffStats(stats) {
            const totalElement = document.getElementById('totalStaffCount');
            const activeElement = document.getElementById('activeStaffCount');
            const onLeaveElement = document.getElementById('onLeaveStaffCount');
            
            if (totalElement) totalElement.textContent = stats.totalStaff || 0;
            if (activeElement) activeElement.textContent = stats.activeStaff || 0;
            if (onLeaveElement) onLeaveElement.textContent = stats.onLeave || 0;
        }

        // Load danh sách nhân viên
        async function loadStaffData() {
            if (!centerId) {
                console.error('Center ID is null');
                return;
            }
            const tableBody = document.getElementById('staffTableBody');
            try {
                const url = `/api/admin/centers/${centerId}/staff`;
                console.log('Fetching staff data from:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    staffList = await response.json();
                    console.log('Staff list loaded:', staffList);
                    filterStaff(); // Áp dụng filter sau khi load
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500 font-medium">Lỗi khi tải dữ liệu: ${response.status}</td></tr>`;
                }
            } catch (error) {
                console.error("Error loading staff data:", error);
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500 font-medium">Lỗi kết nối server: ${error.message}</td></tr>`;
            }
        }

        // Lọc nhân viên
        function filterStaff() {
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');
            
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const selectedRole = roleFilter?.value || '';

            filteredStaffList = staffList.filter(staff => {
                // Lọc theo tên hoặc mã nhân viên
                const matchesSearch = !searchTerm || 
                    (staff.fullName && staff.fullName.toLowerCase().includes(searchTerm)) ||
                    (staff.employeeId && staff.employeeId.toLowerCase().includes(searchTerm));
                
                // Lọc theo vai trò
                const matchesRole = !selectedRole || staff.role === selectedRole;

                return matchesSearch && matchesRole;
            });

            currentPage = 1; // Reset về trang đầu khi filter
            renderStaffTable(filteredStaffList);
            updatePagination();
        }

        function renderStaffTable(staff) {
            const tableBody = document.getElementById('staffTableBody');
            if (!staff || staff.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-zinc-500 font-medium">Chưa có nhân viên nào tại trung tâm này</td></tr>`;
                updatePagination();
                return;
            }

            // Tính toán phân trang
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStaff = staff.slice(startIndex, endIndex);

            tableBody.innerHTML = paginatedStaff.map(member => `
        <tr class="hover:bg-zinc-50 dark:hover:bg-zinc-800/40 transition-colors">
            <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                    <div class="size-10 rounded-full bg-zinc-100 flex-shrink-0 flex items-center justify-center">
                        <span class="material-symbols-outlined text-zinc-400">person</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-[#111813] dark:text-white">${member.fullName || 'N/A'}</span>
                        <span class="text-[10px] font-bold text-zinc-400 uppercase tracking-tighter">${member.employeeId || 'N/A'}</span>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined ${getRoleColor(member.role)} text-lg">${getRoleIcon(member.role)}</span>
                    <span class="text-sm font-medium text-[#111813] dark:text-zinc-300">${getRoleLabels(member.role)}</span>
                </div>
            </td>
            <td class="px-6 py-4 text-sm text-[#61896f] dark:text-zinc-400">${member.phoneNumber || 'N/A'}</td>
            <td class="px-6 py-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${member.status === 'ACTIVE' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-zinc-100 text-zinc-600 border-zinc-200'} border">
                    ${member.status === 'ACTIVE' ? 'Đang làm việc' : (member.status === 'LOCKED' ? 'Tạm khóa' : 'Tạm nghỉ')}
                </span>
            </td>
            <td class="px-6 py-4 text-right">
                <div class="flex justify-end gap-2">
                    <button onclick="editStaff(${member.id})" class="p-2 text-zinc-400 hover:text-primary hover:bg-primary/10 rounded-lg transition-all">
                        <span class="material-symbols-outlined text-xl">edit</span>
                    </button>
                    <button onclick="deleteStaff(${member.id}, '${member.fullName || 'N/A'}')" class="p-2 text-zinc-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all">
                        <span class="material-symbols-outlined text-xl">delete</span>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
        }

        // Cập nhật phân trang
        function updatePagination() {
            const totalItems = filteredStaffList.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, totalItems);

            // Cập nhật text phân trang
            const rangeElement = document.getElementById('paginationRange');
            const totalElement = document.getElementById('paginationTotal');
            if (rangeElement) {
                rangeElement.textContent = totalItems > 0 ? `${startIndex}-${endIndex}` : '0-0';
            }
            if (totalElement) {
                totalElement.textContent = totalItems;
            }

            // Render nút phân trang
            const paginationControls = document.getElementById('paginationControls');
            if (!paginationControls) return;

            let paginationHTML = '';

            // Nút Previous
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled' : ''}
                    class="flex items-center justify-center size-8 rounded border border-zinc-300 dark:border-zinc-700 ${currentPage === 1 ? 'text-zinc-300 cursor-not-allowed' : 'text-zinc-400 hover:bg-white'} transition-colors">
                    <span class="material-symbols-outlined text-sm font-bold">chevron_left</span>
                </button>
            `;

            // Nút số trang
            for (let i = 1; i <= totalPages; i++) {
                if (totalPages <= 7 || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button onclick="changePage(${i})" 
                            class="flex items-center justify-center size-8 rounded ${i === currentPage ? 'border-none bg-primary text-black font-bold' : 'border border-zinc-300 dark:border-zinc-700 text-zinc-600 hover:bg-white'} transition-colors text-sm">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="px-2 text-zinc-400">...</span>`;
                }
            }

            // Nút Next
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled' : ''}
                    class="flex items-center justify-center size-8 rounded border border-zinc-300 dark:border-zinc-700 ${currentPage === totalPages ? 'text-zinc-300 cursor-not-allowed' : 'text-zinc-400 hover:bg-white'} transition-colors">
                    <span class="material-symbols-outlined text-sm font-bold">chevron_right</span>
                </button>
            `;

            paginationControls.innerHTML = paginationHTML;
        }

        // Thay đổi trang
        function changePage(page) {
            const totalPages = Math.ceil(filteredStaffList.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderStaffTable(filteredStaffList);
            updatePagination();
        }

        function getRoleIcon(role) {
            if (role === 'DOCTOR') return 'stethoscope';
            if (role === 'NURSE') return 'medical_services';
            if (role === 'RECEPTIONIST') return 'support_agent';
            return 'person';
        }

        function getRoleColor(role) {
            if (role === 'DOCTOR') return 'text-blue-500';
            if (role === 'NURSE') return 'text-primary';
            if (role === 'RECEPTIONIST') return 'text-orange-500';
            return 'text-zinc-500';
        }

        function getRoleLabels(role) {
            if (role === 'DOCTOR') return 'Bác sĩ';
            if (role === 'NURSE') return 'Y tá';
            if (role === 'RECEPTIONIST') return 'Lễ tân';
            return role;
        }

        function updateCenterHeader() {
            if (!centerData) return;

            const titleElement = document.getElementById('centerTitle');
            const addressElement = document.getElementById('centerAddress');

            if (titleElement) {
                titleElement.textContent = `Danh sách Nhân viên - ${centerData.name || 'N/A'}`;
            }

            if (addressElement) {
                addressElement.textContent = centerData.address || 'N/A';
            }
        }

        // Chuyển tab
        function switchTab(tab) {
            if (!centerId) return;

            if (tab === 'vaccines') {
                window.location.href = `/admin/centers/${centerId}/vaccines`;
            } else if (tab === 'rooms') {
                window.location.href = `/admin/centers/${centerId}/rooms`;
            } else if (tab === 'working-hours') {
                window.location.href = `/admin/centers/${centerId}/working-hours`;
            }
            // Nếu tab là 'staff', giữ nguyên trang hiện tại
        }

        // Đóng cửa sổ và quay lại trang danh sách
        function closeCenterDetail() {
            window.location.href = '/admin/centers';
        }

        // Điều hướng đến trang thêm nhân viên
        function goToAddStaff() {
            if (!centerId) return;
            window.location.href = `/admin/centers/${centerId}/staff/new`;
        }

        // Xóa nhân viên
        async function deleteStaff(userId, staffName) {
            if (!confirm(`Bạn có chắc chắn muốn xóa nhân viên "${staffName}"?\n\nLưu ý: Hành động này không thể hoàn tác.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Xóa nhân viên thành công!');
                    // Reload danh sách nhân viên
                    loadStaffData();
                    loadStaffStats();
                } else {
                    const error = await response.json();
                    alert('Lỗi: ' + (error.error || 'Không thể xóa nhân viên'));
                }
            } catch (error) {
                console.error('Error deleting staff:', error);
                alert('Có lỗi xảy ra khi xóa nhân viên');
            }
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', () => {
            loadCenterData();
        });
    </script>

</body>

</html>