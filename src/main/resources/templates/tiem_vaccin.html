<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" class="light" lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Thực hiện Tiêm chủng - Điều dưỡng</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0f766e",
                        "primary-dark": "#134e4a",
                        "primary-light": "#14b8a6",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102216",
                        "surface-dark": "#1a2e20",
                        "border-light": "#dbe6df",
                        "border-dark": "#2a3f31",
                    },
                    fontFamily: {
                        "display": ["Manrope"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .fill-icon {
            font-variation-settings: 'FILL' 1;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #dbe6df;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#111813] dark:text-white">
    <div class="flex min-h-screen">
        <!-- Sidebar Overlay (mobile) -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div>
        <!-- Sidebar Fragment -->
        <div th:replace="~{fragments/nurse-sidebar :: sidebar}"></div>
        <main class="flex-1 lg:ml-72 flex flex-col overflow-hidden">
            <header
                class="bg-white dark:bg-surface-dark border-b border-border-light dark:border-border-dark px-8 py-5">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <button id="sidebarToggleBtn"
                            class="lg:hidden p-2 rounded-lg hover:bg-[#f0f4f2] dark:hover:bg-[#2d3f33] transition-colors">
                            <span class="material-symbols-outlined">menu</span>
                        </button>
                        <h1 class="text-2xl font-bold">Ghi nhận Tiêm chủng</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col items-end">
                            <span class="text-xs text-[#61896f] font-medium">Thời gian hiện tại</span>
                            <span id="currentDateTime" class="text-sm font-bold"></span>
                        </div>
                        <div class="h-8 w-[1px] bg-border-light dark:border-border-dark mx-2"></div>
                        <button onclick="window.location.href='/nurse/dashboard'"
                            class="bg-background-light dark:bg-background-dark p-2 rounded-lg text-[#61896f] hover:bg-gray-100 transition-colors"
                            title="Quay lại">
                            <span class="material-symbols-outlined">arrow_back</span>
                        </button>
                    </div>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                <div class="max-w-6xl mx-auto grid grid-cols-12 gap-6">
                    <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
                        <div
                            class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-border-light dark:border-border-dark shadow-sm">
                            <h3
                                class="text-sm font-bold text-[#61896f] uppercase tracking-wider mb-5 flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">person</span>
                                Thông tin bệnh nhân
                            </h3>
                            <div class="flex flex-col items-center text-center">
                                <div
                                    class="size-24 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 mb-4 ring-4 ring-primary/10 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-5xl text-primary">person</span>
                                </div>
                                <h4 id="patientName" class="text-xl font-extrabold text-[#111813] dark:text-white">-
                                </h4>
                                <p id="patientCode" class="text-primary font-bold text-sm">Mã BN: -</p>
                                <div
                                    class="grid grid-cols-2 w-full mt-6 gap-4 border-t border-border-light dark:border-border-dark pt-6">
                                    <div class="text-left">
                                        <p class="text-[10px] uppercase font-bold text-[#61896f]">Tuổi</p>
                                        <p id="patientAge" class="text-sm font-bold">-</p>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-[10px] uppercase font-bold text-[#61896f]">Giới tính</p>
                                        <p id="patientGender" class="text-sm font-bold">-</p>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-[10px] uppercase font-bold text-[#61896f]">Số điện thoại</p>
                                        <p id="patientPhone" class="text-sm font-bold">-</p>
                                    </div>
                                    <div class="text-left">
                                        <p class="text-[10px] uppercase font-bold text-[#61896f]">Địa chỉ</p>
                                        <p id="patientAddress" class="text-sm font-bold">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-border-light dark:border-border-dark shadow-sm">
                            <div class="flex justify-between items-start mb-5">
                                <h3
                                    class="text-sm font-bold text-[#61896f] uppercase tracking-wider flex items-center gap-2">
                                    <span class="material-symbols-outlined text-lg">stethoscope</span>
                                    Kết quả sàng lọc
                                </h3>
                                <span id="screeningStatus"
                                    class="bg-primary/20 text-primary-dark dark:text-primary px-3 py-1 rounded-full text-[10px] font-black tracking-widest border border-primary/30">-</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-6">
                                <div
                                    class="bg-background-light dark:bg-background-dark p-3 rounded-xl border border-border-light dark:border-border-dark text-center">
                                    <p class="text-[10px] font-bold text-[#61896f] mb-1">Nhiệt độ</p>
                                    <p id="screeningTemperature"
                                        class="text-lg font-extrabold text-[#111813] dark:text-white">-</p>
                                </div>
                                <div
                                    class="bg-background-light dark:bg-background-dark p-3 rounded-xl border border-border-light dark:border-border-dark text-center">
                                    <p class="text-[10px] font-bold text-[#61896f] mb-1">Huyết áp</p>
                                    <p id="screeningBloodPressure"
                                        class="text-lg font-extrabold text-[#111813] dark:text-white">-</p>
                                </div>
                                <div
                                    class="bg-background-light dark:bg-background-dark p-3 rounded-xl border border-border-light dark:border-border-dark text-center">
                                    <p class="text-[10px] font-bold text-[#61896f] mb-1">Nhịp tim</p>
                                    <p id="screeningHeartRate"
                                        class="text-lg font-extrabold text-[#111813] dark:text-white">-</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-[#61896f] mb-1 block">Bác sĩ chỉ
                                        định</label>
                                    <p id="screeningDoctor"
                                        class="text-sm font-bold text-[#111813] dark:text-white flex items-center gap-2">
                                        <span class="material-symbols-outlined text-sm">account_circle</span>
                                        -
                                    </p>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-[#61896f] mb-1 block">Ghi chú
                                        &amp; Chỉ định</label>
                                    <div
                                        class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 p-3 rounded-lg">
                                        <p id="screeningNotes"
                                            class="text-sm text-blue-800 dark:text-blue-300 italic leading-relaxed">
                                            -
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-span-12 lg:col-span-8">
                        <div
                            class="bg-white dark:bg-surface-dark p-8 rounded-2xl border border-border-light dark:border-border-dark shadow-sm h-full">
                            <h3
                                class="text-lg font-extrabold text-[#111813] dark:text-white mb-8 flex items-center gap-3">
                                <span class="material-symbols-outlined text-primary text-3xl">syringe</span>
                                Phiếu thực hiện tiêm chủng
                            </h3>
                            <form id="injectionForm" class="space-y-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div class="space-y-2">
                                        <label class="text-sm font-bold text-[#111813] dark:text-white">Số lô Vaccine
                                            (Batch Number) <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <span
                                                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#61896f] pointer-events-none">barcode_scanner</span>
                                            <select id="vaccineLotInput"
                                                onchange="document.getElementById('vaccineLotHint').textContent = this.value ? 'Đã chọn lô: ' + this.value : 'Chọn lô vaccine có sẵn'"
                                                class="w-full pl-12 pr-4 py-3 bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all font-semibold appearance-none cursor-pointer"
                                                required>
                                                <option value="">-- Chọn lô vaccine --</option>
                                            </select>
                                            <span
                                                class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-[#61896f] pointer-events-none">expand_more</span>
                                        </div>
                                        <p id="vaccineLotHint" class="text-[10px] text-[#61896f]">Chọn lô vaccine có sẵn
                                        </p>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-bold text-[#111813] dark:text-white">Vị trí tiêm
                                            <span class="text-red-500">*</span></label>
                                        <div class="grid grid-cols-2 gap-3">
                                            <label class="relative cursor-pointer group">
                                                <input checked="" class="peer hidden" name="injectionSite" type="radio"
                                                    value="LEFT_ARM" />
                                                <div
                                                    class="p-3 border-2 border-border-light dark:border-border-dark rounded-xl text-center font-bold text-sm text-[#61896f] peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary transition-all">
                                                    Bắp tay trái
                                                </div>
                                            </label>
                                            <label class="relative cursor-pointer group">
                                                <input class="peer hidden" name="injectionSite" type="radio"
                                                    value="RIGHT_ARM" />
                                                <div
                                                    class="p-3 border-2 border-border-light dark:border-border-dark rounded-xl text-center font-bold text-sm text-[#61896f] peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary transition-all">
                                                    Bắp tay phải
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-4 pt-6 border-t border-border-light dark:border-border-dark">
                                    <label class="text-sm font-bold text-[#111813] dark:text-white">Ghi chú phản ứng sau
                                        tiêm (30 phút theo dõi)</label>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <label
                                            class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl border border-border-light dark:border-border-dark cursor-pointer hover:border-primary/50 transition-colors">
                                            <input class="rounded text-primary focus:ring-primary size-5"
                                                type="checkbox" name="reaction" value="NORMAL" checked />
                                            <span class="text-sm font-medium">Bình thường</span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl border border-border-light dark:border-border-dark cursor-pointer hover:border-primary/50 transition-colors">
                                            <input class="rounded text-primary focus:ring-primary size-5"
                                                type="checkbox" name="reaction" value="SWELLING" />
                                            <span class="text-sm font-medium">Sưng đỏ</span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl border border-border-light dark:border-border-dark cursor-pointer hover:border-primary/50 transition-colors">
                                            <input class="rounded text-primary focus:ring-primary size-5"
                                                type="checkbox" name="reaction" value="FEVER" />
                                            <span class="text-sm font-medium">Sốt nhẹ</span>
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-3 bg-background-light dark:bg-background-dark rounded-xl border border-border-light dark:border-border-dark cursor-pointer hover:border-primary/50 transition-colors">
                                            <input class="rounded text-primary focus:ring-primary size-5"
                                                type="checkbox" name="reaction" value="DIZZY" />
                                            <span class="text-sm font-medium">Chóng mặt</span>
                                        </label>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-bold text-[#61896f]">Ghi chú chi tiết khác</label>
                                        <textarea id="observationNotes"
                                            class="w-full px-4 py-3 bg-background-light dark:bg-background-dark border-border-light dark:border-border-dark rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all text-sm"
                                            placeholder="Nhập các quan sát khác về tình trạng bệnh nhân sau tiêm..."
                                            rows="4"></textarea>
                                    </div>
                                </div>

                                <div
                                    class="pt-10 flex flex-col md:flex-row items-center justify-between gap-6 border-t border-border-light dark:border-border-dark mt-10">
                                    <div
                                        class="flex items-center gap-3 text-orange-600 bg-orange-50 dark:bg-orange-900/20 px-4 py-3 rounded-xl border border-orange-100 dark:border-orange-800/50">
                                        <span class="material-symbols-outlined text-lg">info</span>
                                        <p class="text-xs font-bold leading-tight">Lưu ý: Chỉ xác nhận khi đã thực hiện
                                            xong kỹ thuật tiêm vaccine</p>
                                    </div>
                                    <div class="flex items-center gap-4 w-full md:w-auto">
                                        <button onclick="window.location.href='/nurse/dashboard'"
                                            class="px-8 py-3 bg-white dark:bg-background-dark border border-border-light dark:border-border-dark text-[#61896f] font-bold rounded-xl hover:bg-gray-50 transition-all shadow-sm"
                                            type="button">
                                            Hủy bỏ
                                        </button>
                                        <button id="confirmInjectionBtn"
                                            class="px-10 py-3 bg-primary hover:bg-primary-dark text-white font-bold rounded-xl shadow-lg shadow-primary/25 transition-all flex items-center justify-center gap-2 group"
                                            type="submit">
                                            <span>Xác nhận hoàn thành</span>
                                            <span
                                                class="material-symbols-outlined fill-icon text-xl group-hover:translate-x-1 transition-transform">task_alt</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="max-w-6xl mx-auto mt-10 mb-20 text-center">
                    <p class="text-[#61896f] text-xs">
                        Phiên bản phần mềm v2.4.0 • Trợ giúp: 1900 1234 • Hệ thống được đồng bộ hóa thời gian thực với
                        cơ sở dữ liệu quốc gia.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
            /*<![CDATA[*/
            (function () {
                let appointmentData = null;
                const appointmentId = /*[[${appointmentId}]]*/ null;

                // Update current date/time
                function updateDateTime() {
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('vi-VN');
                    const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const dateTimeEl = document.getElementById('currentDateTime');
                    if (dateTimeEl) {
                        dateTimeEl.textContent = `${timeStr} - ${dateStr}`;
                    }
                }
                updateDateTime();
                setInterval(updateDateTime, 60000); // Update every minute

                // Load appointment data
                async function loadAppointmentData() {
                    if (!appointmentId) {
                        alert('Không tìm thấy ID lịch hẹn');
                        window.location.href = '/nurse/dashboard';
                        return;
                    }

                    try {
                        const response = await fetch(`/api/nurse/appointments/${appointmentId}/injection`, {
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error || 'Failed to load appointment data');
                        }

                        appointmentData = await response.json();
                        console.log('=== DEBUG: Appointment Data ===');
                        console.log('Full response:', appointmentData);
                        console.log('Available vaccine lots:', appointmentData.availableVaccineLots);
                        console.log('Vaccine ID:', appointmentData.vaccineInfo?.id);
                        console.log('Vaccine Name:', appointmentData.vaccineInfo?.name);
                        console.log('Center ID:', appointmentData.centerInfo?.id);
                        console.log('Center Name:', appointmentData.centerInfo?.name);
                        renderAppointmentData();
                    } catch (error) {
                        console.error('Error loading appointment data:', error);
                        alert('Lỗi: ' + error.message);
                        window.location.href = '/nurse/dashboard';
                    }
                }

                // Render appointment data
                function renderAppointmentData() {
                    if (!appointmentData) return;

                    // Patient info
                    const patientInfo = appointmentData.patientInfo || {};
                    document.getElementById('patientName').textContent = patientInfo.fullName || 'N/A';
                    document.getElementById('patientCode').textContent = `Mã BN: ${patientInfo.id || appointmentData.bookingCode || 'N/A'}`;

                    // Calculate age
                    if (patientInfo.dateOfBirth) {
                        const birthDate = new Date(patientInfo.dateOfBirth);
                        const today = new Date();
                        let age = today.getFullYear() - birthDate.getFullYear();
                        const monthDiff = today.getMonth() - birthDate.getMonth();
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                            age--;
                        }
                        document.getElementById('patientAge').textContent = `${age} tuổi`;
                    } else {
                        document.getElementById('patientAge').textContent = 'N/A';
                    }

                    document.getElementById('patientGender').textContent = patientInfo.gender === 'MALE' ? 'Nam' : patientInfo.gender === 'FEMALE' ? 'Nữ' : 'N/A';
                    document.getElementById('patientPhone').textContent = patientInfo.phoneNumber || 'N/A';
                    document.getElementById('patientAddress').textContent = patientInfo.address || 'N/A';

                    // Screening info
                    const screening = appointmentData.screening;
                    if (screening) {
                        document.getElementById('screeningStatus').textContent = screening.screeningResult || 'N/A';
                        if (screening.screeningResult === 'APPROVED') {
                            document.getElementById('screeningStatus').className = 'bg-primary/20 text-primary-dark dark:text-primary px-3 py-1 rounded-full text-[10px] font-black tracking-widest border border-primary/30';
                        } else {
                            document.getElementById('screeningStatus').className = 'bg-red-500/20 text-red-600 dark:text-red-400 px-3 py-1 rounded-full text-[10px] font-black tracking-widest border border-red-500/30';
                        }
                        document.getElementById('screeningTemperature').textContent = screening.temperature ? `${screening.temperature}°C` : 'N/A';
                        document.getElementById('screeningBloodPressure').textContent = screening.bloodPressure || 'N/A';
                        document.getElementById('screeningHeartRate').textContent = screening.heartRate ? `${screening.heartRate} bpm` : 'N/A';
                        document.getElementById('screeningDoctor').innerHTML = `<span class="material-symbols-outlined text-sm">account_circle</span>${screening.doctorName || 'N/A'}`;
                        document.getElementById('screeningNotes').textContent = screening.notes || 'Không có ghi chú';
                    } else {
                        document.getElementById('screeningStatus').textContent = 'CHƯA SÀNG LỌC';
                        document.getElementById('screeningStatus').className = 'bg-yellow-500/20 text-yellow-600 dark:text-yellow-400 px-3 py-1 rounded-full text-[10px] font-black tracking-widest border border-yellow-500/30';
                        document.getElementById('screeningTemperature').textContent = 'N/A';
                        document.getElementById('screeningBloodPressure').textContent = 'N/A';
                        document.getElementById('screeningHeartRate').textContent = 'N/A';
                        document.getElementById('screeningDoctor').innerHTML = '<span class="material-symbols-outlined text-sm">account_circle</span>Chưa có';
                        document.getElementById('screeningNotes').textContent = 'Chưa có kết quả sàng lọc';
                    }

                    // Vaccine lots - Populate dropdown with available lots
                    window.availableVaccineLots = appointmentData.availableVaccineLots || [];
                    const lotSelect = document.getElementById('vaccineLotInput');
                    const lotHint = document.getElementById('vaccineLotHint');

                    if (lotSelect) {
                        // Clear existing options except first one
                        lotSelect.innerHTML = '<option value="">-- Chọn lô vaccine --</option>';

                        if (window.availableVaccineLots.length > 0) {
                            lotSelect.disabled = false;

                            // Add options for each available lot
                            window.availableVaccineLots.forEach(lot => {
                                const option = document.createElement('option');
                                option.value = lot.lotNumber;
                                const expiredText = lot.isExpired ? ' (HẾT HẠN)' : '';
                                option.textContent = `${lot.lotNumber} (Còn: ${lot.remainingQuantity} liều, HSD: ${lot.expiryDate})${expiredText}`;
                                if (lot.isExpired) option.classList.add('text-red-500');
                                lotSelect.appendChild(option);
                            });

                            // Auto-select first lot if only one available
                            if (window.availableVaccineLots.length === 1) {
                                lotSelect.value = window.availableVaccineLots[0].lotNumber;
                                lotSelect.dispatchEvent(new Event('change'));
                            }

                            lotHint.textContent = `Có ${window.availableVaccineLots.length} lô vaccine khả dụng`;
                            lotHint.className = "text-[10px] text-primary-dark dark:text-primary font-bold";
                        } else {
                            lotHint.textContent = 'Trống: Không tìm thấy lô vaccine nào cho loại này';
                            lotHint.className = "text-[10px] text-red-500 font-bold";
                            lotSelect.disabled = true;
                        }
                    }
                }

                // Handle form submit
                const injectionForm = document.getElementById('injectionForm');
                if (injectionForm) {
                    injectionForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const vaccineLotNumber = document.getElementById('vaccineLotInput').value.trim();
                        // Get injection site and other notes
                        const injectionSite = document.querySelector('input[name="injectionSite"]:checked').value;
                        const observationNotes = document.getElementById('observationNotes').value;

                        // Collect selected reactions (for future use or logging)
                        const selectedReactions = Array.from(document.querySelectorAll('input[name="reaction"]:checked'))
                            .map(cb => cb.parentNode.querySelector('span').innerText);

                        if (!vaccineLotNumber) {
                            alert('Vui lòng nhập số lô vaccine');
                            return;
                        }

                        if (!injectionSite) {
                            alert('Vui lòng chọn vị trí tiêm');
                            return;
                        }

                        const confirmBtn = document.getElementById('confirmInjectionBtn');
                        confirmBtn.disabled = true;
                        confirmBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">sync</span><span>Đang xử lý...</span>';

                        try {
                            // Get vaccine lot by lot number
                            const lotResponse = await fetch(`/api/vaccine-lots/lot-number/${encodeURIComponent(vaccineLotNumber)}`, {
                                credentials: 'include'
                            });

                            if (!lotResponse.ok) {
                                const error = await lotResponse.json();
                                throw new Error(error.error || 'Không tìm thấy số lô vaccine này');
                            }

                            const vaccineLot = await lotResponse.json();

                            // Validate vaccine lot
                            if (vaccineLot.remainingQuantity == null || vaccineLot.remainingQuantity <= 0) {
                                throw new Error('Lô vaccine này đã hết hàng');
                            }

                            if (vaccineLot.status !== 'AVAILABLE') {
                                throw new Error('Lô vaccine này không khả dụng');
                            }

                            // Get current user (nurse) ID
                            const userResponse = await fetch('/api/users/profile', {
                                credentials: 'include'
                            });
                            if (!userResponse.ok) {
                                throw new Error('Failed to get current user');
                            }
                            const userData = await userResponse.json();
                            const nurseId = userData.id;

                            // Create vaccination record
                            const requestBody = {
                                appointmentId: appointmentId,
                                vaccineLotId: vaccineLot.id,
                                nurseId: nurseId,
                                injectionSite: injectionSite,
                                doseAmount: 0.5,
                                notes: observationNotes + (selectedReactions.length > 0 ? " | Phản ứng: " + selectedReactions.join(", ") : ""),
                                injectionDate: new Date().toISOString().split('T')[0],
                                injectionTime: new Date().toTimeString().split(' ')[0].substring(0, 5)
                            };

                            const response = await fetch('/api/vaccination-records', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify(requestBody)
                            });

                            console.log('Response status:', response.status);
                            console.log('Response ok:', response.ok);

                            // Check if response is successful (200-299)
                            if (response.status < 200 || response.status >= 300) {
                                let errorMessage = 'Failed to create vaccination record';
                                try {
                                    const responseText = await response.text();
                                    console.error('Error response text:', responseText);
                                    try {
                                        const error = JSON.parse(responseText);
                                        errorMessage = error.error || errorMessage;
                                    } catch (parseError) {
                                        errorMessage = `HTTP ${response.status}: ${responseText.substring(0, 200)}`;
                                    }
                                } catch (e) {
                                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                                }
                                throw new Error(errorMessage);
                            }

                            let result;
                            try {
                                const responseText = await response.text();
                                console.log('Response text:', responseText);
                                result = JSON.parse(responseText);
                                console.log('Vaccination record created:', result);
                            } catch (e) {
                                console.error('Error parsing response JSON:', e);
                                console.error('Response might not be valid JSON');
                                throw new Error('Lỗi xử lý phản hồi từ server. Vui lòng kiểm tra console để biết chi tiết.');
                            }

                            // Hiển thị thông báo thành công với thông tin chi tiết
                            alert("Đã tiêm thành công!");

                            // Thêm delay nhỏ để đảm bảo database transaction đã commit
                            // và thêm cache-busting parameter để force refresh
                            setTimeout(() => {
                                window.location.href = '/nurse/lich-su-tiem-y-ta?refresh=' + Date.now();
                            }, 500);
                        } catch (error) {
                            console.error('Error creating vaccination record:', error);
                            alert('Lỗi: ' + error.message);
                            confirmBtn.disabled = false;
                            confirmBtn.innerHTML = '<span>Xác nhận hoàn thành tiêm</span><span class="material-symbols-outlined fill-icon text-lg">task_alt</span>';
                        }
                    });
                }

                // Load data on page load
                document.addEventListener('DOMContentLoaded', function () {
                    loadAppointmentData();
                });
            })();
        /*]]>*/
    </script>

</body>

</html>